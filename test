<?php

class NetworkAvailabilityController extends Controller
{
	public function filters()
	{
		return array(
			// 'setCreds',
			'accessSimpleCheck',
		);
	}
	
	public function actionIndex()
	{
		// $this->show = true;
		$ro_wise = false;
		if( isset($_GET["ro_wise"]) )
		{
			if ( intval($_GET["ro_wise"]) == 1 )
			{
				$ro_wise = true;
			}
		}

		if( $ro_wise )
			$this->bottom_caption = "Regional Offices View";
		else
			$this->bottom_caption = "Zonal Offices View";

		$this->reload_available = true;
	    $this->reload_enable = true;
	    $this->reload_time = 1;
	    $this->reload_name = "Reload RAN Dashboard";

	    $user=User::model()->with(array('userDomains'))->findByPk(Yii::app()->user->id);

		if($user===null)
			throw new CHttpException(403,'Forbidden');

		$ran_domain_id = Yii::app()->params["ran_domain_id"];

		$ran_access = false;
		foreach ($user->userDomains as $dm_assign)
		{
			if( $dm_assign->domain_filter_id == $ran_domain_id )
			{
				$ran_access = true;
				break;
			}
		}

		if(!$ran_access)
			throw new CHttpException(403,'You donot have Access to Perform this Action.');

	    if( $user->user_reload_settings != null )
		{
			$user_reload_setting = @json_decode($user->user_reload_settings, true);

			if( isset($user_reload_setting["network_availibility"]["relaod_enable"]) && isset($user_reload_setting["network_availibility"]["relaod_time"]) )
			{
				$this->reload_enable = ($user_reload_setting["network_availibility"]["relaod_enable"])?true:false;
				$this->reload_time = intval($user_reload_setting["network_availibility"]["relaod_time"]);
			}
		}

		$this->render('index',array(
			'ro_wise'=>$ro_wise
		));
	}

	public function actionUpdateUserAlarmReload()
	{
		$response = new stdClass;
		$response->success = true;
		$response->message = "";

		if( isset($_POST["relaod_enable"]) && isset($_POST["relaod_time"]) && intval($_POST["relaod_time"]) <= 5 )
		{

			$user = User::model()->findByPk(Yii::app()->user->id);

			if($user===null)
				throw new CHttpException(403,'Forbidden');

			$user_setting = array();
			if( $user->user_reload_settings == null )
			{
				$user_setting ["network_availibility"] = array();
				$user_setting ["network_availibility"]["relaod_enable"] = ($_POST["relaod_enable"]=='yes')?true:false;
				$user_setting ["network_availibility"]["relaod_time"] = intval($_POST["relaod_time"]);
			}
			else
			{
				$user_setting = @json_decode($user->user_reload_settings, true);
				$user_setting ["network_availibility"] = array();
				$user_setting ["network_availibility"]["relaod_enable"] = ($_POST["relaod_enable"]=='yes')?true:false;
				$user_setting ["network_availibility"]["relaod_time"] = intval($_POST["relaod_time"]);
			}

			$res = User::model()->updateByPk(Yii::app()->user->id, array('user_reload_settings' => json_encode($user_setting) ));

			if(!$res)
			{
				$response->success = false;
				$response->message = "Setting Update Failed!";
			}
		}
		else
		{
			$response->success = false;
			$response->message = "Invalid value supplied!";
		}

		echo json_encode($response);
		Yii::app()->end();
	}

	public function actionUpdateUserReloadOffice()
	{
		$response = new stdClass;
		$response->success = true;
		$response->message = "";

		if( isset($_POST["relaod_enable"]) && isset($_POST["relaod_time"]) && intval($_POST["relaod_time"]) <= 5 )
		{

			$user = User::model()->findByPk(Yii::app()->user->id);

			if($user===null)
				throw new CHttpException(403,'Forbidden');

			$user_setting = array();
			if( $user->user_reload_settings == null )
			{
				$user_setting ["network_availibility_ofc"] = array();
				$user_setting ["network_availibility_ofc"]["relaod_enable"] = ($_POST["relaod_enable"]=='yes')?true:false;
				$user_setting ["network_availibility_ofc"]["relaod_time"] = intval($_POST["relaod_time"]);
			}
			else
			{
				$user_setting = @json_decode($user->user_reload_settings, true);
				$user_setting ["network_availibility_ofc"] = array();
				$user_setting ["network_availibility_ofc"]["relaod_enable"] = ($_POST["relaod_enable"]=='yes')?true:false;
				$user_setting ["network_availibility_ofc"]["relaod_time"] = intval($_POST["relaod_time"]);
			}

			$res = User::model()->updateByPk(Yii::app()->user->id, array('user_reload_settings' => json_encode($user_setting) ));

			if(!$res)
			{
				$response->success = false;
				$response->message = "Setting Update Failed!";
			}
		}
		else
		{
			$response->success = false;
			$response->message = "Invalid value supplied!";
		}

		echo json_encode($response);
		Yii::app()->end();
	}

	// function get_seconds_to_time($at, $nt)
	// {
	// 	$ss = $nt - @strtotime($at);

	// 	if( $ss <= 0 )
	// 	{
	// 		return "0 seconds";
	// 	}

	// 	$s = $ss%60;
	// 	$m = floor(($ss%3600)/60);
	// 	$h = floor(($ss%86400)/3600);
	// 	$d = floor($ss/86400);

	// 	$str = "";

	// 	if( $d == 0 && $h == 0 && $m == 0 )
	// 		return "$s seconds";
	// 	else if( $d == 0 && $h == 0 )
	// 		return "$m minutes, $s seconds";
	// 	else if( $d == 0 )
	// 		return "$h hours, $m minutes, $s seconds";


	// 	return "$d days, $h hours, $m minutes, $s seconds";
	// }

	public function get_seconds_to_time($at, $nt)
	{
		$ss = $nt - @strtotime($at);

		if( $ss <= 0 )
		{
			return "0 s";
		}

		$s = $ss%60;
		$m = floor(($ss%3600)/60);
		$h = floor(($ss%86400)/3600);
		$d = floor($ss/86400);

		$str = "";

		if( $d == 0 && $h == 0 && $m == 0 )
			return "$s s";
		else if( $d == 0 && $h == 0 )
			return "$m m, $s s";
		else if( $d == 0 )
			return "$h h, $m m, $s s";


		return "$d d, $h h, $m m, $s s";
	}

	public function actionGetOutageStats()
	{
		ini_set('max_execution_time', 60); // 1 minute
		ini_set("memory_limit", "-1");

		session_write_close();

		$ro_wise = false;
		if( isset($_GET["ro_wise"]) )
		{
			if ( intval($_GET["ro_wise"]) == 1 )
			{
				$ro_wise = true;
			}
		}

		$now = time();

		$resp = new stdClass;
		$resp->success = true;
		$resp->message = "";
		$resp->data = null;

		$mem_resp = MemHelper::GetObject("network_availibility");

		if($mem_resp->success)
		{
			$site_pc_counts = $mem_resp->data->site_pc_counts;

			$site_resp = MemHelper::get_site_list();
			if($site_resp->success)
			{
				$techs_bgs = array("2g","3g","4g","ibs","power");
				$techs_cards = array("2g","3g","4g","ibs");


				$inhouse_offices = array();
				$msd_offices = array();
				$inhouse_lookup = array();
				$msd_lookup = array();
				$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
				if( $om_ofc_resp->success )
				{
					foreach ($om_ofc_resp->data as $key => $om_ofc)
					{
						if( $om_ofc->office_type_id == 1)
						{
							$inhouse_offices [] = $om_ofc->name;
							$inhouse_lookup [$om_ofc->id] = $om_ofc->name;
						}
						else if( $om_ofc->office_type_id == 2)
						{
							$msd_offices [] = $om_ofc->name;
							$msd_lookup [$om_ofc->id] = $om_ofc->name;
						}
					}
				}
				else
				{
					throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
				}

				$regions = array();
				if($ro_wise)
					$regions = array('RO-1'=>'RO-1','RO-2'=>'RO-2','RO-3'=>'RO-3','RO-4'=>'RO-4','RO-5'=>'RO-5','RO-6'=>'RO-6');
				else
					$regions = array("DHAKA"=>"DHAKA", "KHULNA"=>"KHULNA", "RAJSHAHI"=>"RAJSHAHI", "CHATTOGRAM"=>"CHATTOGRAM", "BARISHAL"=>"BARISHAL", "SYLHET"=>"SYLHET", "RANGPUR"=>"RANGPUR", "MYMENSINGH" => "MYMENSINGH");

				$priorities = array("p1","p2","p3");
				$tech_impact_regs = array("2g", "3g", "4g", "ibs", "power_macro", "power_ibs", "total");

				$data = new stdClass;
				$data->msd_site = 0;
				$data->in_house_site = 0;
				$data->total_site = 0;

				$shared_site_power = 0;
				$dg_sites_power = 0;
				$nttn_sites_power = 0;

				$data->regional_counts = array();
				$data->tech_badges = array();
				$data->tech_card_dets = array();
				$data->site_outage_det = array();
				$data->impacted_regs = array();

				$data->impacted_regs ["msd"] = array();
				$data->impacted_regs ["inhouse"] = array();

				$data->impact_regs = new stdClass;
				$data->impact_regs->msd = array();
				$data->impact_regs->inhouse = array();

				$data->impact_regs_all = new stdClass;
				$data->impact_regs_all->msd = array();
				$data->impact_regs_all->inhouse = array();

				foreach ($regions as $reg_key => $reg)
				{
					$data->regional_counts [$reg_key] = array();
					$data->regional_counts [$reg_key]["msd"] = 0;
					$data->regional_counts [$reg_key]["inhouse"] = 0;
				}

				foreach ($inhouse_offices as $inhouse_ofc)
				{
					$data->impacted_regs ["inhouse"][$inhouse_ofc] = array();

					foreach ($tech_impact_regs as $tech_impact)
					{
						$data->impacted_regs ["inhouse"][$inhouse_ofc][$tech_impact] = 0;
					}
				}

				foreach ($msd_offices as $msd_ofc)
				{
					$data->impacted_regs ["msd"][$msd_ofc] = array();

					foreach ($tech_impact_regs as $tech_impact)
					{
						$data->impacted_regs ["msd"][$msd_ofc][$tech_impact] = 0;
					}
				}				

				foreach ($techs_bgs as $tech)
				{
					$tech_bdg_det = array();
					$tech_bdg_det ["total"] = 0;
					$tech_bdg_det ["total_outage"] = 0;
					$tech_bdg_det ["msd_total"] = 0;
					$tech_bdg_det ["msd_outage"] = 0;
					$tech_bdg_det ["inhouse_total"] = 0;
					$tech_bdg_det ["inhouse_outage"] = 0;

					$data->tech_badges [$tech] = $tech_bdg_det;
				}

				foreach ($techs_cards as $tech)
				{
					$tech_card_det = array();
					$tech_card_det ["total"] = 0;
					$tech_card_det ["total_outage"] = 0;
					$tech_card_det ["total_power_outage"] = 0;

					$tech_card_det ["priority_totals"] = array();

					foreach ($priorities as $priority)
					{
						$tech_card_det ["priority_totals"][$priority] = array();
						$tech_card_det ["priority_totals"][$priority]["msd_outage"] = 0;
						$tech_card_det ["priority_totals"][$priority]["inhouse_outage"] = 0;
					}

					$tech_card_det ["reg_wise"] = array();
					foreach ($regions as $reg)
					{
						$tech_card_det ["reg_wise"][$reg] = array();
						$tech_card_det ["reg_wise"][$reg]["power_outage"] = 0;
						$tech_card_det ["reg_wise"][$reg]["total_site"] = 0;
						$tech_card_det ["reg_wise"][$reg]["all_p_outage"] = 0;
						foreach ($priorities as $priority)
						{
							$tech_card_det ["reg_wise"][$reg][$priority."_msd_outage"] = 0;
							$tech_card_det ["reg_wise"][$reg][$priority."_inhouse_outage"] = 0;
						}
					}

					$data->tech_card_dets [$tech] = $tech_card_det;
				}

				foreach ($site_resp->site_list as $sid => $site)
				{
					$site_fin_obj = new stdClass;
					$site_fin_obj->region = $site["zone"];
					$site_fin_obj->ro = $site["ro"];
					$site_fin_obj->priority = $site["site_priority"];
					$site_fin_obj->generic_id = $site["generic_id"];
					$site_fin_obj->id = $site["id"];
					$site_fin_obj->lat = $site["lat"];
					$site_fin_obj->long = $site["long"];

					$site_fin_obj->site_code_2g = $site["site_code_2g"];
					$site_fin_obj->site_code_3g = $site["site_code_3g"];
					$site_fin_obj->site_code_4g = $site["site_code_4g"];
					$site_fin_obj->thana = $site["thana"];
					$site_fin_obj->district = $site["district"];
					$site_fin_obj->address = $site["address"];


					$site_fin_obj->_power = true; // every site has power
					$site_fin_obj->_2g = false;
					$site_fin_obj->_3g = false;
					$site_fin_obj->_4g = false;
					$site_fin_obj->_ibs = false;
					
					$site_fin_obj->outage_power = false;
					$site_fin_obj->outage_2g = false;
					$site_fin_obj->outage_3g = false;
					$site_fin_obj->outage_4g = false;
					$site_fin_obj->outage_ibs = false;

					$site_fin_obj->outage_power_start = null;
					$site_fin_obj->outage_2g_start = null;
					$site_fin_obj->outage_3g_start = null;
					$site_fin_obj->outage_4g_start = null;
					$site_fin_obj->outage_ibs_start = null;

					$site_fin_obj->msd = false;
					$site_fin_obj->msd_ofc = null;
					$site_fin_obj->inhouse = false;
					$site_fin_obj->inhouse_ofc = null;

					$site_fin_obj->shared = false;
					$site_fin_obj->dg = false;
					$site_fin_obj->nttn = false;

					$site_fin_obj->p1 = false;
					$site_fin_obj->p2 = false;
					$site_fin_obj->p3 = false;

					if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
						$site_fin_obj->p1 = true;
					else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
						$site_fin_obj->p2 = true;
					else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
						$site_fin_obj->p3 = true;

					$site["om_office"] = null;
					$site["msd_office"] = null;

					if( $site["om_office_type"] == 2 )
					{
						$site_fin_obj->msd = true;
						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
						{
							$site["msd_office"] = $msd_lookup[$site["msd_office_id"]];
						}
					}
					else if ( $site["om_office_type"] == 1 )
					{
						$site_fin_obj->inhouse = true;
						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$site["om_office"] = $inhouse_lookup[$site["om_office_id"]];
						}
					}

					// Used for displaying on Marker
					if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					{
						$site_fin_obj->inhouse_ofc = $inhouse_lookup[$site["om_office_id"]];
					}
					if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
					{
						$site_fin_obj->msd_ofc = $msd_lookup[$site["msd_office_id"]];
					}

					if(isset($site["site_code_2g"]))
					{
						$site_fin_obj->_2g = true;
					}
					if(isset($site["site_code_3g"]))
					{
						$site_fin_obj->_3g = true;
					}
					if(isset($site["site_code_4g"]))
					{
						$site_fin_obj->_4g = true;
					}

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					{
					    $site_fin_obj->_ibs = false;
					}
					else
					{
						$site_fin_obj->_ibs = true;
					}

					if ($site["shared_site_code"] != null)
						$site_fin_obj->shared = true;

					if ( $site["power_status"] != null && 
						( @strpos(@strtolower($site["power_status"]), 'dg') !== false || @strpos(@strtolower($site["power_status"]), 'generator') !== false ) )
						$site_fin_obj->dg = true;

					if ( $site["mini_hub"] != null )
						$site_fin_obj->nttn = true;

					if( isset($site_pc_counts[$sid]) )
					{
						// check outage criteria
						if( sizeof($site_pc_counts[$sid]->power_alarms) > 0 )
						{
							$site_fin_obj->outage_power = true;
							if( $site_pc_counts[$sid]->power_alarms[0]["alarm_raised_time"] != null )
							{
								$site_fin_obj->outage_power_start = array(
									"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->power_alarms[0]["alarm_raised_time"], $now),
									"time"=>$site_pc_counts[$sid]->power_alarms[0]["alarm_raised_time"]
								);
							}
						}

						if($site_fin_obj->_2g)
						{
							if( sizeof($site_pc_counts[$sid]->_2g_single_pc1) > 0 )
							{
								$site_fin_obj->outage_2g = true;
								if( $site_pc_counts[$sid]->_2g_single_pc1[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_2g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_2g_single_pc1[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_2g_single_pc1[0]["alarm_raised_time"]
									);
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_2g_single_pc2) > 0 )
							{
								$site_fin_obj->outage_2g = true;
								if( $site_pc_counts[$sid]->_2g_single_pc2[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_2g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_2g_single_pc2[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_2g_single_pc2[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc4) >= $site["cell_2g"] )
							{
								$site_fin_obj->outage_2g = true;
								if( $site_pc_counts[$sid]->_2g_cell_num_pc4[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_2g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_2g_cell_num_pc4[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_2g_cell_num_pc4[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc5) >= $site["cell_2g"] )
							{
								$site_fin_obj->outage_2g = true;
								if( $site_pc_counts[$sid]->_2g_cell_num_pc5[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_2g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_2g_cell_num_pc5[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_2g_cell_num_pc5[0]["alarm_raised_time"]
									);
								}
							}
						}

						if($site_fin_obj->_3g)
						{
							if( sizeof($site_pc_counts[$sid]->_3g_single_pc1) > 0 )
							{
								$site_fin_obj->outage_3g = true;
								if( $site_pc_counts[$sid]->_3g_single_pc1[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_3g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_3g_single_pc1[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_3g_single_pc1[0]["alarm_raised_time"]
									);
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_3g_single_pc2) > 0 )
							{
								$site_fin_obj->outage_3g = true;
								if( $site_pc_counts[$sid]->_3g_single_pc2[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_3g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_3g_single_pc2[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_3g_single_pc2[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc4) >= $site["cell_3g"] )
							{
								$site_fin_obj->outage_3g = true;
								if( $site_pc_counts[$sid]->_3g_cell_num_pc4[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_3g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_3g_cell_num_pc4[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_3g_cell_num_pc4[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc5) >= $site["cell_3g"] )
							{
								$site_fin_obj->outage_3g = true;
								if( $site_pc_counts[$sid]->_3g_cell_num_pc5[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_3g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_3g_cell_num_pc5[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_3g_cell_num_pc5[0]["alarm_raised_time"]
									);
								}
							}
						}

						if($site_fin_obj->_4g)
						{
							if( sizeof($site_pc_counts[$sid]->_4g_single_pc1) > 0 )
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_single_pc1[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_single_pc1[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_single_pc1[0]["alarm_raised_time"]
									);
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_4g_single_pc2) > 0 )
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_single_pc2[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_single_pc2[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_single_pc2[0]["alarm_raised_time"]
									);
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_4g_single_pc3) > 0 )
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_single_pc3[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_single_pc3[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_single_pc3[0]["alarm_raised_time"]
									);
								}
							}
							// special condition needs to occur 2 times on a site
							else if(  sizeof($site_pc_counts[$sid]->_4g_single_pc_req_2num) >= 4 )
							{
								$mme0 = false;
								$mme1 = false;
								$mme2 = false;
								$mme3 = false;

								foreach ($site_pc_counts[$sid]->_4g_single_pc_req_2num as $slog)
								{
									if( @strpos($slog["ao"], 'LNMME-0') !== false )
										$mme0 = true;
									else if( @strpos($slog["ao"], 'LNMME-1') !== false )
										$mme1 = true;
									else if( @strpos($slog["ao"], 'LNMME-2') !== false )
										$mme2 = true;
									else if( @strpos($slog["ao"], 'LNMME-3') !== false )
										$mme3 = true;
								}

								if( $mme0 && $mme1 && $mme2 && $mme3 )
								{
									$site_fin_obj->outage_4g = true;
									if( $site_pc_counts[$sid]->_4g_single_pc_req_2num[0]["alarm_raised_time"] != null )
									{
										$site_fin_obj->outage_4g_start = array(
											"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_single_pc_req_2num[0]["alarm_raised_time"], $now),
											"time"=>$site_pc_counts[$sid]->_4g_single_pc_req_2num[0]["alarm_raised_time"]
										);
									}
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_4g_single_hybrid_pc) )
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_single_hybrid_pc[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_single_hybrid_pc[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_single_hybrid_pc[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_num_pc4) >= $site["cell_4g"])
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_cell_num_pc4[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_cell_num_pc4[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_cell_num_pc4[0]["alarm_raised_time"]
									);
								}
							}
							else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_hybrid_pc) >= $site["cell_4g"])
							{
								$site_fin_obj->outage_4g = true;
								if( $site_pc_counts[$sid]->_4g_cell_hybrid_pc[0]["alarm_raised_time"] != null )
								{
									$site_fin_obj->outage_4g_start = array(
										"duration"=>$this->get_seconds_to_time($site_pc_counts[$sid]->_4g_cell_hybrid_pc[0]["alarm_raised_time"], $now),
										"time"=>$site_pc_counts[$sid]->_4g_cell_hybrid_pc[0]["alarm_raised_time"]
									);
								}
							}
						}

						if( $site_fin_obj->_ibs )
						{
							// ibs outage check will be here.
							// ibs is a site type, so 2G outage on an ibs site will be counted as ibs outage
							if( $site_fin_obj->outage_2g )
							{
								$site_fin_obj->outage_ibs = true;
							}
						}

						$data->site_outage_det [] = $site_fin_obj;
					}

					// updating counts donut and regional counts
					$data->total_site++;
					// 3G standalone
					$special_outage=($site_fin_obj->outage_2g || ( $site_fin_obj->_3g == true && $site_fin_obj->outage_3g == true && $site_fin_obj->_2g == false ));

					if ( $site_fin_obj->shared == true && $special_outage )
						$shared_site_power += 1;

					if ( $site_fin_obj->dg == true && $special_outage )
						$dg_sites_power += 1;

					if ( $site_fin_obj->nttn == true && $special_outage )
						$nttn_sites_power += 1;

					if( $site_fin_obj->msd )
					{
						$data->msd_site++;
						if($site["msd_office"] != null)
						{
							if($ro_wise)
							{
								if ( $site["ro"] != null )
									$data->regional_counts [$site["ro"]]["msd"]++;
							}
							else
							{
								if ( $site["zone"] != null )
									$data->regional_counts [$site["zone"]]["msd"]++;
							}
							
							if($site_fin_obj->outage_2g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["2g"]++;
								$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
							}
							if($site_fin_obj->outage_3g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["3g"]++;
								$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
							}
							if($site_fin_obj->outage_4g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["4g"]++;
								$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
							}

							// if ( $site_fin_obj->outage_2g || $site_fin_obj->outage_3g || $site_fin_obj->outage_4g )
							if ( $site_fin_obj->outage_2g )
							{
								if ( $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["ibs"]++;
									$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
								}
							}

							if($site_fin_obj->outage_power)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["power_ibs"]++;
									$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
								}
								else
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["power_macro"]++;
									$data->impacted_regs ["msd"][$site["msd_office"]]["total"]++;
								}
							}

						}
					}

					if ( $site_fin_obj->inhouse )
					{
						$data->in_house_site++;
						if($site["om_office"] != null)
						{
							if($ro_wise)
							{
								if ( $site["ro"] != null )
									$data->regional_counts [$site["ro"]]["inhouse"]++;
							}
							else
							{
								if ( $site["zone"] != null )
									$data->regional_counts [$site["zone"]]["inhouse"]++;
							}

							if($site_fin_obj->outage_2g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["2g"]++;
								$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
							}
							if($site_fin_obj->outage_3g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["3g"]++;
								$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
							}
							if($site_fin_obj->outage_4g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["4g"]++;
								$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
							}

							// if ( $site_fin_obj->outage_2g || $site_fin_obj->outage_3g || $site_fin_obj->outage_4g )
							if ( $site_fin_obj->outage_2g )
							{
								if ( $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["ibs"]++;
									$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
								}
							}

							if($site_fin_obj->outage_power)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["power_ibs"]++;
									$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
								}
								else
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["power_macro"]++;
									$data->impacted_regs ["inhouse"][$site["om_office"]]["total"]++;
								}
							}

						}
					}

					// badge counts
					foreach ($data->tech_badges as $techk => $tech)
					{
						if($site_fin_obj->{"_$techk"})
						{
							$data->tech_badges[$techk]["total"]++;
							if($site_fin_obj->{"outage_$techk"})
							{
								$data->tech_badges[$techk]["total_outage"]++;
							}

							if( $site_fin_obj->msd )
							{
								$data->tech_badges[$techk]["msd_total"]++;
								if($site_fin_obj->{"outage_$techk"})
								{
									$data->tech_badges[$techk]["msd_outage"]++;
								}
							}
							if ( $site_fin_obj->inhouse )
							{
								$data->tech_badges[$techk]["inhouse_total"]++;
								if($site_fin_obj->{"outage_$techk"})
								{
									$data->tech_badges[$techk]["inhouse_outage"]++;
								}
							}
						}
					}



					// cards counts
					foreach ($data->tech_card_dets as $techk => $tech)
					{
						$site_reg_key = null;
						if($ro_wise)
							$site_reg_key = $site["ro"];
						else
							$site_reg_key = $site["zone"];

						if( $site_fin_obj->{"_$techk"} && $site_fin_obj->outage_power)
						{
							$data->tech_card_dets[$techk]["total_power_outage"]++;
							if($site_reg_key != null)
								$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["power_outage"]++;
						}

						if( $site_fin_obj->{"_$techk"} )
						{
							$data->tech_card_dets[$techk]["total"]++;

							if( $site_fin_obj->{"outage_$techk"} )
								$data->tech_card_dets[$techk]["total_outage"]++;

							if($site_reg_key != null)
								$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["total_site"]++;

							$p_ind = null;
							if($site_fin_obj->p1 && $site_fin_obj->{"outage_$techk"} )
							{
								$p_ind = "p1";
								if($site_reg_key != null)
								{
									if( $site_fin_obj->msd )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p1_msd_outage"]++;
									}
									if ( $site_fin_obj->inhouse )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p1_inhouse_outage"]++;
									}
								}
							}
							if($site_fin_obj->p2 && $site_fin_obj->{"outage_$techk"} )
							{
								$p_ind = "p2";
								if($site_reg_key != null)
								{
									if( $site_fin_obj->msd )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p2_msd_outage"]++;
									}
									if ( $site_fin_obj->inhouse )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p2_inhouse_outage"]++;
									}
								}
							}
							if($site_fin_obj->p3 && $site_fin_obj->{"outage_$techk"} )
							{
								$p_ind = "p3";
								if($site_reg_key != null)
								{
									if( $site_fin_obj->msd )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p3_msd_outage"]++;
									}
									if ( $site_fin_obj->inhouse )
									{
										$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["p3_inhouse_outage"]++;
									}
								}
							}

							if($p_ind != null)
							{
								if($site_reg_key != null)
									$data->tech_card_dets[$techk]["reg_wise"][$site_reg_key]["all_p_outage"]++;

								if( $site_fin_obj->msd )
								{
									$data->tech_card_dets[$techk]["priority_totals"][$p_ind]["msd_outage"]++;
								}
								if ( $site_fin_obj->inhouse )
								{
									$data->tech_card_dets[$techk]["priority_totals"][$p_ind]["inhouse_outage"]++;
								}
							}
						}
					}
				}

				// desc sort of msd regions by total counts
				uasort($data->impacted_regs["msd"], function($fir, $sec)
				{
					$sumFir = $fir["2g"] + $fir["3g"] + $fir["4g"];
				    $sumSec = $sec["2g"] + $sec["3g"] + $sec["4g"];
				    
				    if ($sumFir == $sumSec) {
				        return 0; // Elements are equal
				    } elseif ($sumFir < $sumSec) {
				        return -1; // $fir should come before $sec
				    } else {
				        return 1; // $fir should come after $sec
				    }
				});

				// desc sort of inhouse regions by total counts
				uasort($data->impacted_regs["inhouse"], function($fir, $sec)
				{
					$sumFir = $fir["2g"] + $fir["3g"] + $fir["4g"];
				    $sumSec = $sec["2g"] + $sec["3g"] + $sec["4g"];
				    
				    if ($sumFir == $sumSec) {
				        return 0; // Elements are equal
				    } elseif ($sumFir < $sumSec) {
				        return -1; // $fir should come before $sec
				    } else {
				        return 1; // $fir should come after $sec
				    }
				});

				$mc = 0;
				foreach ($data->impacted_regs["msd"] as $mk => $mr)
				{
					if( $mr["2g"] >= 10 || $mr["3g"] >= 10 || $mr["4g"] >= 10 )
					{
						$data->impact_regs->msd[$mc]["name"] = $mk;
						$data->impact_regs->msd[$mc]["2g"] = $mr["2g"];
						$data->impact_regs->msd[$mc]["3g"] = $mr["3g"];
						$data->impact_regs->msd[$mc]["4g"] = $mr["4g"];
						$data->impact_regs->msd[$mc]["ibs"] = $mr["ibs"];
						$data->impact_regs->msd[$mc]["power_macro"] = $mr["power_macro"];
						$data->impact_regs->msd[$mc]["power_ibs"] = $mr["power_ibs"];
						$data->impact_regs->msd[$mc]["total"] = $mr["total"];
						$mc++;
					}
				}

				$ic = 0;
				foreach ($data->impacted_regs["inhouse"] as $ik => $ir)
				{
					if( $ir["2g"] >= 10 || $ir["3g"] >= 10 || $ir["4g"] >= 10 )
					{
						$data->impact_regs->inhouse[$ic]["name"] = $ik;
						$data->impact_regs->inhouse[$ic]["2g"] = $ir["2g"];
						$data->impact_regs->inhouse[$ic]["3g"] = $ir["3g"];
						$data->impact_regs->inhouse[$ic]["4g"] = $ir["4g"];
						$data->impact_regs->inhouse[$ic]["ibs"] = $ir["ibs"];
						$data->impact_regs->inhouse[$ic]["power_macro"] = $ir["power_macro"];
						$data->impact_regs->inhouse[$ic]["power_ibs"] = $ir["power_ibs"];
						$data->impact_regs->inhouse[$ic]["total"] = $ir["total"];
						$ic++;
					}
				}

				$mc = 0;
				foreach ($data->impacted_regs["msd"] as $mk => $mr)
				{
					$data->impact_regs_all->msd[$mc]["name"] = $mk;
					$data->impact_regs_all->msd[$mc]["2g"] = $mr["2g"];
					$data->impact_regs_all->msd[$mc]["3g"] = $mr["3g"];
					$data->impact_regs_all->msd[$mc]["4g"] = $mr["4g"];
					$data->impact_regs_all->msd[$mc]["ibs"] = $mr["ibs"];
					$data->impact_regs_all->msd[$mc]["power_macro"] = $mr["power_macro"];
					$data->impact_regs_all->msd[$mc]["power_ibs"] = $mr["power_ibs"];
					$data->impact_regs_all->msd[$mc]["total"] = $mr["total"];
					$mc++;
				}

				$ic = 0;
				foreach ($data->impacted_regs["inhouse"] as $ik => $ir)
				{
					$data->impact_regs_all->inhouse[$ic]["name"] = $ik;
					$data->impact_regs_all->inhouse[$ic]["2g"] = $ir["2g"];
					$data->impact_regs_all->inhouse[$ic]["3g"] = $ir["3g"];
					$data->impact_regs_all->inhouse[$ic]["4g"] = $ir["4g"];
					$data->impact_regs_all->inhouse[$ic]["ibs"] = $ir["ibs"];
					$data->impact_regs_all->inhouse[$ic]["power_macro"] = $ir["power_macro"];
					$data->impact_regs_all->inhouse[$ic]["power_ibs"] = $ir["power_ibs"];
					$data->impact_regs_all->inhouse[$ic]["total"] = $ir["total"];
					$ic++;
				}
				
				$mem_resp->data->alarm_stats->sharing = $shared_site_power;
				$mem_resp->data->alarm_stats->dg_site = $dg_sites_power;
				$mem_resp->data->alarm_stats->hub_nttn = $nttn_sites_power;

				$data->alarm_stats = $mem_resp->data->alarm_stats;
				
				$resp->data = $data;
				$resp->success = true;							
				$resp->message = "";
			}
			else
			{
				$resp->success = false;					
				$resp->message = $site_resp->message;
			}
		}
		else
		{
			$resp->success = $mem_resp->success;
			$resp->message = $mem_resp->message;
		}

		echo json_encode($resp);
		Yii::app()->end();
	}

	public function actionOfficeSummary()
	{
		$this->reload_available = true;
	    $this->reload_enable = true;
	    $this->reload_time = 1;
	    $this->reload_name = "Reload Office Summary";

	    $user=User::model()->with(array('userDomains'))->findByPk(Yii::app()->user->id);

		if($user===null)
			throw new CHttpException(403,'Forbidden');

		$ran_domain_id = Yii::app()->params["ran_domain_id"];

		$ran_access = false;
		foreach ($user->userDomains as $dm_assign)
		{
			if( $dm_assign->domain_filter_id == $ran_domain_id )
			{
				$ran_access = true;
				break;
			}
		}

		if(!$ran_access)
			throw new CHttpException(403,'You donot have Access to Perform this Action.');

	    if( $user->user_reload_settings != null )
		{
			$user_reload_setting = @json_decode($user->user_reload_settings, true);

			if( isset($user_reload_setting["network_availibility_ofc"]["relaod_enable"]) && isset($user_reload_setting["network_availibility_ofc"]["relaod_time"]) )
			{
				$this->reload_enable = ($user_reload_setting["network_availibility_ofc"]["relaod_enable"])?true:false;
				$this->reload_time = intval($user_reload_setting["network_availibility_ofc"]["relaod_time"]);
			}
		}

		ini_set('max_execution_time', 60); // 1 minute
		ini_set("memory_limit", "-1");

		$tech_impact_regs = array("2g", "3g", "4g", "ibs", "power_macro", "power_ibs", "voltage_macro", "voltage_ibs", "total", "genset_g4h");
		$ros = array('RO-1'=>'RO-1','RO-2'=>'RO-2','RO-3'=>'RO-3','RO-4'=>'RO-4','RO-5'=>'RO-5','RO-6'=>'RO-6');

		$data = new stdClass;
		$data->impacted_regs = array();
		$data->impacted_regs ["msd"] = array();
		$data->impacted_regs ["inhouse"] = array();
		$data->impact_ros = array();

		$resp_data = new stdClass;
		$resp_data->impact_regs = new stdClass;
		$resp_data->impact_regs->msd = array();
		$resp_data->impact_regs->inhouse = array();
		$resp_data->impact_ros = array();

		$mem_resp = MemHelper::GetObject("network_availibility");

		if($mem_resp->success)
		{
			$site_pc_counts = $mem_resp->data->site_pc_counts;

			$site_resp = MemHelper::get_site_list();
			if($site_resp->success)
			{
				$inhouse_offices = array();
				$msd_offices = array();
				$inhouse_lookup = array();
				$msd_lookup = array();
				$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
				if( $om_ofc_resp->success )
				{
					foreach ($om_ofc_resp->data as $key => $om_ofc)
					{
						if( $om_ofc->office_type_id == 1)
						{
							$inhouse_offices [] = $om_ofc->name;
							$inhouse_lookup [$om_ofc->id] = $om_ofc->name;
						}
						else if( $om_ofc->office_type_id == 2)
						{
							$msd_offices [] = $om_ofc->name;
							$msd_lookup [$om_ofc->id] = $om_ofc->name;
						}
					}
				}
				else
				{
					throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
				}

				foreach ($inhouse_offices as $inhouse_ofc)
				{
					$data->impacted_regs ["inhouse"][$inhouse_ofc] = array();

					foreach ($tech_impact_regs as $tech_impact)
					{
						$data->impacted_regs ["inhouse"][$inhouse_ofc][$tech_impact] = 0;
					}
				}

				foreach ($msd_offices as $msd_ofc)
				{
					$data->impacted_regs ["msd"][$msd_ofc] = array();

					foreach ($tech_impact_regs as $tech_impact)
					{
						$data->impacted_regs ["msd"][$msd_ofc][$tech_impact] = 0;
					}
				}

				foreach ($ros as $ro)
				{
					$data->impact_ros [$ro] = 0;
				}

				foreach ($site_resp->site_list as $sid => $site)
				{
					$site_fin_obj = new stdClass;
					$site_fin_obj->region = $site["zone"];
					$site_fin_obj->ro = $site["ro"];
					$site_fin_obj->priority = $site["site_priority"];
					$site_fin_obj->generic_id = $site["generic_id"];
					$site_fin_obj->id = $site["id"];
					$site_fin_obj->lat = $site["lat"];
					$site_fin_obj->long = $site["long"];

					$site_fin_obj->_power = true; // every site has power
					$site_fin_obj->_2g = false;
					$site_fin_obj->_3g = false;
					$site_fin_obj->_4g = false;
					$site_fin_obj->_ibs = false;
					
					$site_fin_obj->outage_power = false;
					$site_fin_obj->low_voltage = false;
					$site_fin_obj->genset_g4h = false;
					$site_fin_obj->outage_2g = false;
					$site_fin_obj->outage_3g = false;
					$site_fin_obj->outage_4g = false;
					$site_fin_obj->outage_ibs = false;

					$site_fin_obj->msd = false;
					$site_fin_obj->inhouse = false;

					if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
						$site_fin_obj->p1 = true;
					else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
						$site_fin_obj->p2 = true;
					else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
						$site_fin_obj->p3 = true;

					$site["om_office"] = null;
					$site["msd_office"] = null;

					if( $site["om_office_type"] == 2 )
					{
						$site_fin_obj->msd = true;
						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
						{
							$site["msd_office"] = $msd_lookup[$site["msd_office_id"]];
						}

						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$site_fin_obj->inhouse = true;
							$site["om_office"] = $inhouse_lookup[$site["om_office_id"]];
						}
					}
					else if ( $site["om_office_type"] == 1 )
					{
						$site_fin_obj->inhouse = true;
						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$site["om_office"] = $inhouse_lookup[$site["om_office_id"]];
						}
					}

					if(isset($site["site_code_2g"]))
					{
						$site_fin_obj->_2g = true;
					}
					if(isset($site["site_code_3g"]))
					{
						$site_fin_obj->_3g = true;
					}
					if(isset($site["site_code_4g"]))
					{
						$site_fin_obj->_4g = true;
					}

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					{
					    $site_fin_obj->_ibs = false;
					}
					else
					{
						$site_fin_obj->_ibs = true;
					}

					if( isset($site_pc_counts[$sid]) )
					{
						// check outage criteria
						if( sizeof($site_pc_counts[$sid]->power_alarms) > 0 )
						{
							$site_fin_obj->outage_power = true;
						}

						if( sizeof($site_pc_counts[$sid]->lowvoltage_alarms) > 0 )
						{
							$site_fin_obj->low_voltage = true;
						}

						if( sizeof($site_pc_counts[$sid]->genset_g4h_alarms) > 0 )
						{
							$site_fin_obj->genset_g4h = true;
						}

						if($site_fin_obj->_2g)
						{
							if( sizeof($site_pc_counts[$sid]->_2g_single_pc1) > 0 )
								$site_fin_obj->outage_2g = true;
							else if( sizeof($site_pc_counts[$sid]->_2g_single_pc2) > 0 )
								$site_fin_obj->outage_2g = true;
							else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc4) >= $site["cell_2g"] )
								$site_fin_obj->outage_2g = true;
							else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc5) >= $site["cell_2g"] )
								$site_fin_obj->outage_2g = true;
						}

						if($site_fin_obj->_3g)
						{
							if( sizeof($site_pc_counts[$sid]->_3g_single_pc1) > 0 )
								$site_fin_obj->outage_3g = true;
							else if( sizeof($site_pc_counts[$sid]->_3g_single_pc2) > 0 )
								$site_fin_obj->outage_3g = true;
							else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc4) >= $site["cell_3g"] )
								$site_fin_obj->outage_3g = true;
							else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc5) >= $site["cell_3g"] )
								$site_fin_obj->outage_3g = true;
						}

						if($site_fin_obj->_4g)
						{
							if( sizeof($site_pc_counts[$sid]->_4g_single_pc1) > 0 )
								$site_fin_obj->outage_4g = true;
							else if( sizeof($site_pc_counts[$sid]->_4g_single_pc2) > 0 )
								$site_fin_obj->outage_4g = true;
							else if( sizeof($site_pc_counts[$sid]->_4g_single_pc3) > 0 )
								$site_fin_obj->outage_4g = true;
							// special condition needs to occur 2 times on a site
							else if(  sizeof($site_pc_counts[$sid]->_4g_single_pc_req_2num) >= 4 )
							{
								$mme0 = false;
								$mme1 = false;
								$mme2 = false;
								$mme3 = false;

								foreach ($site_pc_counts[$sid]->_4g_single_pc_req_2num as $slog)
								{
									if( @strpos($slog["ao"], 'LNMME-0') !== false )
										$mme0 = true;
									else if( @strpos($slog["ao"], 'LNMME-1') !== false )
										$mme1 = true;
									else if( @strpos($slog["ao"], 'LNMME-2') !== false )
										$mme2 = true;
									else if( @strpos($slog["ao"], 'LNMME-3') !== false )
										$mme3 = true;
								}

								if( $mme0 && $mme1 && $mme2 && $mme3 )
								{
									$site_fin_obj->outage_4g = true;
								}
							}
							else if( sizeof($site_pc_counts[$sid]->_4g_single_hybrid_pc) > 0 )
								$site_fin_obj->outage_4g = true;
							else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_num_pc4) >= $site["cell_4g"])
								$site_fin_obj->outage_4g = true;
							else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_hybrid_pc) >= $site["cell_4g"])
								$site_fin_obj->outage_4g = true;
						}

						if( $site_fin_obj->_ibs )
						{
							// ibs outage check will be here.
							// ibs is a site type, so 2G outage on an ibs site will be counted as ibs outage
							if( $site_fin_obj->outage_2g )
							{
								$site_fin_obj->outage_ibs = true;
							}
						}
					}

					if( $site_fin_obj->ro != null && isset($data->impact_ros [$site_fin_obj->ro]) )
					{
						if( $site_fin_obj->genset_g4h )
						{
							$data->impact_ros [$site_fin_obj->ro]++;
						}
					}

					if( $site_fin_obj->msd )
					{
						if($site["msd_office"] != null)
						{
							if($site_fin_obj->outage_2g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["2g"]++;
							}
							if($site_fin_obj->outage_3g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["3g"]++;
							}
							if($site_fin_obj->outage_4g)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["4g"]++;
							}

							if ( $site_fin_obj->outage_2g )
							{
								if ( $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["ibs"]++;
								}
							}

							if($site_fin_obj->outage_power)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["power_ibs"]++;
								}
								else
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["power_macro"]++;
								}
							}

							if($site_fin_obj->low_voltage)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["voltage_ibs"]++;
								}
								else
								{
									$data->impacted_regs ["msd"][$site["msd_office"]]["voltage_macro"]++;
								}
							}

							if($site_fin_obj->genset_g4h)
							{
								$data->impacted_regs ["msd"][$site["msd_office"]]["genset_g4h"]++;
							}
						}
					}

					if ( $site_fin_obj->inhouse )
					{
						if($site["om_office"] != null)
						{
							if($site_fin_obj->outage_2g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["2g"]++;
							}
							if($site_fin_obj->outage_3g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["3g"]++;
							}
							if($site_fin_obj->outage_4g)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["4g"]++;
							}

							if ( $site_fin_obj->outage_2g )
							{
								if ( $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["ibs"]++;
								}
							}

							if($site_fin_obj->outage_power)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["power_ibs"]++;
								}
								else
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["power_macro"]++;
								}
							}

							if($site_fin_obj->low_voltage)
							{
								if(  $site_fin_obj->_ibs )
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["voltage_ibs"]++;
								}
								else
								{
									$data->impacted_regs ["inhouse"][$site["om_office"]]["voltage_macro"]++;
								}
							}

							if($site_fin_obj->genset_g4h)
							{
								$data->impacted_regs ["inhouse"][$site["om_office"]]["genset_g4h"]++;
							}
						}
					}
				}

				// desc sort of msd regions by total counts
				uasort($data->impacted_regs["msd"], function($fir, $sec)
				{
					$sumFir = $fir["2g"] + $fir["3g"] + $fir["4g"];
				    $sumSec = $sec["2g"] + $sec["3g"] + $sec["4g"];
				    
				    if ($sumFir == $sumSec) {
				        return 0; // Elements are equal
				    } elseif ($sumFir < $sumSec) {
				        return -1; // $fir should come before $sec
				    } else {
				        return 1; // $fir should come after $sec
				    }
				});

				// desc sort of inhouse regions by total counts
				uasort($data->impacted_regs["inhouse"], function($fir, $sec)
				{
					$sumFir = $fir["2g"] + $fir["3g"] + $fir["4g"];
				    $sumSec = $sec["2g"] + $sec["3g"] + $sec["4g"];
				    
				    if ($sumFir == $sumSec) {
				        return 0; // Elements are equal
				    } elseif ($sumFir < $sumSec) {
				        return -1; // $fir should come before $sec
				    } else {
				        return 1; // $fir should come after $sec
				    }
				});

				foreach ($data->impact_ros as $rn => $rcount)
				{
					$resp_data->impact_ros [] = array("name"=>$rn, "count"=>$rcount);
				}

				$mc = 0;
				foreach ($data->impacted_regs["msd"] as $mk => $mr)
				{
					$resp_data->impact_regs->msd[$mc]["name"] = $mk;
					$resp_data->impact_regs->msd[$mc]["2g"] = $mr["2g"];
					$resp_data->impact_regs->msd[$mc]["3g"] = $mr["3g"];
					$resp_data->impact_regs->msd[$mc]["4g"] = $mr["4g"];
					$resp_data->impact_regs->msd[$mc]["ibs"] = $mr["ibs"];
					$resp_data->impact_regs->msd[$mc]["power_macro"] = $mr["power_macro"];
					$resp_data->impact_regs->msd[$mc]["power_ibs"] = $mr["power_ibs"];
					$resp_data->impact_regs->msd[$mc]["voltage_ibs"] = $mr["voltage_ibs"];
					$resp_data->impact_regs->msd[$mc]["voltage_macro"] = $mr["voltage_macro"];
					$resp_data->impact_regs->msd[$mc]["genset_g4h"] = $mr["genset_g4h"];
					$mc++;
				}

				$ic = 0;
				foreach ($data->impacted_regs["inhouse"] as $ik => $ir)
				{
					$resp_data->impact_regs->inhouse[$ic]["name"] = $ik;
					$resp_data->impact_regs->inhouse[$ic]["2g"] = $ir["2g"];
					$resp_data->impact_regs->inhouse[$ic]["3g"] = $ir["3g"];
					$resp_data->impact_regs->inhouse[$ic]["4g"] = $ir["4g"];
					$resp_data->impact_regs->inhouse[$ic]["ibs"] = $ir["ibs"];
					$resp_data->impact_regs->inhouse[$ic]["power_macro"] = $ir["power_macro"];
					$resp_data->impact_regs->inhouse[$ic]["power_ibs"] = $ir["power_ibs"];
					$resp_data->impact_regs->inhouse[$ic]["voltage_ibs"] = $ir["voltage_ibs"];
					$resp_data->impact_regs->inhouse[$ic]["voltage_macro"] = $ir["voltage_macro"];
					$resp_data->impact_regs->inhouse[$ic]["genset_g4h"] = $ir["genset_g4h"];
					$ic++;
				}
			}
			else
			{
				throw new CHttpException(500,'Error: '.$site_resp->message);
			}
		}
		else
		{
			throw new CHttpException(500,'Error: '.$mem_resp->message);
		}

		$this->render('office_wise_view', array(
			'data' => $resp_data
		));
	}

	public function actionOfNotes()
	{
		$of_file = Yii::app()->basePath."/data/of_notes.json";

		$resp = new stdClass;
		$resp->success = true;
		$resp->message = "";
		$resp->of_notes = array();

		if( isset($_POST["note_info"]) )
		{
			if( isset($_POST["note_info"]["action"]) && isset($_POST["note_info"]["note"]) )
			{
				$action = $_POST["note_info"]["action"];
				$note = @trim($_POST["note_info"]["note"]);
				$note_obj = array();
				$note_obj["text"] = @trim($_POST["note_info"]["note"]);
				$note_obj["pr"] = "wa";

				if(isset($_POST["note_info"]["pr"]))
					$note_obj["pr"] = $_POST["note_info"]["pr"];

				if( $action == "c" && !empty($note) )
				{
					if( file_exists($of_file) )
					{
						$of_notes = @json_decode(file_get_contents($of_file), true);
						if( json_last_error() != JSON_ERROR_NONE )
						{
							$of_notes = array();
							$of_notes [uniqid()] = $note_obj;
						}
						else
						{
							$of_notes [uniqid()] = $note_obj;
						}

						$fp = fopen($of_file, 'w');
						if($fp)
						{
							fwrite($fp, json_encode($of_notes));
							fclose($fp);
							$resp->of_notes = $this->assoc_to_arr($of_notes);
						}
						else
						{
							$resp->success = false;
							$resp->message = "Unable to Write to File!";
						}
					}
					else
					{
						$of_notes = array();
						$of_notes [uniqid()] = $note_obj;
						$fp = fopen($of_file, 'w');
						if($fp)
						{
							fwrite($fp, json_encode($of_notes));
							fclose($fp);
							$resp->of_notes = $this->assoc_to_arr($of_notes);
						}
						else
						{
							$resp->success = false;
							$resp->message = "Unable to Write to File!";
						}
					}
				}
				else if( $action == "d" && !empty($note) )
				{
					if( file_exists($of_file) )
					{
						$of_notes = @json_decode(file_get_contents($of_file), true);
						if( json_last_error() == JSON_ERROR_NONE )
						{
							if( isset($of_notes[$note]) )
								unset($of_notes[$note]);
						}
						else
						{
							$of_notes = array();
						}

						$fp = fopen($of_file, 'w');
						if($fp)
						{
							fwrite($fp, json_encode($of_notes));
							fclose($fp);
							$resp->of_notes = $of_notes;
						}
						else
						{
							$resp->success = false;
							$resp->message = "Unable to Write to File!";
						}
					}
				}
				else
				{
					$resp->success = false;
					$resp->message = "Invalid Request";
				}
			}
			else
			{
				$resp->success = false;
				$resp->message = "Invalid Request";
			}
		}

	 	if( file_exists($of_file) )
	 	{
	 		$of_notes = @json_decode(file_get_contents($of_file), true);
	 		$resp->of_notes = $this->assoc_to_arr($of_notes);
			if( json_last_error() != JSON_ERROR_NONE )
			{
				$resp->success = true;
				$resp->message = "Invalid Data found in File!";
			}
	 	}

		echo json_encode($resp);
		Yii::app()->end();
	}

	public function assoc_to_arr($arr)
	{
		$res = array();
		foreach ($arr as $key => $value)
		{
			$res_obj = new stdClass;
			$res_obj->id = $key;
			$res_obj->text = $value["text"];
			$res_obj->pr = $value["pr"];

			$res [] = $res_obj;
		}
		return $res;
	}

	public function actionExportOutageStats()
	{
		ini_set('max_execution_time', 120); // 1 minute
		ini_set('memory_limit', '2048M');

		$site_resp = MemHelper::get_site_list();
		if(!$site_resp->success)
		{
			throw new CHttpException(500,'Error Getting Sites Outage Data (Mem): '.$mem_resp->message);
		}

		$mem_resp = MemHelper::GetObject("network_availibility");
		if(!$mem_resp->success)
		{
			throw new CHttpException(500,'Error Getting Outage Data (Mem): '.$mem_resp->message);
		}

		$om_ofc_lookup = array();
		$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
		if( $om_ofc_resp->success )
		{
			foreach ($om_ofc_resp->data as $key => $om_ofc)
			{
				if( $om_ofc->office_type_id == 1 || $om_ofc->office_type_id == 2 )
				{
					$om_ofc_lookup [$om_ofc->id] = $om_ofc->name;
				}
			}
		}
		else
		{
			throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
		}

		

		$site_pc_counts = $mem_resp->data->site_pc_counts;

		$final_array = array();
		foreach ($site_resp->site_list as $sid => $site)
		{
			$site_fin_obj = new stdClass;
			$site_fin_obj->region = $site["zone"];
			$site_fin_obj->ro = $site["ro"];
			$site_fin_obj->priority = $site["site_priority"];
			$site_fin_obj->generic_id = $site["generic_id"];
			$site_fin_obj->site_code_2g = $site["site_code_2g"];
			$site_fin_obj->site_code_3g = $site["site_code_3g"];
			$site_fin_obj->site_code_4g = $site["site_code_4g"];
			$site_fin_obj->shared_site_code = $site["shared_site_code"];
			$site_fin_obj->shared_operator = $site["shared_operator"];
			$site_fin_obj->share_type = $site["share_type"];
			$site_fin_obj->dg_combination = $site["dg_combination"];
			$site_fin_obj->sharing_type = $site["sharing_type"];
			$site_fin_obj->power_status = $site["power_status"];
			$site_fin_obj->bts_type = $site["bts_type"];
			$site_fin_obj->mini_hub = $site["mini_hub"];
			$site_fin_obj->service_type = $site["service_type"];
			$site_fin_obj->no_of_sites = $site["no_of_sites"];
			$site_fin_obj->hub_site = $site["hub_site"];
			$site_fin_obj->uplink_2g = $site["uplink_2g"];
			$site_fin_obj->downlink_2g = $site["downlink_2g"];
			$site_fin_obj->uplink_3g = $site["uplink_3g"];
			$site_fin_obj->downlink_3g = $site["downlink_3g"];
			$site_fin_obj->uplink_4g = $site["uplink_4g"];
			$site_fin_obj->downlink_4g = $site["downlink_4g"];
			$site_fin_obj->site_bsc_rnc = implode(" / ", array_filter( array($site["bsc_2g"], $site["rnc_3g"]) )); $site["downlink_4g"];
			$site_fin_obj->thana = $site["thana"];
			$site_fin_obj->district = $site["district"];
			$site_fin_obj->commercial_zone = $site["commercial_zone"];

			$site_fin_obj->om_ofc = null;
			$site_fin_obj->msd_ofc = null;
			$site_fin_obj->om_ofc_type = null;

			if( $site["om_office_type"] == 2 )
				$site_fin_obj->om_ofc_type = 'MSD';
			else if ( $site["om_office_type"] == 1 )
				$site_fin_obj->om_ofc_type = 'In-House';

			if( isset($om_ofc_lookup[$site["om_office_id"]]) )
			{
				$site_fin_obj->om_ofc = $om_ofc_lookup[$site["om_office_id"]];
			}

			if( isset($om_ofc_lookup[$site["msd_office_id"]]) )
			{
				$site_fin_obj->msd_ofc = $om_ofc_lookup[$site["msd_office_id"]];
			}

			$site_fin_obj->_power = true; // every site has power
			$site_fin_obj->_2g = false;
			$site_fin_obj->_3g = false;
			$site_fin_obj->_4g = false;

			if(isset($site["site_code_2g"]))
			{
				$site_fin_obj->_2g = true;
			}
			if(isset($site["site_code_3g"]))
			{
				$site_fin_obj->_3g = true;
			}
			if(isset($site["site_code_4g"]))
			{
				$site_fin_obj->_4g = true;
			}
			
			$site_fin_obj->outage_power = false;
			$site_fin_obj->outage_power_start = null;
			$site_fin_obj->low_voltage = false;
			$site_fin_obj->low_voltage_start = null;
			$site_fin_obj->genset_g4h = false;
			$site_fin_obj->genset_g4h_start = null;
			$site_fin_obj->outage_2g = false;
			$site_fin_obj->outage_2g_start = null;
			$site_fin_obj->outage_3g = false;
			$site_fin_obj->outage_3g_start = null;
			$site_fin_obj->outage_4g = false;
			$site_fin_obj->outage_4g_start = null;


			if( isset($site_pc_counts[$sid]) )
			{
				// check outage criteria
				if( sizeof($site_pc_counts[$sid]->power_alarms) > 0 )
				{
					$site_fin_obj->outage_power = true;
					$site_fin_obj->outage_power_start = $site_pc_counts[$sid]->power_alarms[0]["alarm_raised_time"];
				}

				if( sizeof($site_pc_counts[$sid]->lowvoltage_alarms) > 0 )
				{
					$site_fin_obj->low_voltage = true;
					$site_fin_obj->low_voltage_start = $site_pc_counts[$sid]->lowvoltage_alarms[0]["alarm_raised_time"];
				}

				if( sizeof($site_pc_counts[$sid]->genset_g4h_alarms) > 0 )
				{
					$site_fin_obj->genset_g4h = true;
					$site_fin_obj->genset_g4h_start = $site_pc_counts[$sid]->genset_g4h_alarms[0]["alarm_raised_time"];
				}

				if($site_fin_obj->_2g)
				{
					if( sizeof($site_pc_counts[$sid]->_2g_single_pc1) > 0 )
					{
						$site_fin_obj->outage_2g = true;
						$site_fin_obj->outage_2g_start = $site_pc_counts[$sid]->_2g_single_pc1[0]["alarm_raised_time"];
					}
					else if( sizeof($site_pc_counts[$sid]->_2g_single_pc2) > 0 )
					{
						$site_fin_obj->outage_2g = true;
						$site_fin_obj->outage_2g_start = $site_pc_counts[$sid]->_2g_single_pc2[0]["alarm_raised_time"];
					}
					else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc4) >= $site["cell_2g"] )
					{
						$site_fin_obj->outage_2g = true;
						$site_fin_obj->outage_2g_start = $site_pc_counts[$sid]->_2g_cell_num_pc4[0]["alarm_raised_time"];
					}
					else if( $site["cell_2g"] != null && $site["cell_2g"] > 0 && sizeof($site_pc_counts[$sid]->_2g_cell_num_pc5) >= $site["cell_2g"] )
					{
						$site_fin_obj->outage_2g = true;
						$site_fin_obj->outage_2g_start = $site_pc_counts[$sid]->_2g_cell_num_pc5[0]["alarm_raised_time"];
					}
				}

				if($site_fin_obj->_3g)
				{
					if( sizeof($site_pc_counts[$sid]->_3g_single_pc1) > 0 )
					{
						$site_fin_obj->outage_3g = true;
						$site_fin_obj->outage_3g_start = $site_pc_counts[$sid]->_3g_single_pc1[0]["alarm_raised_time"];
					}
					else if( sizeof($site_pc_counts[$sid]->_3g_single_pc2) > 0 )
					{
						$site_fin_obj->outage_3g = true;
						$site_fin_obj->outage_3g_start = $site_pc_counts[$sid]->_3g_single_pc2[0]["alarm_raised_time"];
					}
					else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc4) >= $site["cell_3g"] )
					{
						$site_fin_obj->outage_3g = true;
						$site_fin_obj->outage_3g_start = $site_pc_counts[$sid]->_3g_cell_num_pc4[0]["alarm_raised_time"];
					}
					else if( $site["cell_3g"] != null && $site["cell_3g"] > 0 && sizeof($site_pc_counts[$sid]->_3g_cell_num_pc5) >= $site["cell_3g"] )
					{
						$site_fin_obj->outage_3g = true;
						$site_fin_obj->outage_3g_start = $site_pc_counts[$sid]->_3g_cell_num_pc5[0]["alarm_raised_time"];
					}
				}

				if($site_fin_obj->_4g)
				{
					if( sizeof($site_pc_counts[$sid]->_4g_single_pc1) > 0 )
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_single_pc1[0]["alarm_raised_time"];
					}
					else if( sizeof($site_pc_counts[$sid]->_4g_single_pc2) > 0 )
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_single_pc2[0]["alarm_raised_time"];
					}
					else if( sizeof($site_pc_counts[$sid]->_4g_single_pc3) > 0 )
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_single_pc3[0]["alarm_raised_time"];
					}
					// special condition needs to occur 2 times on a site
					else if(  sizeof($site_pc_counts[$sid]->_4g_single_pc_req_2num) >= 4 )
					{
						$mme0 = false;
						$mme1 = false;
						$mme2 = false;
						$mme3 = false;

						foreach ($site_pc_counts[$sid]->_4g_single_pc_req_2num as $slog)
						{
							if( @strpos($slog["ao"], 'LNMME-0') !== false )
								$mme0 = true;
							else if( @strpos($slog["ao"], 'LNMME-1') !== false )
								$mme1 = true;
							else if( @strpos($slog["ao"], 'LNMME-2') !== false )
								$mme2 = true;
							else if( @strpos($slog["ao"], 'LNMME-3') !== false )
								$mme3 = true;
						}

						if( $mme0 && $mme1 && $mme2 && $mme3 )
						{
							$site_fin_obj->outage_4g = true;
							$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_single_pc_req_2num[0]["alarm_raised_time"];
						}
					}
					else if( sizeof($site_pc_counts[$sid]->_4g_single_hybrid_pc) > 0 )
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_single_hybrid_pc[0]["alarm_raised_time"];
					}
					else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_num_pc4) >= $site["cell_4g"])
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_cell_num_pc4[0]["alarm_raised_time"];
					}
					else if( $site["cell_4g"] != null && $site["cell_4g"] > 0 && sizeof($site_pc_counts[$sid]->_4g_cell_hybrid_pc) >= $site["cell_4g"])
					{
						$site_fin_obj->outage_4g = true;
						$site_fin_obj->outage_4g_start = $site_pc_counts[$sid]->_4g_cell_hybrid_pc[0]["alarm_raised_time"];
					}
				}
			}

			$final_array [] = $site_fin_obj;
		}

		$this->download_send_headers("outages_export_" . date("Y-m-d") . ".csv");
		echo $this->array2csv($final_array);
		Yii::app()->end();
	}

	private function array2csv(array &$array)
	{
		ob_start();
		$df = fopen("php://output", 'w');
		reset($array);
		fputcsv($df, array(
			"Generic ID",
			"2G Site Code",
			"3G Site Code",
			"4G Site Code",
			"Power Outage",
			"Power Outage Start Date",
			"Power Outage Start Time",
			"Power Outage Duration",
			"2G Outage",
			"2G Outage Start Date",
			"2G Outage Start Time",
			"2G Outage Duration",
			"3G Outage",
			"3G Outage Start Date",
			"3G Outage Start Time",
			"3G Outage Duration",
			"4G Outage",
			"4G Outage Start Date",
			"4G Outage Start Time",
			"4G Outage Duration",
			"Low Voltage",
			"Low Voltage Start Date",
			"Low Voltage Start Time",
			"Low Voltage Duration",
			"GENSET ON (> 4 hours)",
			"GENSET ON Start Date",
			"GENSET ON Start Time",
			"GENSET ON Duration",
			"Site Priority",
			"Zone",
			"Regional Office",
			"Shared Site Code",
			"Shared Operator",
			"Shared Type",
			"DG Combination",
			"Sharing Type",
			"Power Status",
			"BTS Type",
			"NTTN mini-hub",
			"Service Type",
			"Number of Carrying Sites",
			"BSC/RNC",
			"Thana",
			"District",
			"Commercial Zone",
			"2G Uplink",
			"2G Downlink",
			"3G Uplink",
			"3G Downlink",
			"4G Uplink",
			"4G Downlink",
			"Office Type",
			"In-House Office",
			"MSD Office",
			"Hub Site",
		));
		foreach ($array as $site)
		{
			$res_site = array();

			$res_site [] = $site->generic_id;
			$res_site [] = $site->site_code_2g;
			$res_site [] = $site->site_code_3g;
			$res_site [] = $site->site_code_4g;

			if ( $site->outage_power )
			{
				$res_site [] = 'Yes';
				if( $site->outage_power_start != null)
				{
					$res_site [] = date("Y-m-d",@strtotime($site->outage_power_start));
					$res_site [] = date("H:i:s",@strtotime($site->outage_power_start));
					$t = time() - @strtotime($site->outage_power_start);
					$res_site [] = round($t/60, 2);
				}
				else
				{
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = 'No';
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			if ( $site->_2g )
			{
				if ( $site->outage_2g )
				{
					$res_site [] = 'Yes';
					if( $site->outage_2g_start != null)
					{
						$res_site [] = date("Y-m-d",@strtotime($site->outage_2g_start));
						$res_site [] = date("H:i:s",@strtotime($site->outage_2g_start));
						$t = time() - @strtotime($site->outage_2g_start);
						$res_site [] = round($t/60, 2);
					}
					else
					{
						$res_site [] = null;
						$res_site [] = null;
						$res_site [] = null;
					}
				}
				else
				{
					$res_site [] = 'No';
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			if ( $site->_3g )
			{
				if ( $site->outage_3g )
				{
					$res_site [] = 'Yes';
					if( $site->outage_3g_start != null)
					{
						$res_site [] = date("Y-m-d",@strtotime($site->outage_3g_start));
						$res_site [] = date("H:i:s",@strtotime($site->outage_3g_start));
						$t = time() - @strtotime($site->outage_3g_start);
						$res_site [] = round($t/60, 2);
					}
					else
					{
						$res_site [] = null;
						$res_site [] = null;
						$res_site [] = null;
					}
				}
				else
				{
					$res_site [] = 'No';
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			if ( $site->_4g )
			{
				if ( $site->outage_4g )
				{
					$res_site [] = 'Yes';
					if( $site->outage_4g_start != null)
					{
						$res_site [] = date("Y-m-d",@strtotime($site->outage_4g_start));
						$res_site [] = date("H:i:s",@strtotime($site->outage_4g_start));
						$t = time() - @strtotime($site->outage_4g_start);
						$res_site [] = round($t/60, 2);
					}
					else
					{
						$res_site [] = null;
						$res_site [] = null;
						$res_site [] = null;
					}
				}
				else
				{
					$res_site [] = 'No';
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			if ( $site->low_voltage )
			{
				$res_site [] = 'Yes';
				if( $site->low_voltage_start != null)
				{
					$res_site [] = date("Y-m-d",@strtotime($site->low_voltage_start));
					$res_site [] = date("H:i:s",@strtotime($site->low_voltage_start));
					$t = time() - @strtotime($site->low_voltage_start);
					$res_site [] = round($t/60, 2);
				}
				else
				{
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = 'No';
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			if ( $site->genset_g4h )
			{
				$res_site [] = 'Yes';
				if( $site->genset_g4h_start != null)
				{
					$res_site [] = date("Y-m-d",@strtotime($site->genset_g4h_start));
					$res_site [] = date("H:i:s",@strtotime($site->genset_g4h_start));
					$t = time() - @strtotime($site->genset_g4h_start);
					$res_site [] = round($t/60, 2);
				}
				else
				{
					$res_site [] = null;
					$res_site [] = null;
					$res_site [] = null;
				}
			}
			else
			{
				$res_site [] = 'No';
				$res_site [] = null;
				$res_site [] = null;
				$res_site [] = null;
			}

			$res_site [] = $site->priority;
			$res_site [] = $site->region;
			$res_site [] = $site->ro;
			$res_site [] = $site->shared_site_code;
			$res_site [] = $site->shared_operator;
			$res_site [] = $site->share_type;
			$res_site [] = $site->dg_combination;
			$res_site [] = $site->sharing_type;
			$res_site [] = $site->power_status;
			$res_site [] = $site->bts_type;
			$res_site [] = $site->mini_hub;
			$res_site [] = $site->service_type;
			$res_site [] = $site->no_of_sites;
			$res_site [] = $site->site_bsc_rnc;
			$res_site [] = $site->thana;
			$res_site [] = $site->district;
			$res_site [] = $site->commercial_zone;
			$res_site [] = $site->uplink_2g;
			$res_site [] = $site->downlink_2g;
			$res_site [] = $site->uplink_3g;
			$res_site [] = $site->downlink_3g;
			$res_site [] = $site->uplink_4g;
			$res_site [] = $site->downlink_4g;
			$res_site [] = $site->om_ofc_type;
			$res_site [] = $site->om_ofc;
			$res_site [] = $site->msd_ofc;
			$res_site [] = $site->hub_site;

			fputcsv($df, $res_site);
		}
		fclose($df);
		return ob_get_clean();
	}

	private function download_send_headers($filename)
	{
	    // disable caching
	    // $now = gmdate("D, d M Y H:i:s");
	    // header("Expires: Tue, 03 Jul 2001 06:00:00 GMT");
	    // header("Cache-Control: max-age=0, no-cache, must-revalidate, proxy-revalidate");
	    // header("Last-Modified: {$now} GMT");

	    // force download  
	    header("Content-Type: application/force-download");
	    header("Content-Type: application/octet-stream");
	    header("Content-Type: application/download");

	    // disposition / encoding on response body
	    header("Content-Disposition: attachment;filename={$filename}");
	    header("Content-Transfer-Encoding: binary");
	}




	// Availability Report Stuff
	public function actionReport()
	{
		$this->render('avilability_export', array(
		));
	}

	private function validateDate($date, $format = 'Y-m-d', $target = 'Y-m-d' )
	{
	    $d = DateTime::createFromFormat($format, $date);
	    if( $d && $d->format($format) === $date )
	    {
	    	return $d->format($target);
	    }
	    else
	    {
	    	return false;
	    }
	}

	public function actionExtractReport($date, $start_hour, $end_hour)
	{
		$start = null;
		$end = null;
		if( $date == null || @trim($date) == "" )
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}
		
		if( ($start_hour != null && @trim($start_hour) != "") && ($end_hour != null && @trim($end_hour) != "") )
		{
			$start_hour = intval($start_hour);
			$end_hour = intval($end_hour);

			if( $start_hour > $end_hour )
			{
				$temph = $start_hour;
				$start_hour = $end_hour;
				$end_hour = $temph;
			}

			if( ($start_hour < 0 || $start_hour > 23) || ($end_hour < 1 || $end_hour > 24) )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Start and End Hour Provided. Please Provide Valid Hours."
				));
				Yii::app()->end();
			}
		}
		else
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Start and End Hour Provided. Please Provide Valid Hours."
			));
			Yii::app()->end();
		}

		if( $this->validateDate($date, 'd/m/Y') )
		{
			$pd = DateTime::createFromFormat('d/m/Y', $date);
			$sel_date = $pd->format('Y-m-d');

			if( @strtotime($sel_date) > @strtotime(date("Y-m-d")) )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Date Provided. Please Provide a Date for today or Earlier."
				));
				Yii::app()->end();
			}

			$now = time();

			if( $end_hour == 24 )
			{
				$start = $sel_date." ".str_pad($start_hour, 2, '0', STR_PAD_LEFT).":00:00";
				$end = $sel_date." ".str_pad( ($end_hour-1), 2, '0', STR_PAD_LEFT).":59:59";

				$nds = date("Y-m-d", @strtotime('+1 days', @strtotime($sel_date)))." 00:00:00";
			}
			else
			{
				$start = $sel_date." ".str_pad($start_hour, 2, '0', STR_PAD_LEFT).":00:00";
				$end = $sel_date." ".str_pad( ($end_hour-1), 2, '0', STR_PAD_LEFT).":59:59";
				
				$nds = $sel_date." ".str_pad($end_hour, 2, '0', STR_PAD_LEFT).":00:00";
			}

			if( @strtotime($start) > $now || @strtotime($end) > $now )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Start and End Time Provided. Please Provide Time for now or Earlier."
				));
				Yii::app()->end();
			}
		}
		else
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}

		if( $start == null || $end == null || $nds == null )
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Request."
			));
			Yii::app()->end();
		}

		session_write_close();

		require_once (Yii::app()->basePath.'/extensions/PHPExcel-1.8/Classes/PHPExcel.php');

		ini_set('max_execution_time', 300); // 5 minutes
		ini_set("memory_limit", "-1");

		$site_mem_resp = MemHelper::get_site_list();
		if(!$site_mem_resp->success)
			throw new CHttpException(500, "Error Getting Mem Site List: ".$site_mem_resp->message);

		$inhouse_lookup = array();
		$msd_lookup = array();
		$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
		if( $om_ofc_resp->success )
		{
			foreach ($om_ofc_resp->data as $key => $om_ofc)
			{
				if( $om_ofc->office_type_id == 1)
				{
					$inhouse_lookup [$om_ofc->id] = $om_ofc->name;
				}
				else if( $om_ofc->office_type_id == 2)
				{
					$msd_lookup [$om_ofc->id] = $om_ofc->name;
				}
			}
		}
		else
		{
			throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
		}

		$window = 180; // 3 mins
		$now = time();

		// Not instantaneous but SA
		$outages = NetworkAvailabilityHelper::getDurationOutages($start, $end, $site_mem_resp, false, false);
		
		// ORDER BY t.start_time ASC
		usort($outages, function($a, $b)
		{
			if(@strtotime($a['start_time'])==@strtotime($b['start_time'])) return 0;
			return @strtotime($a['start_time']) > @strtotime($b['start_time'])?1:-1;
		});

		$sw_2g_out = array();
		$sw_3g_out = array();
		$sw_4g_out = array();

		foreach ($outages as $outage)
		{
			$outage ["fluctuation"] = 0;
			$outage ["fluc_ranges"] = array();
			if( isset($site_mem_resp->site_list[$outage["site_id"]]) )
			{
				$tvrname = null;
				if( $outage["technology"] == "2G" )
					$tvrname = "sw_2g_out";
				else if( $outage["technology"] == "3G" )
					$tvrname = "sw_3g_out";
				else if( $outage["technology"] == "4G" )
					$tvrname = "sw_4g_out";

				if( $tvrname != null )
				{
					if( !isset(${$tvrname}[$outage["site_id"]]) )
					{
						${$tvrname}[$outage["site_id"]] = array();
						${$tvrname}[$outage["site_id"]]["site"] = array();
						${$tvrname}[$outage["site_id"]]["cells"] = array();
					}

					// Only considering the site outage slogans not the cell outages
					// if( $outage["type"] == "site" || $outage["type"] == "site_by_cell" )
					if( $outage["type"] == "site" )
					{
						${$tvrname}[$outage["site_id"]]["site"] [] = $outage;
					}
					else if( $outage["cell_name"] != null && $outage["type"] == "cell" )
					{
						if( !isset(${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]]) )
							${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]] = array();

						${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]] [] = $outage;
					}
				}
			}
		}
		

		for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";
			foreach (${$tvrname} as $sk => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$sk]) )
				{
					$site = $site_mem_resp->site_list[$sk];

					if( $site["site_code_".$i."g"] != null && $site["cell_".$i."g"] != null && $site["cell_".$i."g"] > 0 )
					{
						$cts_resp = NetworkAvailabilityHelper::cross_cell_events_to_site_events( $site_outs["cells"], $window, $site["cell_".$i."g"] );

						$site_outs["cells"] = $cts_resp["cells"];
						$site_outs["site"] = array_merge($site_outs["site"], $cts_resp["site"]);
					}

					$site_outs["site"] = NetworkAvailabilityHelper::site_type_combiner($site_outs["site"], $window);

					if( sizeof($site_outs["site"]) > 0 )
					{
						foreach ($site_outs["cells"] as $cell_name => $cell_outs)
						{
							// plain cell out events to supress so fluctuation and cross combination does not create problem.
							$site_outs["cells"][$cell_name] = NetworkAvailabilityHelper::cell_out_suppresser($cell_outs, $site_outs["site"], $window, $start, $nds);
						}
					}

					foreach ($site_outs["cells"] as $cell_name => $cell_outs)
					{
						$site_outs["cells"][$cell_name] = NetworkAvailabilityHelper::cell_type_combiner($cell_outs, $site_outs["site"], $window);
					}

					$site_outs["cells"] = NetworkAvailabilityHelper::cross_cell_events_combiner($site_outs["cells"], $window);

					${$tvrname}[$sk] = $site_outs;
				}
			}
		}



		$phpExcel = new PHPExcel;
		// Setting font to Arial Black
		$phpExcel->getDefaultStyle()->getFont()->setName('Calibri');
		// Setting font size to 14
		$phpExcel->getDefaultStyle()->getFont()->setSize(11);
		//Setting description, creator and title
		$phpExcel->getProperties()->setTitle("Availability Report");
		$phpExcel->getProperties()->setCreator("UMS");
		$phpExcel->getProperties()->setDescription("Network Availability Report");
		// Creating PHPExcel spreadsheet writer object
		// We will create xlsx file (Excel 2007 and above)
		$writer = PHPExcel_IOFactory::createWriter($phpExcel, "Excel2007");
		// When creating the writer object, the first sheet is also created


		// raw data sheets
		$shind = 1;
		for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";

			// prep raw data
			$raw_data = array();
			foreach (${$tvrname} as $site_id => $site_outs)
			{
				foreach ($site_outs["site"] as $site_out)
				{
					$site_out ["eot"] = "site";
					$site_out ["site_id"] = $site_id;

					$raw_data [] = $site_out;
				}
				
				foreach ($site_outs["cells"] as $cell_out)
				{
					$cell_out ["eot"] = "cell";
					$cell_out ["site_id"] = $site_id;

					$raw_data [] = $cell_out;
				}
			}

			// sort by running and sort by outages to DESC of time
			usort ($raw_data, function ($a, $b)
			{
				if( $b['running'] === $a['running'] )
				{
					if(@strtotime($a['start_time'])==@strtotime($b['start_time'])) return 0;
					return @strtotime($a['start_time']) < @strtotime($b['start_time'])?1:-1;
				}
				else
			    	return $b['running'] - $a['running'];
			});

			if( $i == 2)
			{
				// We will get the already created sheet
				$sheet = $phpExcel->getActiveSheet();
				// Setting title of the sheet
				$sheet->setTitle('2G Raw Data');
			}
			else
			{
				// Add new sheet
				$sheet = $phpExcel->createSheet($shind); //Setting index when creating
				$sheet->setTitle($i."G Raw Data");
				$shind++;
			}

			// Creating spreadsheet header
			// way 1 of setting cell value.
			$sheet->getCell('A1')->setValue('SN');
			$sheet->getCell('B1')->setValue('Site Code');
			$sheet->getCell('C1')->setValue('Priority');
			$sheet->getCell('D1')->setValue('Office');
			$sheet->getCell('E1')->setValue('MSD Office');
			$sheet->getCell('F1')->setValue('District');
			$sheet->getCell('G1')->setValue('Thana');
			$sheet->getCell('H1')->setValue('Metro & Non-Metro');
			$sheet->getCell('I1')->setValue('Commercial Zone');
			$sheet->getCell('J1')->setValue('Area');
			$sheet->getCell('K1')->setValue('Occurred Date');
			$sheet->getCell('L1')->setValue('Occurred Time');
			$sheet->getCell('M1')->setValue('Restored Date');
			$sheet->getCell('N1')->setValue('Restored Time');
			$sheet->getCell('O1')->setValue('Duration');
			$sheet->getCell('P1')->setValue('Downtime (Cell)');
			$sheet->getCell('Q1')->setValue('Category');
			$sheet->getCell('R1')->setValue('Cause');
			$sheet->getCell('S1')->setValue('Details');
			$sheet->getCell('T1')->setValue('Effect');
			$sheet->getCell('U1')->setValue('Action Taken');
			$sheet->getCell('V1')->setValue('Problem Status');
			$sheet->getCell('W1')->setValue('Action Required');
			$sheet->getCell('X1')->setValue('Dependency');
			$sheet->getCell('Y1')->setValue('Planned Date');
			$sheet->getCell('Z1')->setValue('Owner');
			$sheet->getCell('AA1')->setValue('Consideration for down');
			$sheet->getCell('AB1')->setValue('Entrence Prob Start Date');
			$sheet->getCell('AC1')->setValue('Entrence Prob Start Time');
			$sheet->getCell('AD1')->setValue('Entrence Prob End Date');
			$sheet->getCell('AE1')->setValue('Entrence Prob End Time');
			$sheet->getCell('AF1')->setValue('Duration for Access problem');
			$sheet->getCell('AG1')->setValue('Dependency Site ID');

			// Making headers text bold and larger
			$sheet->getStyle('A1:AG1')->getFont()->setBold(true)->setSize(12);

			$rin = 2;

			foreach ($raw_data as $outent)
			{
				if( isset($site_mem_resp->site_list[$outent["site_id"]]) )
				{
					$site = $site_mem_resp->site_list[$outent["site_id"]];
					$cellvn = "cell_".$i."g";
					$linkvn = "uplink_".$i."g";

					$sl = "";
					if( $i == 2 )
					{
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
							$sl = "Site";
						else
							$sl = "Micro BTS";
					}
					else
					{
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
							$sl = $i."G Site";
						else
							$sl = $i."G Micro BTS";
					}

					if( $outent["eot"] == "site" )
					{
						$sheet->setCellValue('A'.$rin, "".($rin-1));
						$sheet->setCellValue('B'.$rin, $outent["site_code"]);
						$sheet->setCellValue('C'.$rin, $site["site_priority"]);
						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$sheet->setCellValue('D'.$rin, $inhouse_lookup[$site["om_office_id"]]);
						}
						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
						{
							$sheet->setCellValue('E'.$rin, $msd_lookup[$site["msd_office_id"]]);
						}

						$sheet->setCellValue('F'.$rin, $site["district"]);
						$sheet->setCellValue('G'.$rin, $site["thana"]);
						$sheet->setCellValue('H'.$rin, $site["type_metro_or_non_metro"]);
						$sheet->setCellValue('I'.$rin, $site["commercial_zone"]);
						$sheet->setCellValue('J'.$rin, $site["zone"]);

						$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
						$sheet->getCell('K'.$rin)->setValue( $extime );
						$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

						$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
						$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

						if( !$outent["running"] )
						{
							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('M'.$rin)->setValue( $extime );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('N'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$t = @strtotime($outent["end_time"])-@strtotime($outent["start_time"]);

							if( $outent["fluctuation"] > 0 && sizeof($outent["fluc_ranges"]) > 0 )
							{
								$t = 0;
								foreach ($outent["fluc_ranges"] as $frange)
								{
									$t += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
								}
							}
							
							$sheet->setCellValue('O'.$rin, round($t/60, 2) );

							if( $site[$cellvn] != null && $site[$cellvn] > 0 )
							{
								$ct = round($t/60, 2) * $site[$cellvn];
								$sheet->setCellValue('P'.$rin, $ct );
							}
							else
							{
								$sheet->setCellValue('P'.$rin, "No cells found" );
							}
						}

						if( $outent["fluctuation"] > 0 )
						{
							$sheet->setCellValue('T'.$rin, $sl." Down (Fluctuating)");
						}
						else
						{
							$sheet->setCellValue('T'.$rin, $sl." Down");
						}

						if( $site[$linkvn] != null )
							$sheet->setCellValue('AG'.$rin, $site[$linkvn]);

						$rin++;
					}
					else if( $outent["eot"] == "cell" )
					{
						$sheet->setCellValue('A'.$rin, "".($rin-1));

						$sheet->setCellValue('B'.$rin, $outent["site_code"]);
						$sheet->setCellValue('C'.$rin, $site["site_priority"]);
						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$sheet->setCellValue('D'.$rin, $inhouse_lookup[$site["om_office_id"]]);
						}
						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
						{
							$sheet->setCellValue('E'.$rin, $msd_lookup[$site["msd_office_id"]]);
						}

						$sheet->setCellValue('F'.$rin, $site["district"]);
						$sheet->setCellValue('G'.$rin, $site["thana"]);
						$sheet->setCellValue('H'.$rin, $site["type_metro_or_non_metro"]);
						$sheet->setCellValue('I'.$rin, $site["commercial_zone"]);
						$sheet->setCellValue('J'.$rin, $site["zone"]);

						$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
						$sheet->getCell('K'.$rin)->setValue( $extime );
						$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

						$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
						$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

						if( !$outent["running"] )
						{
							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('M'.$rin)->setValue( $extime );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('N'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');


							$t = @strtotime($outent["end_time"])-@strtotime($outent["start_time"]);
							$sheet->setCellValue('O'.$rin, round($t/60, 2) );

							$fluc = false;
							$ct = 0;
							foreach ($outent["cells"] as $cocell)
							{
								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									$ctt = 0;
									foreach ($cocell["fluc_ranges"] as $frange)
									{
										$ctt += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
									}
									$ct = $ct + $ctt;
									$fluc = true;
								}
								else
								{
									$ct = $ct + ( @strtotime($cocell["end_time"])-@strtotime($cocell["start_time"]) );
								}
							}

							if( $fluc )
								$sheet->setCellValue('P'.$rin, round($ct/60, 2) );
							else
								$sheet->setCellValue('P'.$rin, round($t/60, 2)*sizeof($outent["cells"]) );
						}

						if( sizeof($outent["cells"]) > 0 )
						{
							$cellns = array();
							$fluc_cellns = array();
							foreach ($outent["cells"] as $cocell)
							{
								$cellns [] = $cocell["cell_name"];
								if( $cocell["fluctuation"] > 0 )
									$fluc_cellns [] = $cocell["cell_name"];

								if( sizeof($cellns) > 0 )
								{
									$effect = sizeof($cellns)." Cell Down (".implode(", ", $cellns).")";

									if( sizeof($fluc_cellns) > 0 )
									{
										$effect = $effect." (Fluctuating: ".implode(", ", $fluc_cellns).")";
									}
									if( $i == 2 )
										$sheet->setCellValue('T'.$rin, $effect);
									else
										$sheet->setCellValue('T'.$rin, $i."G ".$effect);
								}
								else
								{
									$sheet->setCellValue('T'.$rin, "No cells found");
								}
							}
						}
						else
						{
							$sheet->setCellValue('T'.$rin, "No cells found");
						}

						if( $site[$linkvn] != null )
							$sheet->setCellValue('AG'.$rin, $site[$linkvn]);

						$rin++;
					}
				}
			}

			unset($raw_data);
		}

		// BSS Down Sheets
		$flucs_sites = array();
		$swa_prob = array();
		for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";

			// prep bss data
			$bss_data = array();
			foreach (${$tvrname} as $site_id => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$site_id]) )
				{
					$site = $site_mem_resp->site_list[$site_id];

					$total_down_time = 0; // minutes
					$fluc_win1 = 0; // 6 am to 2 pm
					$fluc_win2 = 0; // 2 pm to 12 am
					foreach ($site_outs["site"] as $site_out)
					{
						$site_out ["eot"] = "site";
						$site_out ["site_id"] = $site_id;

						if( @strtotime($site_out["start_time"]) < @strtotime($start) )
							$site_out["start_time"] = $start;

						if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
						{
							foreach ($site_out["fluc_ranges"] as $fkey => $frange)
							{
								if( @strtotime($frange["start"]) < @strtotime($start) )
									$site_out["fluc_ranges"][$fkey]["start"] = $start;
							}
						}

						if( !$site_out["running"] )
						{
							if( @strtotime($site_out["start_time"]) >= @strtotime($sel_date." 06:00:00") && @strtotime($site_out["start_time"]) < @strtotime($sel_date." 14:00:00") )
							{
								$fluc_win1++;
							}
							else if(  @strtotime($site_out["start_time"]) >= @strtotime($sel_date." 14:00:00") && @strtotime($site_out["start_time"]) <= @strtotime($sel_date." 23:59:59") )
							{
								$fluc_win2++;
							}
						}

						if( !$site_out["running"] )
						{
							if( @strtotime($site_out["end_time"]) > @strtotime($end) )
								$site_out["end_time"] = $nds;

							if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
							{
								foreach ($site_out["fluc_ranges"] as $fkey => $frange)
								{
									if( @strtotime($frange["end"]) > @strtotime($end) )
										$site_out["fluc_ranges"][$fkey]["end"] = $nds;
								}
							}
						}
						else
						{
							$site_out["end_time"] = $nds;
						}

						$t = @strtotime($site_out["end_time"])-@strtotime($site_out["start_time"]);

						if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
						{
							$t = 0;
							foreach ($site_out["fluc_ranges"] as $frange)
							{
								$t += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
							}
						}

						if( $site["cell_".$i."g"] != null && $site["cell_".$i."g"] > 0 )
						{
							$total_down_time += (round($t/60, 2) * $site["cell_".$i."g"]);
						}

						$bss_data [] = $site_out;
					}

					if( $fluc_win1 > 5 || $fluc_win2 > 5 )
					{
						$fluck_ent = array();
						$fluck_ent["site_code"] = $site["site_code_".$i."g"];
						$fluck_ent["site_type"] = $i."G";
						$fluck_ent["priority"] = $site["site_priority"];
						$fluck_ent["office"] = null;
						$fluck_ent["msd_office"] = null;

						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
						{
							$fluck_ent["office"] = $inhouse_lookup[$site["om_office_id"]];
						}
						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
						{
							$fluck_ent["msd_office"] = $msd_lookup[$site["msd_office_id"]];
						}

						$fluck_ent["ro"] = $site["ro"];
						$fluck_ent["win1"] = $fluc_win1;
						$fluck_ent["win2"] = $fluc_win2;
						$flucs_sites [] = $fluck_ent;
					}

					foreach ($site_outs["cells"] as $cell_out)
					{
						$cell_out ["eot"] = "cell";
						$cell_out ["site_id"] = $site_id;

						if( @strtotime($cell_out["start_time"]) < @strtotime($start) )
							$cell_out["start_time"] = $start;

						// the calculation for downtime is done by indivisual cells
						if( !$cell_out["running"] )
						{
							if( @strtotime($cell_out["end_time"]) > @strtotime($end) )
								$cell_out["end_time"] = $nds;						
						}
						else
						{
							$cell_out["end_time"] = $nds;
						}

						// time normalization for cells
						foreach ($cell_out["cells"] as $cki => $cocell)
						{
							if( @strtotime($cocell["start_time"]) < @strtotime($start) )
								$cell_out["cells"][$cki]["start_time"] = $start;

							if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
							{
								foreach ($cocell["fluc_ranges"] as $fkey => $frange)
								{
									if( @strtotime($frange["start"]) < @strtotime($start) )
										$cell_out["cells"][$cki]["fluc_ranges"][$fkey]["start"] = $start;
								}
							}

							if( !$cocell["running"] )
							{
								if( @strtotime($cocell["end_time"]) > @strtotime($end) )
									$cell_out["cells"][$cki]["end_time"] = $nds;

								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									foreach ($cocell["fluc_ranges"] as $fkey => $frange)
									{
										if( @strtotime($frange["end"]) > @strtotime($end) )
											$cell_out["cells"][$cki]["fluc_ranges"][$fkey]["end"] = $nds;
									}
								}
							}
							else
							{
								$cell_out["cells"][$cki]["end_time"] = $nds;
							}
						}

						$t =  @strtotime($cell_out["end_time"])-@strtotime($cell_out["start_time"]);
						$fluc = false;
						$ct = 0;
						foreach ($cell_out["cells"] as $cocell)
						{
							if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
							{
								$ctt = 0;
								foreach ($cocell["fluc_ranges"] as $frange)
								{
									$ctt += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
								}
								$ct = $ct + $ctt;
								$fluc = true;
							}
							else
							{
								$ct = $ct + ( @strtotime($cocell["end_time"])-@strtotime($cocell["start_time"]) );
							}
						}

						if( $fluc )
							$total_down_time += round($ct/60, 2);
						else
							$total_down_time += ( round($t/60, 2)*sizeof($cell_out["cells"]) );

						$bss_data [] = $cell_out;
					}

					if( $total_down_time > 0 )
					{
						$swa_ent = array();
						$swa_ent["site_code"] = $site["site_code_".$i."g"];
						$swa_ent["down_time"] = $total_down_time;
						$swa_ent["cells"] = $site["cell_".$i."g"];
						$swa_ent["site_type"] = $i."G";
						$swa_prob [] = $swa_ent;
					}
				}
			}

			// sort by running and sort by outages to DESC
			usort ($bss_data, function ($a, $b)
			{
				if( $b['running'] === $a['running'] )
				{
					if(@strtotime($a['start_time'])==@strtotime($b['start_time'])) return 0;
					return @strtotime($a['start_time']) < @strtotime($b['start_time'])?1:-1;
				}
				else
			    	return $b['running'] - $a['running'];
			});


			// Add new sheet
			$sheet = $phpExcel->createSheet($shind); //Setting index when creating
			$sheet->setTitle($i."G BSS Down");
			$shind++;

			// Creating spreadsheet header
			// way 1 of setting cell value.
			$sheet->getCell('A1')->setValue('SN');

			if( $i == 2 )
				$sheet->getCell('B1')->setValue('BSC');
			if( $i == 3 )
				$sheet->getCell('B1')->setValue('RNC');

			if( $i == 2 || $i == 3 )
			{
				$sheet->getCell('C1')->setValue('Site Code');
				$sheet->getCell('D1')->setValue('Priority');
				$sheet->getCell('E1')->setValue('Office');
				$sheet->getCell('F1')->setValue('MSD Office');
				$sheet->getCell('G1')->setValue('District');
				$sheet->getCell('H1')->setValue('Thana');
				$sheet->getCell('I1')->setValue('Metro & Non-Metro');
				$sheet->getCell('J1')->setValue('Commercial Zone');
				$sheet->getCell('K1')->setValue('Area');
				$sheet->getCell('L1')->setValue('Occurred Date');
				$sheet->getCell('M1')->setValue('Occurred Time');
				$sheet->getCell('N1')->setValue('Restored Date');
				$sheet->getCell('O1')->setValue('Restored Time');
				$sheet->getCell('P1')->setValue('Duration');
				$sheet->getCell('Q1')->setValue('Downtime (Cell)');
				$sheet->getCell('R1')->setValue('Category');
				$sheet->getCell('S1')->setValue('Cause');
				$sheet->getCell('T1')->setValue('Details');
				$sheet->getCell('U1')->setValue('Effect');
				$sheet->getCell('V1')->setValue('Action Taken');
				$sheet->getCell('W1')->setValue('Problem Status');
				$sheet->getCell('X1')->setValue('Action Required');
				$sheet->getCell('Y1')->setValue('Dependency');
				$sheet->getCell('Z1')->setValue('Planned Date');
				$sheet->getCell('AA1')->setValue('Owner');
				$sheet->getCell('AB1')->setValue('Consideration for down');
				$sheet->getCell('AC1')->setValue('Entrence Prob Start Date');
				$sheet->getCell('AD1')->setValue('Entrence Prob Start Time');
				$sheet->getCell('AE1')->setValue('Entrence Prob End Date');
				$sheet->getCell('AF1')->setValue('Entrence Prob End Time');
				$sheet->getCell('AG1')->setValue('Duration for Access problem');
				$sheet->getCell('AH1')->setValue('Dependency Site ID');

				// Making headers text bold and larger
				$sheet->getStyle('A1:AH1')->getFont()->setBold(true)->setSize(12);
			}
			else
			{
				$sheet->getCell('B1')->setValue('Site Code');
				$sheet->getCell('C1')->setValue('Priority');
				$sheet->getCell('D1')->setValue('Office');
				$sheet->getCell('E1')->setValue('MSD Office');
				$sheet->getCell('F1')->setValue('District');
				$sheet->getCell('G1')->setValue('Thana');
				$sheet->getCell('H1')->setValue('Metro & Non-Metro');
				$sheet->getCell('I1')->setValue('Commercial Zone');
				$sheet->getCell('J1')->setValue('Area');
				$sheet->getCell('K1')->setValue('Occurred Date');
				$sheet->getCell('L1')->setValue('Occurred Time');
				$sheet->getCell('M1')->setValue('Restored Date');
				$sheet->getCell('N1')->setValue('Restored Time');
				$sheet->getCell('O1')->setValue('Duration');
				$sheet->getCell('P1')->setValue('Downtime (Cell)');
				$sheet->getCell('Q1')->setValue('Category');
				$sheet->getCell('R1')->setValue('Cause');
				$sheet->getCell('S1')->setValue('Details');
				$sheet->getCell('T1')->setValue('Effect');
				$sheet->getCell('U1')->setValue('Action Taken');
				$sheet->getCell('V1')->setValue('Problem Status');
				$sheet->getCell('W1')->setValue('Action Required');
				$sheet->getCell('X1')->setValue('Dependency');
				$sheet->getCell('Y1')->setValue('Planned Date');
				$sheet->getCell('Z1')->setValue('Owner');
				$sheet->getCell('AA1')->setValue('Consideration for down');
				$sheet->getCell('AB1')->setValue('Entrence Prob Start Date');
				$sheet->getCell('AC1')->setValue('Entrence Prob Start Time');
				$sheet->getCell('AD1')->setValue('Entrence Prob End Date');
				$sheet->getCell('AE1')->setValue('Entrence Prob End Time');
				$sheet->getCell('AF1')->setValue('Duration for Access problem');
				$sheet->getCell('AG1')->setValue('Dependency Site ID');

				// Making headers text bold and larger
				$sheet->getStyle('A1:AG1')->getFont()->setBold(true)->setSize(12);
			}
			

			$rin = 2;
			foreach ($bss_data as $outent)
			{
				if( isset($site_mem_resp->site_list[$outent["site_id"]]) )
				{
					$site = $site_mem_resp->site_list[$outent["site_id"]];
					$cellvn = "cell_".$i."g";
					$linkvn = "uplink_".$i."g";

					if( $outent["eot"] == "site" )
					{
						$sl = "";
						if( $i == 2 )
						{
							if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
								$sl = "Site";
							else
								$sl = "Micro BTS";
						}
						else
						{
							if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
								$sl = $i."G Site";
							else
								$sl = $i."G Micro BTS";
						}

						if( $i == 2 || $i == 3 )
						{
							$sheet->setCellValue('A'.$rin, "".($rin-1));
							if( $i == 2 )
								$sheet->setCellValue('B'.$rin, $site["bsc_2g"]);
							else if( $i == 3 )
								$sheet->setCellValue('B'.$rin, $site["rnc_3g"]);

							$sheet->setCellValue('C'.$rin, $outent["site_code"]);
							$sheet->setCellValue('D'.$rin, $site["site_priority"]);
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sheet->setCellValue('E'.$rin, $inhouse_lookup[$site["om_office_id"]]);
							}
							if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
							{
								$sheet->setCellValue('F'.$rin, $msd_lookup[$site["msd_office_id"]]);
							}

							$sheet->setCellValue('G'.$rin, $site["district"]);
							$sheet->setCellValue('H'.$rin, $site["thana"]);
							$sheet->setCellValue('I'.$rin, $site["type_metro_or_non_metro"]);
							$sheet->setCellValue('J'.$rin, $site["commercial_zone"]);
							$sheet->setCellValue('K'.$rin, $site["zone"]);

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
							$sheet->getCell('L'.$rin)->setValue( $extime );
							$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('M'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('N'.$rin)->setValue( $extime );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('O'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('O'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$t = @strtotime($outent["end_time"])-@strtotime($outent["start_time"]);

							if( $outent["fluctuation"] > 0 && sizeof($outent["fluc_ranges"]) > 0 )
							{
								$t = 0;
								foreach ($outent["fluc_ranges"] as $frange)
								{
									$t += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
								}
							}

							$sheet->setCellValue('P'.$rin, round($t/60, 2) );

							if( $site[$cellvn] != null && $site[$cellvn] > 0 )
							{
								$ct = round($t/60, 2) * $site[$cellvn];
								$sheet->setCellValue('Q'.$rin, $ct );
							}
							else
							{
								$sheet->setCellValue('Q'.$rin, "No cells found" );
							}

							if( $outent["fluctuation"] > 0 )
							{
								$sheet->setCellValue('U'.$rin, $sl." Down (Fluctuating)");
							}
							else
							{
								$sheet->setCellValue('U'.$rin, $sl." Down");
							}

							if( $site[$linkvn] != null )
								$sheet->setCellValue('AH'.$rin, $site[$linkvn]);

							$rin++;
						}
						else
						{
							$sheet->setCellValue('A'.$rin, "".($rin-1));
							$sheet->setCellValue('B'.$rin, $outent["site_code"]);
							$sheet->setCellValue('C'.$rin, $site["site_priority"]);
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sheet->setCellValue('D'.$rin, $inhouse_lookup[$site["om_office_id"]]);
							}
							if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
							{
								$sheet->setCellValue('E'.$rin, $msd_lookup[$site["msd_office_id"]]);
							}

							$sheet->setCellValue('F'.$rin, $site["district"]);
							$sheet->setCellValue('G'.$rin, $site["thana"]);
							$sheet->setCellValue('H'.$rin, $site["type_metro_or_non_metro"]);
							$sheet->setCellValue('I'.$rin, $site["commercial_zone"]);
							$sheet->setCellValue('J'.$rin, $site["zone"]);

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
							$sheet->getCell('K'.$rin)->setValue( $extime );
							$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('M'.$rin)->setValue( $extime );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('N'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$t = @strtotime($outent["end_time"])-@strtotime($outent["start_time"]);

							if( $outent["fluctuation"] > 0 && sizeof($outent["fluc_ranges"]) > 0 )
							{
								$t = 0;
								foreach ($outent["fluc_ranges"] as $frange)
								{
									$t += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
								}
							}

							$sheet->setCellValue('O'.$rin, round($t/60, 2) );

							if( $site[$cellvn] != null && $site[$cellvn] > 0 )
							{
								$ct = round($t/60, 2) * $site[$cellvn];
								$sheet->setCellValue('P'.$rin, $ct );
							}
							else
							{
								$sheet->setCellValue('P'.$rin, "No cells found" );
							}


							if( $outent["fluctuation"] > 0 )
							{
								$sheet->setCellValue('T'.$rin, $sl." Down (Fluctuating)");
							}
							else
							{
								$sheet->setCellValue('T'.$rin, $sl." Down");
							}

							if( $site[$linkvn] != null )
								$sheet->setCellValue('AG'.$rin, $site[$linkvn]);

							$rin++;
						}
					}
					else if( $outent["eot"] == "cell" )
					{
						if( $i == 2 || $i == 3 )
						{
							$sheet->setCellValue('A'.$rin, "".($rin-1));
							if( $i == 2 )
								$sheet->setCellValue('B'.$rin, $site["bsc_2g"]);
							else if( $i == 3 )
								$sheet->setCellValue('B'.$rin, $site["rnc_3g"]);

							$sheet->setCellValue('C'.$rin, $outent["site_code"]);
							$sheet->setCellValue('D'.$rin, $site["site_priority"]);
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sheet->setCellValue('E'.$rin, $inhouse_lookup[$site["om_office_id"]]);
							}
							if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
							{
								$sheet->setCellValue('F'.$rin, $msd_lookup[$site["msd_office_id"]]);
							}

							$sheet->setCellValue('G'.$rin, $site["district"]);
							$sheet->setCellValue('H'.$rin, $site["thana"]);
							$sheet->setCellValue('I'.$rin, $site["type_metro_or_non_metro"]);
							$sheet->setCellValue('J'.$rin, $site["commercial_zone"]);
							$sheet->setCellValue('K'.$rin, $site["zone"]);

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
							$sheet->getCell('L'.$rin)->setValue( $extime );
							$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('M'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('N'.$rin)->setValue( $extime );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('O'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('O'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$t =  @strtotime($outent["end_time"])-@strtotime($outent["start_time"]);
							$sheet->setCellValue('P'.$rin, round($t/60, 2) );

							$fluc = false;
							$ct = 0;
							foreach ($outent["cells"] as $cocell)
							{
								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									$ctt = 0;
									foreach ($cocell["fluc_ranges"] as $frange)
									{
										$ctt += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
									}
									$ct = $ct + $ctt;
									$fluc = true;
								}
								else
								{
									$ct = $ct + ( @strtotime($cocell["end_time"])-@strtotime($cocell["start_time"]) );
								}
							}

							if( $fluc )
								$sheet->setCellValue('Q'.$rin, round($ct/60, 2) );
							else
								$sheet->setCellValue('Q'.$rin, round($t/60, 2)*sizeof($outent["cells"]) );

							if( sizeof($outent["cells"]) > 0 )
							{
								$cellns = array();
								$fluc_cellns = array();
								foreach ($outent["cells"] as $cocell)
								{
									$cellns [] = $cocell["cell_name"];
									if( $cocell["fluctuation"] > 0 )
										$fluc_cellns [] = $cocell["cell_name"];

									if( sizeof($cellns) > 0 )
									{
										$effect = sizeof($cellns)." Cell Down (".implode(", ", $cellns).")";

										if( sizeof($fluc_cellns) > 0 )
										{
											$effect = $effect." (Fluctuating: ".implode(", ", $fluc_cellns).")";
										}
										if( $i == 2 )
											$sheet->setCellValue('U'.$rin, $effect);
										else
											$sheet->setCellValue('U'.$rin, $i."G ".$effect);
									}
									else
									{
										$sheet->setCellValue('U'.$rin, "No cells found");
									}
								}
							}
							else
							{
								$sheet->setCellValue('U'.$rin, "No cells found");
							}

							if( $site[$linkvn] != null )
								$sheet->setCellValue('AG'.$rin, $site[$linkvn]);

							$rin++;
						}
						else
						{
							$sheet->setCellValue('A'.$rin, "".($rin-1));

							$sheet->setCellValue('B'.$rin, $outent["site_code"]);
							$sheet->setCellValue('C'.$rin, $site["site_priority"]);
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sheet->setCellValue('D'.$rin, $inhouse_lookup[$site["om_office_id"]]);
							}
							if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
							{
								$sheet->setCellValue('E'.$rin, $msd_lookup[$site["msd_office_id"]]);
							}

							$sheet->setCellValue('F'.$rin, $site["district"]);
							$sheet->setCellValue('G'.$rin, $site["thana"]);
							$sheet->setCellValue('H'.$rin, $site["type_metro_or_non_metro"]);
							$sheet->setCellValue('I'.$rin, $site["commercial_zone"]);
							$sheet->setCellValue('J'.$rin, $site["zone"]);

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["start_time"])) );
							$sheet->getCell('K'.$rin)->setValue( $extime );
							$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outent["end_time"])) );
							$sheet->getCell('M'.$rin)->setValue( $extime );
							$sheet->getStyle('M'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

							$sheet->getCell('N'.$rin)->setValue( $extime - floor($extime) );
							$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

							$t = round( @strtotime($outent["end_time"])-@strtotime($outent["start_time"]) );
							$sheet->setCellValue('O'.$rin, round($t/60, 2) );

							$fluc = false;
							$ct = 0;
							foreach ($outent["cells"] as $cocell)
							{
								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									$ctt = 0;
									foreach ($cocell["fluc_ranges"] as $frange)
									{
										$ctt += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
									}
									$ct = $ct + $ctt;
									$fluc = true;
								}
								else
								{
									$ct = $ct + ( @strtotime($cocell["end_time"])-@strtotime($cocell["start_time"]) );
								}
							}

							if( $fluc )
								$sheet->setCellValue('P'.$rin, round($ct/60, 2) );
							else
								$sheet->setCellValue('P'.$rin, round($t/60, 2)*sizeof($outent["cells"]) );

							if( sizeof($outent["cells"]) > 0 )
							{
								$cellns = array();
								$fluc_cellns = array();
								foreach ($outent["cells"] as $cocell)
								{
									$cellns [] = $cocell["cell_name"];
									if( $cocell["fluctuation"] > 0 )
										$fluc_cellns [] = $cocell["cell_name"];

									if( sizeof($cellns) > 0 )
									{
										$effect = sizeof($cellns)." Cell Down (".implode(", ", $cellns).")";

										if( sizeof($fluc_cellns) > 0 )
										{
											$effect = $effect." (Fluctuating: ".implode(", ", $fluc_cellns).")";
										}
										$sheet->setCellValue('T'.$rin, $effect);
									}
									else
									{
										$sheet->setCellValue('T'.$rin, "No cells found");
									}
								}
							}
							else
							{
								$sheet->setCellValue('T'.$rin, "No cells found");
							}

							if( $site[$linkvn] != null )
								$sheet->setCellValue('AG'.$rin, $site[$linkvn]);

							$rin++;
						}
					}
				}
			}

			unset($bss_data);
		}

		usort($flucs_sites, function($a, $b)
		{
			if( ($a['win1']+$a["win2"]) == ($b['win1']+$b["win2"]) ) return 0;
			return ( ($a['win1']+$a["win2"]) < ($b['win1']+$b["win2"]) )?1:-1;
		});

		// Add new sheet
		$sheet = $phpExcel->createSheet($shind); //Setting index when creating
		$sheet->setTitle("Fluctuated Sites (>5 times)");
		$shind++;

		$sheet->getCell('A1')->setValue('Site Code');
		$sheet->getCell('B1')->setValue('Site Type');
		$sheet->getCell('C1')->setValue('Priority');
		$sheet->getCell('D1')->setValue('Office');
		$sheet->getCell('E1')->setValue('MSD Office');
		$sheet->getCell('F1')->setValue('RO');
		$sheet->getCell('G1')->setValue('Frequency 6AM-2PM');
		$sheet->getCell('H1')->setValue('Frequency 2PM-12AM');

		$sheet->getStyle('A1:H1')->getFont()->setBold(true)->setSize(12);

		$rin = 2;
		foreach ($flucs_sites as $flsi)
		{
			$sheet->setCellValue('A'.$rin, $flsi["site_code"]);
			$sheet->setCellValue('B'.$rin, $flsi["site_type"]);
			$sheet->setCellValue('C'.$rin, $flsi["priority"]);
			$sheet->setCellValue('D'.$rin, $flsi["office"]);
			$sheet->setCellValue('E'.$rin, $flsi["msd_office"]);
			$sheet->setCellValue('F'.$rin, $flsi["ro"]);
			$sheet->setCellValue('G'.$rin, $flsi["win1"]);
			$sheet->setCellValue('H'.$rin, $flsi["win2"]);
			$rin++;
		}

		unset($flucs_sites);


		// Already sorted by Generation
		// Add new sheet
		$sheet = $phpExcel->createSheet($shind); //Setting index when creating
		$sheet->setTitle("SWA(Probable)");
		$shind++;

		$sheet->getCell('A1')->setValue('Site ID');
		$sheet->getCell('B1')->setValue('Cell');
		$sheet->getCell('C1')->setValue('Downtime');
		$sheet->getCell('D1')->setValue('Availability');
		$sheet->getCell('E1')->setValue('Site Type');

		$sheet->getStyle('A1:E1')->getFont()->setBold(true)->setSize(12);

		$rin = 2;
		foreach ($swa_prob as $sbs)
		{
			$sheet->setCellValue('A'.$rin, $sbs["site_code"]);
			$sheet->setCellValue('C'.$rin, $sbs["down_time"]);

			if( $sbs["cells"] != null && $sbs["cells"] > 0 )
			{
				$sheet->setCellValue('B'.$rin, $sbs["cells"]);
				$sheet->setCellValue('D'.$rin, "=1-(C".$rin."/(B".$rin."*1440))");
				$sheet->getStyle('D'.$rin)->getNumberFormat()->applyFromArray( 
			        array(
			            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
			        )
			    );
			}
			else
			{
				$sheet->setCellValue('B'.$rin, "No cells found");
				$sheet->setCellValue('D'.$rin, "");
			}

			$sheet->setCellValue('E'.$rin, $sbs["site_type"]);
			$rin++;
		}

		unset($swa_prob);


		for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";

			$globals = array();
			$globals["global"] = array("cell"=>0, "downtime"=>0);
			$globals["macro_bts"] = array("cell"=>0, "downtime"=>0);
			$globals["micro_bts"] = array("cell"=>0, "downtime"=>0);

			$regions = array(
				'BARISHAL',
				'CHATTOGRAM',
				'DHAKA',
				'KHULNA',
				'RAJSHAHI',
				'SYLHET',
				'RANGPUR',
				'MYMENSINGH',
			);

			$reg_counts = array();
			foreach ($regions as $reg)
			{
				$reg_counts [$reg] = array("cell"=>0, "downtime"=>0);
			}

			// $priority = array(
			// 	'Platinum-P1',
			// 	'Gold-P1',
			// 	'P2',
			// 	'P3',
			// 	'Total',
			// );

			$priority_counts = array();
			$priority_counts['Total'] = array("cell"=>0, "downtime"=>0);
			// foreach ($priority as $pr)
			// {
			// 	$priority_counts [$pr] = array("cell"=>0, "downtime"=>0);
			// }

			$ofc_counts = array();

			foreach ($om_ofc_resp->data as $key => $om_ofc)
			{
				if( $om_ofc->office_type_id == 1 && $om_ofc->ro != null )
				{
					$ofc_counts [$om_ofc->id] = array("cell"=>0, "downtime"=>0, "ro"=>$om_ofc->ro);
				}
			}

			$districts = array();

			foreach ($site_mem_resp->site_list as $sid => $site)
			{
				if( $site["cell_".$i."g"] != null && $site["cell_".$i."g"] > 0 )
				{
					$globals["global"]["cell"] += $site["cell_".$i."g"];

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					{
						$globals["macro_bts"]["cell"] += $site["cell_".$i."g"];
					}
					else
					{
						$globals["micro_bts"]["cell"] += $site["cell_".$i."g"];
					}

					if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
					{
						$reg_counts [$site["zone"]]["cell"] += $site["cell_".$i."g"];
					}

					if( $site["site_priority"] != null )
					{
						if( !isset($priority_counts[$site["site_priority"]]) )
						{
							$priority_counts[$site["site_priority"]] = array("cell"=>0, "downtime"=>0);
						}

						$priority_counts [$site["site_priority"]]["cell"] += $site["cell_".$i."g"];
						$priority_counts ['Total']["cell"] += $site["cell_".$i."g"];
					}

					if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
					{
						$ofc_counts [$site["om_office_id"]]["cell"] += $site["cell_".$i."g"];
					}

					if( $site["district"] != null )
					{
						if( !isset($districts[$site["district"]]) )
						{
							$districts [$site["district"]] = array("cell"=>0, "downtime"=>0);
						}

						$districts [$site["district"]]["cell"] += $site["cell_".$i."g"];
					}
				}
			}
			
			// prep probable availability data from 
			foreach (${$tvrname} as $site_id => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$site_id]) )
				{
					$site = $site_mem_resp->site_list[$site_id];

					if( $site["site_code_".$i."g"] != null )
					{
						$total_down_time = 0;
						foreach ($site_outs["site"] as $site_out)
						{
							if( @strtotime($site_out["start_time"]) < @strtotime($start) )
								$site_out["start_time"] = $start;

							if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
							{
								foreach ($site_out["fluc_ranges"] as $fkey => $frange)
								{
									if( @strtotime($frange["start"]) < @strtotime($start) )
										$site_out["fluc_ranges"][$fkey]["start"] = $start;
								}
							}

							if( !$site_out["running"] )
							{
								if( @strtotime($site_out["end_time"]) > @strtotime($end) )
									$site_out["end_time"] = $nds;

								if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
								{
									foreach ($site_out["fluc_ranges"] as $fkey => $frange)
									{
										if( @strtotime($frange["end"]) > @strtotime($end) )
											$site_out["fluc_ranges"][$fkey]["end"] = $nds;
									}
								}
							}
							else
							{
								$site_out["end_time"] = $nds;
							}

							$t = @strtotime($site_out["end_time"])-@strtotime($site_out["start_time"]);

							if( $site_out["fluctuation"] > 0 && sizeof($site_out["fluc_ranges"]) > 0 )
							{
								$t = 0;
								foreach ($site_out["fluc_ranges"] as $frange)
								{
									$t += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
								}
							}

							if( $site["cell_".$i."g"] != null && $site["cell_".$i."g"] > 0 )
							{
								$total_down_time += round($t/60, 2) * $site["cell_".$i."g"];
							}
						}

						foreach ($site_outs["cells"] as $cell_out)
						{
							if( @strtotime($cell_out["start_time"]) < @strtotime($start) )
								$cell_out["start_time"] = $start;

							// the calculation for downtime is done by indivisual cells
							if( !$cell_out["running"] )
							{
								if( @strtotime($cell_out["end_time"]) > @strtotime($end) )
									$cell_out["end_time"] = $nds;						
							}
							else
							{
								$cell_out["end_time"] = $nds;
							}

							// time normalization for cells
							foreach ($cell_out["cells"] as $cki => $cocell)
							{
								if( @strtotime($cocell["start_time"]) < @strtotime($start) )
									$cell_out["cells"][$cki]["start_time"] = $start;

								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									foreach ($cocell["fluc_ranges"] as $fkey => $frange)
									{
										if( $frange["start"] > @strtotime($start) )
											$cell_out["cells"][$cki]["fluc_ranges"][$fkey]["start"] = $start;
									}
								}

								if( !$cocell["running"] )
								{
									if( @strtotime($cocell["end_time"]) > @strtotime($end) )
										$cell_out["cells"][$cki]["end_time"] = $nds;

									if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
									{
										foreach ($cocell["fluc_ranges"] as $fkey => $frange)
										{
											if( $frange["end"] > @strtotime($end) )
												$cell_out["cells"][$cki]["fluc_ranges"][$fkey]["end"] = $nds;
										}
									}
								}
								else
								{
									$cell_out["cells"][$cki]["end_time"] = $nds;
								}
							}

							$t = round( @strtotime($cell_out["end_time"])-@strtotime($cell_out["start_time"]) );

							$fluc = false;
							$ct = 0;
							foreach ($cell_out["cells"] as $cocell)
							{
								if( $cocell["fluctuation"] > 0 && sizeof($cocell["fluc_ranges"]) > 0 )
								{
									$ctt = 0;
									foreach ($cocell["fluc_ranges"] as $frange)
									{
										$ctt += ( @strtotime($frange["end"])-@strtotime($frange["start"]) );
									}
									$ct = $ct + $ctt;
									$fluc = true;
								}
								else
								{
									$ct = $ct + ( @strtotime($cocell["end_time"])-@strtotime($cocell["start_time"]) );
								}
							}

							if( $fluc )
								$total_down_time += round($ct/60, 2);
							else
								$total_down_time += (round($t/60, 2)*sizeof($cell_out["cells"]));
						}




						$globals["global"]["downtime"] += $total_down_time;

						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						{
							$globals["macro_bts"]["downtime"] += $total_down_time;
						}
						else
						{
							$globals["micro_bts"]["downtime"] += $total_down_time;
						}

						if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
						{
							$reg_counts [$site["zone"]]["downtime"] += $total_down_time;
						}

						if( $site["site_priority"] != null && isset($priority_counts[$site["site_priority"]]) )
						{
							$priority_counts [$site["site_priority"]]["downtime"] += $total_down_time;
							$priority_counts ['Total']["downtime"] += $total_down_time;
						}

						if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
						{
							$ofc_counts [$site["om_office_id"]]["downtime"] += $total_down_time;
						}

						if( $site["district"] != null )
						{
							if( isset($districts[$site["district"]]) )
							{
								$districts [$site["district"]]["downtime"] += $total_down_time;
							}							
						}
					}
				}
			}

			foreach ($districts as $dk => $dd)
			{
				$districts [$dk]["availability"] = NetworkAvailabilityHelper::get_availability($dd["cell"], $dd["downtime"]);
			}

			// sort by outages to DESC
			uasort($districts, function($a, $b)
			{
				if($a['availability']==$b['availability']) return 0;
				return $a['availability'] > $b['availability']?1:-1;
			});

			ksort($priority_counts);

			$ro_ofc_counts = array();
			foreach ($ofc_counts as $ofc_id => $ofc_count)
			{
				// if( isset($inhouse_lookup[$ofc_id]) && $ofc_count["ro"] != null && $ofc_count["cell"] > 0 && $ofc_count["downtime"] > 0 )
				if( isset($inhouse_lookup[$ofc_id]) && $ofc_count["ro"] != null )
				{
					if( !isset($ro_ofc_counts[$ofc_count["ro"]]) )
						$ro_ofc_counts[$ofc_count["ro"]] = array();

					$ofc_obj = array();
					$ofc_obj["name"] = $inhouse_lookup[$ofc_id];
					$ofc_obj["cell"] = $ofc_count["cell"];
					$ofc_obj["downtime"] = $ofc_count["downtime"];

					$ro_ofc_counts[$ofc_count["ro"]] [] = $ofc_obj;
				}
			}

			// Add new sheet
			$sheet = $phpExcel->createSheet($shind); //Setting index when creating
			$sheet->setTitle("Probable Availability ".$i."G");
			$shind++;

			$sheet->mergeCells('B2:B3');
			$sheet->setCellValue( 'B2', "Global");

			$sheet->setCellValue( 'C2', "Cell");
			$sheet->setCellValue( 'D2', "Downtime");
			$sheet->setCellValue( 'E2', "Availability");

			$sheet->setCellValue( 'C3', $globals["global"]["cell"]);
			$sheet->setCellValue( 'D3', $globals["global"]["downtime"]);
			$sheet->setCellValue( 'E3', "=1-(D3/(C3*1440))");
			$sheet->getStyle('E3')->getNumberFormat()->applyFromArray( 
		        array(
		            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
		        )
		    );

			$sheet->getStyle('B2:E2')->getFont()->setBold(true)->setSize(12);

			$sheet->mergeCells('B5:B6');
			$sheet->setCellValue( 'B5', "Macro BTS");

			$sheet->setCellValue( 'C5', "Cell");
			$sheet->setCellValue( 'D5', "Downtime");
			$sheet->setCellValue( 'E5', "Availability");

			$sheet->setCellValue( 'C6', $globals["macro_bts"]["cell"]);
			$sheet->setCellValue( 'D6', $globals["macro_bts"]["downtime"]);
			$sheet->setCellValue( 'E6', "=1-(D6/(C6*1440))" );
			$sheet->getStyle('E6')->getNumberFormat()->applyFromArray( 
		        array(
		            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
		        )
		    );

			$sheet->getStyle('B5:E5')->getFont()->setBold(true)->setSize(12);

			$sheet->mergeCells('B8:B9');
			$sheet->setCellValue( 'B8', "Micro BTS");

			$sheet->setCellValue( 'C8', "Cell");
			$sheet->setCellValue( 'D8', "Downtime");
			$sheet->setCellValue( 'E8', "Availability");

			$sheet->setCellValue( 'C9', $globals["micro_bts"]["cell"]);
			$sheet->setCellValue( 'D9', $globals["micro_bts"]["downtime"]); 
			$sheet->setCellValue( 'E9', "=1-(D9/(C9*1440))" );
			$sheet->getStyle('E9')->getNumberFormat()->applyFromArray( 
		        array(
		            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
		        )
		    );

			$sheet->getStyle('B8:E8')->getFont()->setBold(true)->setSize(12);


			$sheet->mergeCells('B12:E12');
			$sheet->setCellValue( 'B12', "Zonal Availability");
			$sheet->getStyle('B12')->getFont()->setBold(true)->setSize(13);

			$sheet->setCellValue( 'B13', "Zone");
			$sheet->setCellValue( 'C13', "Cell");
			$sheet->setCellValue( 'D13', "Downtime");
			$sheet->setCellValue( 'E13', "Availability");
			$sheet->getStyle('B13:E13')->getFont()->setBold(true)->setSize(12);

			$rin = 14;
			foreach ($reg_counts as $reg => $regd)
			{
				$sheet->setCellValue( 'B'.$rin , $reg);
				$sheet->setCellValue( 'C'.$rin , $regd["cell"]);
				$sheet->setCellValue( 'D'.$rin , $regd["downtime"]);
				$sheet->setCellValue( 'E'.$rin , "=1-(D$rin/(C$rin*1440))" );
				$sheet->getStyle('E'.$rin)->getNumberFormat()->applyFromArray( 
			        array(
			            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
			        )
			    );
				$rin++;
			}

			$rin += 2;

			$sheet->mergeCells("B$rin:E$rin");
			$sheet->setCellValue( "B$rin", "Priority Availability");
			$sheet->getStyle("B$rin")->getFont()->setBold(true)->setSize(13);
			$rin += 1;
			$sheet->setCellValue( "B$rin", "Priority");
			$sheet->setCellValue( "C$rin", "Cell");
			$sheet->setCellValue( "D$rin", "Downtime");
			$sheet->setCellValue( "E$rin", "Availability");
			$sheet->getStyle("B$rin:E$rin")->getFont()->setBold(true)->setSize(12);
			$rin += 1;
			foreach ($priority_counts as $pr => $prd)
			{
				$sheet->setCellValue( "B".$rin , $pr);
				$sheet->setCellValue( "C".$rin , $prd["cell"]);
				$sheet->setCellValue( "D".$rin , $prd["downtime"]);
				$sheet->setCellValue( "E".$rin , "=1-(D$rin/(C$rin*1440))" );
				$sheet->getStyle('E'.$rin)->getNumberFormat()->applyFromArray( 
			        array(
			            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
			        )
			    );
				$rin++;
			}

			$rin += 2;

			$sheet->mergeCells("B$rin:E$rin");
			$sheet->setCellValue( "B$rin", "Office Wise Availability");
			$sheet->getStyle("B$rin")->getFont()->setBold(true)->setSize(13);
			$rin += 1;
			$sheet->setCellValue( "B$rin", "Office");
			$sheet->setCellValue( "C$rin", "Cell");
			$sheet->setCellValue( "D$rin", "Downtime");
			$sheet->setCellValue( "E$rin", "Availability");
			$sheet->getStyle("B$rin:E$rin")->getFont()->setBold(true)->setSize(12);
			$rin += 1;

			ksort($ro_ofc_counts);
			foreach ($ro_ofc_counts as $ro_name => $ofcs)
			{
				$sheet->mergeCells("A".$rin.":A".($rin+sizeof($ofcs)-1) );
				$sheet->setCellValue("A".$rin, $ro_name);

				foreach ($ofcs as $ofc)
				{
					$sheet->setCellValue( "B".$rin , $ofc["name"]);
					$sheet->setCellValue( "C".$rin , $ofc["cell"]);
					$sheet->setCellValue( "D".$rin , $ofc["downtime"]);
					$sheet->setCellValue( "E".$rin , "=1-(D$rin/(C$rin*1440))" );
					$sheet->getStyle('E'.$rin)->getNumberFormat()->applyFromArray( 
				        array(
				            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
				        )
				    );
					$rin++;
				}
			}


			$rin += 2;

			$sheet->mergeCells("B$rin:E$rin");
			$sheet->setCellValue( "B$rin", "Worst District-wise Availability");
			$sheet->getStyle("B$rin")->getFont()->setBold(true)->setSize(13);
			$rin += 1;
			$sheet->setCellValue( "B$rin", "District");
			$sheet->setCellValue( "C$rin", "Cell");
			$sheet->setCellValue( "D$rin", "Downtime");
			$sheet->setCellValue( "E$rin", "Availability");
			$sheet->getStyle("B$rin:E$rin")->getFont()->setBold(true)->setSize(12);
			$rin += 1;
			foreach ($districts as $drn => $drd)
			{
				// if( $drd["cell"] > 0 && $drd["downtime"] > 0 )
				// {
					$sheet->setCellValue( "B".$rin , $drn);
					$sheet->setCellValue( "C".$rin , $drd["cell"]);
					$sheet->setCellValue( "D".$rin , $drd["downtime"]);
					$sheet->setCellValue( "E".$rin , "=1-(D$rin/(C$rin*1440))" );
					$sheet->getStyle('E'.$rin)->getNumberFormat()->applyFromArray( 
				        array(
				            'code' => PHPExcel_Style_NumberFormat::FORMAT_PERCENTAGE_00
				        )
				    );
					$rin++;
				// }
			}

			$sheet->getColumnDimension('A')->setAutoSize(true);
			$sheet->getColumnDimension('B')->setAutoSize(true);
			$sheet->getColumnDimension('C')->setAutoSize(true);
			$sheet->getColumnDimension('D')->setAutoSize(true);
			$sheet->getColumnDimension('E')->setAutoSize(true);
		}

		$phpExcel->setActiveSheetIndex(0);

		//Write cells
		// way 2 of setting cell value.
      	// $objWorkSheet->setCellValue('A1', 'Hello')
	      //              ->setCellValue('B2', 'world!')
	      //              ->setCellValue('C1', 'Hello')
	      //              ->setCellValue('D2', 'world!');

		// Autosize the columns
		// $sheet->getColumnDimension('A')->setAutoSize(true);
		// $sheet->getColumnDimension('B')->setAutoSize(true);
		// $sheet->getColumnDimension('C')->setAutoSize(true);

       	$filename = "availability_report_" . date("Y-m-d", @strtotime($sel_date)) . ".xlsx";

	    header('Content-Type: application/vnd.ms-excel');
	    header('Content-Disposition: attachment;filename="'.$filename.'"');
	    header('Cache-Control: max-age=0');
	    // $writer->setPreCalculateFormulas();
	    $writer->save('php://output');
	    // $writer->save('/data/ums/htdocs-ums/tmp_file.xlsx');
	}

	// Hourly SMS report Stuff
	public function actionReportBasicEntry($date)
	{
		$sel_date = date("Y-m-d", @strtotime("-1 days"));
		if( $date == null || @trim($date) == "" )
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}

		if( $this->validateDate($date, 'd/m/Y') )
		{
			$pd = DateTime::createFromFormat('d/m/Y', $date);
			$sel_date = $pd->format('Y-m-d');

			if( @strtotime($sel_date) > @strtotime(date("Y-m-d")) )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Date Provided. Please Provide a date for today or Earlier."
				));
				Yii::app()->end();
			}
		}
		else
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}

		session_write_close();

		// day wise per hour report.
		require_once (Yii::app()->basePath.'/extensions/PHPExcel-1.8/Classes/PHPExcel.php');

		ini_set('max_execution_time', 300); // 5 minutes
		ini_set("memory_limit", "-1");

		$site_mem_resp = MemHelper::get_site_list();
		if(!$site_mem_resp->success)
			throw new CHttpException(500, "Error Getting Mem Site List: ".$site_mem_resp->message);

		$now = time();
		$this_hour = date("Y-m-d H:00:00", $now); // so that we donot show data more then this.

		$start = $sel_date." 00:00:00";
		$end = $sel_date." 23:59:59";

		$huawei_id = Yii::app()->params["vendor_lookup"]["huawei"];
		$zte_id = Yii::app()->params["vendor_lookup"]["zte"];
		$nokia_id = Yii::app()->params["vendor_lookup"]["nokia"];

		// last parameter is to skip the check for suppressing type2 outages as we are only using instantaneous analysis here
		$outages = NetworkAvailabilityHelper::getDurationOutages($start, $end, $site_mem_resp, true, true);

		$emslkp = Yii::app()->params["tech_lookup_txt"];
		$ran_emss = array();
		foreach ($emslkp as $tech_id => $domain)
		{
			if( $domain == "RAN" )
				$ran_emss [] = $tech_id;
		}
		$tech_ems_cond = " FALSE ";
		if( sizeof($ran_emss) > 0 )
			$tech_ems_cond = " t.technology_id IN (".implode(",", $ran_emss).") ";

		$actpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.alarm_raised_time, NULL AS alarm_cleared_time_ums, TRUE AS active
		FROM alarm t Where t.entity_type IS NOT NULL
		AND t.entity_type = 1
		AND $tech_ems_cond
		AND t.entity_id IS NOT NULL
		AND t.entity_id != -1
		AND t.vendor_id IS NOT NULL
		AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
		AND t.alarm_raised_time IS NOT NULL
		AND t.alarm_raised_time <= '$end'::timestamp without time zone
		AND (
			lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON'
		);
		")->queryAll();

		$logpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.alarm_raised_time, t.alarm_cleared_time_ums, FALSE AS active
		FROM log t Where t.entity_type IS NOT NULL
		AND t.entity_type = 1
		AND $tech_ems_cond
		AND t.entity_id IS NOT NULL
		AND t.entity_id != -1
		AND t.vendor_id IS NOT NULL
		AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
		AND t.alarm_raised_time IS NOT NULL
		AND t.alarm_raised_time <= '$end'::timestamp without time zone 
		AND t.alarm_cleared_time_ums IS NOT NULL
		AND t.alarm_cleared_time_ums >= '$start'::timestamp without time zone 
		AND (
			lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON'
		);
		")->queryAll();

		$phpExcel = new PHPExcel;
		// Setting font to Arial Black
		$phpExcel->getDefaultStyle()->getFont()->setName('Calibri');
		// Setting font size to 14
		$phpExcel->getDefaultStyle()->getFont()->setSize(11);
		//Setting description, creator and title
		$phpExcel->getProperties()->setTitle("Hourly SMS Report");
		$phpExcel->getProperties()->setCreator("UMS");
		$phpExcel->getProperties()->setDescription("Hourly SMS Report");
		// Creating PHPExcel spreadsheet writer object
		// We will create xlsx file (Excel 2007 and above)
		$writer = PHPExcel_IOFactory::createWriter($phpExcel, "Excel2007");
		// When creating the writer object, the first sheet is also created

		$sheet = $phpExcel->getActiveSheet();
		$sheet->setTitle('BasicEntry');

		$sheet->getCell('A1')->setValue('Date');
		$sheet->getCell('B1')->setValue('Time');
		$sheet->mergeCells('C1:F1');
		$sheet->setCellValue( 'C1', '2G');
		$sheet->mergeCells('G1:J1');
		$sheet->setCellValue( 'G1', '3G');
		$sheet->getCell('K1')->setValue('CP+DG Sites count');
		$sheet->getCell('K1')->setValue('(2G+3G)');
		$sheet->mergeCells('M1:U1');
		$sheet->setCellValue( 'M1', 'Other Operators');
		$sheet->mergeCells('V1:X1');
		$sheet->setCellValue( 'V1', 'Mains Fail');
		$sheet->mergeCells('Y1:AA1');
		$sheet->setCellValue( 'T1', 'In-House 2G');
		$sheet->mergeCells('AB1:AD1');
		$sheet->setCellValue( 'AB1', 'In-House 3G');
		$sheet->mergeCells('AE1:AG1');
		$sheet->setCellValue( 'AE1', 'FLM 2G');
		$sheet->mergeCells('AH1:AJ1');
		$sheet->setCellValue( 'AH1', 'FLM 3G');
		$sheet->mergeCells('AK1:AL1');
		$sheet->setCellValue( 'AK1', '2G');
		$sheet->mergeCells('AM1:AN1');
		$sheet->setCellValue( 'AM1', '3G');

		$sheet->getCell('A2')->setValue('Date');
		$sheet->getCell('B2')->setValue('Hours');
		$sheet->getCell('C2')->setValue('P1');
		$sheet->getCell('D2')->setValue('P2');
		$sheet->getCell('E2')->setValue('P3');
		$sheet->getCell('F2')->setValue('Total');
		$sheet->getCell('G2')->setValue('P1');
		$sheet->getCell('H2')->setValue('P2');
		$sheet->getCell('I2')->setValue('P3');
		$sheet->getCell('J2')->setValue('Total');
		$sheet->getCell('K2')->setValue('2G(CP+DG)');
		$sheet->getCell('L2')->setValue('>4 Hrs');
		$sheet->getCell('M2')->setValue('GP');
		$sheet->getCell('N2')->setValue('Robi');
		$sheet->getCell('O2')->setValue('Airtel');
		$sheet->getCell('P2')->setValue('STL');
		$sheet->getCell('Q2')->setValue('E.Co');
		$sheet->getCell('R2')->setValue('FTB');
		$sheet->getCell('S2')->setValue('KTBL');
		$sheet->getCell('T2')->setValue('BTCL');
		$sheet->getCell('U2')->setValue('Total');
		$sheet->getCell('V2')->setValue('Inhouse');
		$sheet->getCell('W2')->setValue('FLM');
		$sheet->getCell('X2')->setValue('Total');
		$sheet->getCell('Y2')->setValue('P1');
		$sheet->getCell('Z2')->setValue('P2');
		$sheet->getCell('AA2')->setValue('P3');
		$sheet->getCell('AB2')->setValue('P1');
		$sheet->getCell('AC2')->setValue('P2');
		$sheet->getCell('AD2')->setValue('P3');
		$sheet->getCell('AE2')->setValue('P1');
		$sheet->getCell('AF2')->setValue('P2');
		$sheet->getCell('AG2')->setValue('P3');
		$sheet->getCell('AH2')->setValue('P1');
		$sheet->getCell('AI2')->setValue('P2');
		$sheet->getCell('AJ2')->setValue('P3');
		$sheet->getCell('AK2')->setValue('In-House');
		$sheet->getCell('AL2')->setValue('FLM1 (Huawei)');
		$sheet->getCell('AM2')->setValue('In-House');
		$sheet->getCell('AN2')->setValue('FLM1 (Huawei)');

		$sheet->getStyle('A1:AN2')->getFont()->setBold(true)->setSize(12);

		$ha_style = array(
	        'alignment' => array(
	            'horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER,
	        )
	    );

    	$sheet->getStyle("A1:AN2")->applyFromArray($ha_style);

		$rin = 3;
		for ($h=0; $h < 24; $h++)
		{
			if( $h < 10)
				$thtime = $sel_date." 0$h:00:00";
			else
				$thtime = $sel_date." $h:00:00";

			if( @strtotime($thtime) <= @strtotime($this_hour) )
			{
				$thsts = @strtotime($thtime);

				$power_sites = array();

				foreach ($actpowers as $pal)
				{
					if( @strtotime($pal["alarm_raised_time"]) <= $thsts )
					{
						if( !isset($power_sites[$pal['psid']]) )
							$power_sites [$pal['psid']] = $pal;
					}
				}

				foreach ($logpowers as $plg)
				{
					if( @strtotime($plg["alarm_raised_time"]) <= $thsts && @strtotime($plg["alarm_cleared_time_ums"]) >= $thsts )
					{
						if( !isset($power_sites[$plg['psid']]) )
							$power_sites [$plg['psid']] = $plg;
					}
				}

				$site_2go_ids = array();
				$site_3go_ids = array();

				foreach ($outages as $outage)
				{
					$onact = false;
					if( $outage["running"] )
					{
						if( @strtotime($outage["start_time"]) <= $thsts )
							$onact = true;
					}
					else
					{
						if( @strtotime($outage["start_time"]) <= $thsts && @strtotime($outage["end_time"]) >= $thsts )
							$onact = true;
					}

					if( $onact )
					{
						if( $outage["technology"] == "2G" )
						{
							if( ($outage["type"] == "site" || $outage["type"] == "site_by_cell") && !isset($site_2go_ids[$outage["site_id"]]) )
							{
								$site_2go_ids [$outage["site_id"]] = $outage;
							}
						}
						else if( $outage["technology"] == "3G" )
						{
							if( ($outage["type"] == "site" || $outage["type"] == "site_by_cell") && !isset($site_3go_ids[$outage["site_id"]]) )
							{
								$site_3go_ids [$outage["site_id"]] = $outage;
							}
						}
					}
				}

				$counts = array();
				$counts["2g"] = array("p1"=>0,"p2"=>0,"p3"=>0,"g4h"=>0,"ih"=>0,"flm1huawei"=>0); //flm1huawei = msd for now
				$counts["3g"] = array("p1"=>0,"p2"=>0,"p3"=>0,"g4h"=>0,"ih"=>0,"flm1huawei"=>0); //flm1huawei = msd for now
				$counts["2g_cpdg"] = 0;
				$counts["ots_2g"] = array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0); //2g
				$counts["ots_3g"] = array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0); //3g
				$counts["mains"] = array("in_house"=>0,"msd"=>0);
				$counts["in_house"] = array(
					"2g"=>array("p1"=>0,"p2"=>0,"p3"=>0),
					"3g"=>array("p1"=>0,"p2"=>0,"p3"=>0),
				);
				$counts["msd"] = array(
					"2g"=>array("p1"=>0,"p2"=>0,"p3"=>0),
					"3g"=>array("p1"=>0,"p2"=>0,"p3"=>0),
				);

				foreach ($site_2go_ids as $sid => $outage)
				{
					if( isset($site_mem_resp->site_list[$sid]) )
					{
						$site = $site_mem_resp->site_list[$sid];

						$pkey = null;
						if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
							$pkey = "p1";
						else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
							$pkey = "p2";
						else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
							$pkey = "p3";

						$shr_key = null;
						if( $site["shared_operator"] == "AIRTEL" )
							$shr_key = "airtel";
						else if( $site["shared_operator"] == "GP" )
							$shr_key = "gp";
						else if( $site["shared_operator"] == "ROBI" )
							$shr_key = "robi";
						else if( $site["shared_operator"] == "STL" )
							$shr_key = "stl";
						else if( $site["shared_operator"] == "E.Co" )
							$shr_key = "e_co";
						else if( $site["shared_operator"] == "FTB" )
							$shr_key = "ftb";
						else if( $site["shared_operator"] == "KTBL" )
							$shr_key = "ktbl";
						else if( $site["shared_operator"] == "BTCL" )
							$shr_key = "btcl";

						
						if( @strpos($site["power_status"], "CP+DG") !== false )
							$counts["2g_cpdg"]++;

						if( $pkey != null )
							$counts["2g"][$pkey]++;

						$dif = $thsts - @strtotime($outage["start_time"]);

						if( $dif > (4*60*60) )
							$counts["2g"]["g4h"]++;

						if( $shr_key != null )
							$counts["ots_2g"][$shr_key]++;

						if( $site["om_office_type"] == 1 )
						{
							// in house
							$counts["2g"]["ih"]++;

							if( $pkey != null )
								$counts["in_house"]["2g"][$pkey]++;
						}
						else if( $site["om_office_type"] == 2 )
						{
							// msd
							$counts["2g"]["flm1huawei"]++;
							if( $pkey != null )
								$counts["msd"]["2g"][$pkey]++;
						}

						// $site["om_office_type"] == 2 msd 1 inhouse
					}
				}

				foreach ($site_3go_ids as $sid => $outage)
				{
					if( isset($site_mem_resp->site_list[$sid]) )
					{
						$site = $site_mem_resp->site_list[$sid];

						$pkey = null;
						if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
							$pkey = "p1";
						else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
							$pkey = "p2";
						else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
							$pkey = "p3";

						$shr_key = null;
						if( $site["shared_operator"] == "AIRTEL" )
							$shr_key = "airtel";
						else if( $site["shared_operator"] == "GP" )
							$shr_key = "gp";
						else if( $site["shared_operator"] == "ROBI" )
							$shr_key = "robi";
						else if( $site["shared_operator"] == "STL" )
							$shr_key = "stl";
						else if( $site["shared_operator"] == "E.Co" )
							$shr_key = "e_co";
						else if( $site["shared_operator"] == "FTB" )
							$shr_key = "ftb";
						else if( $site["shared_operator"] == "KTBL" )
							$shr_key = "ktbl";
						else if( $site["shared_operator"] == "BTCL" )
							$shr_key = "btcl";

						
						// if( @strpos($site["power_status"], "CP+DG") !== false )
						// 	$counts["2g_cpdg"]++;

						if( $pkey != null )
							$counts["3g"][$pkey]++;

						$dif = $thsts - @strtotime($outage["start_time"]);

						if( $dif >= (4*60*60) )
							$counts["3g"]["g4h"]++;

						if( $shr_key != null )
							$counts["ots_3g"][$shr_key]++;

						if( $site["om_office_type"] == 1 )
						{
							// in house
							$counts["3g"]["ih"]++;
							if( $pkey != null )
								$counts["in_house"]["3g"][$pkey]++;
						}
						else if( $site["om_office_type"] == 2 )
						{
							// msd
							$counts["3g"]["flm1huawei"]++;
							if( $pkey != null )
								$counts["msd"]["3g"][$pkey]++;
						}
					}
				}

				foreach ($power_sites as $sid => $pal)
				{
					if( isset($site_mem_resp->site_list[$sid]) )
					{
						$site = $site_mem_resp->site_list[$sid];

						if( $site["om_office_type"] == 1 )
						{
							// in house
							$counts["mains"]["in_house"]++;
						}
						else if( $site["om_office_type"] == 2 )
						{
							// msd
							$counts["mains"]["msd"]++;
						}
					}
				}

				$sheet->getCell('A'.$rin)->setValue( date("j-M-y", $thsts) );
				$sheet->getCell('B'.$rin)->setValue( date("H:i", $thsts) );
				$sheet->getCell('C'.$rin)->setValue( $counts["2g"]["p1"] );
				$sheet->getCell('D'.$rin)->setValue( $counts["2g"]["p2"] );
				$sheet->getCell('E'.$rin)->setValue( $counts["2g"]["p3"] );
				$sheet->getCell('F'.$rin)->setValue( ( $counts["2g"]["p1"]+$counts["2g"]["p2"]+$counts["2g"]["p3"] ) );
				$sheet->getCell('G'.$rin)->setValue( $counts["3g"]["p1"] );
				$sheet->getCell('H'.$rin)->setValue( $counts["3g"]["p1"] );
				$sheet->getCell('I'.$rin)->setValue( $counts["3g"]["p1"] );
				$sheet->getCell('J'.$rin)->setValue( ( $counts["3g"]["p1"]+$counts["3g"]["p2"]+$counts["3g"]["p3"] ) );
				$sheet->getCell('K'.$rin)->setValue( $counts["2g_cpdg"] );
				$sheet->getCell('L'.$rin)->setValue( ( $counts["2g"]["g4h"]+$counts["3g"]["g4h"] ) );
				$sheet->getCell('M'.$rin)->setValue( ( $counts["ots_2g"]["gp"]+$counts["ots_3g"]["gp"] ) );
				$sheet->getCell('N'.$rin)->setValue( ( $counts["ots_2g"]["robi"]+$counts["ots_3g"]["robi"] ) );
				$sheet->getCell('O'.$rin)->setValue( ( $counts["ots_2g"]["airtel"]+$counts["ots_3g"]["airtel"] ) );
				$sheet->getCell('P'.$rin)->setValue( ( $counts["ots_2g"]["stl"]+$counts["ots_3g"]["stl"] ) );
				$sheet->getCell('Q'.$rin)->setValue( ( $counts["ots_2g"]["e_co"]+$counts["ots_3g"]["e_co"] ) );
				$sheet->getCell('R'.$rin)->setValue( ( $counts["ots_2g"]["ftb"]+$counts["ots_3g"]["ftb"] ) );
				$sheet->getCell('S'.$rin)->setValue( ( $counts["ots_2g"]["ktbl"]+$counts["ots_3g"]["ktbl"] ) );
				$sheet->getCell('T'.$rin)->setValue( ( $counts["ots_2g"]["btcl"]+$counts["ots_3g"]["btcl"] ) );
				$sheet->getCell('U'.$rin)->setValue( ( ( $counts["ots_2g"]["gp"]+$counts["ots_3g"]["gp"] ) + ( $counts["ots_2g"]["robi"]+$counts["ots_3g"]["robi"] ) + ( $counts["ots_2g"]["airtel"]+$counts["ots_3g"]["airtel"] ) + ( $counts["ots_2g"]["stl"]+$counts["ots_3g"]["stl"] ) + ( $counts["ots_2g"]["e_co"]+$counts["ots_3g"]["e_co"] ) + ( $counts["ots_2g"]["ftb"]+$counts["ots_3g"]["ftb"] ) + ( $counts["ots_2g"]["ktbl"]+$counts["ots_3g"]["ktbl"] ) + ( $counts["ots_2g"]["btcl"]+$counts["ots_3g"]["btcl"] ) ) );
				$sheet->getCell('V'.$rin)->setValue( $counts["mains"]["in_house"] );
				$sheet->getCell('W'.$rin)->setValue( $counts["mains"]["msd"] );
				$sheet->getCell('X'.$rin)->setValue( ( $counts["mains"]["in_house"]+$counts["mains"]["msd"] ) );
				$sheet->getCell('Y'.$rin)->setValue( $counts["in_house"]["2g"]["p1"] );
				$sheet->getCell('Z'.$rin)->setValue( $counts["in_house"]["2g"]["p2"] );
				$sheet->getCell('AA'.$rin)->setValue( $counts["in_house"]["2g"]["p3"] );
				$sheet->getCell('AB'.$rin)->setValue( $counts["in_house"]["3g"]["p1"] );
				$sheet->getCell('AC'.$rin)->setValue( $counts["in_house"]["3g"]["p2"] );
				$sheet->getCell('AD'.$rin)->setValue( $counts["in_house"]["3g"]["p3"] );
				$sheet->getCell('AE'.$rin)->setValue( $counts["msd"]["2g"]["p1"] );
				$sheet->getCell('AF'.$rin)->setValue( $counts["msd"]["2g"]["p2"] );
				$sheet->getCell('AG'.$rin)->setValue( $counts["msd"]["2g"]["p3"] );
				$sheet->getCell('AH'.$rin)->setValue( $counts["msd"]["3g"]["p1"] );
				$sheet->getCell('AI'.$rin)->setValue( $counts["msd"]["3g"]["p2"] );
				$sheet->getCell('AJ'.$rin)->setValue( $counts["msd"]["3g"]["p3"] );
				$sheet->getCell('AK'.$rin)->setValue( $counts["2g"]["ih"] );
				$sheet->getCell('AL'.$rin)->setValue( $counts["2g"]["flm1huawei"] );
				$sheet->getCell('AM'.$rin)->setValue( $counts["3g"]["ih"] );
				$sheet->getCell('AN'.$rin)->setValue( $counts["3g"]["flm1huawei"] );

				$rin++;
			}
		}

		$phpExcel->setActiveSheetIndex(0);

       	$filename = "basic_entries @ " . date("Y-m-d", @strtotime($sel_date)) . ".xlsx";

	    header('Content-Type: application/vnd.ms-excel');
	    header('Content-Disposition: attachment;filename="'.$filename.'"');
	    header('Cache-Control: max-age=0');
	    // $writer->setPreCalculateFormulas();
	    $writer->save('php://output');
	}

	// Before Removing 3G Backup.
	// public function actionExtractHourlyReport($date, $hour=null)
	// {
	// 	$sel_ts = null;
	// 	if( $date == null || @trim($date) == "" )
	// 	{
	// 		$this->render('error_message',array(
	// 			'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
	// 		));
	// 		Yii::app()->end();
	// 	}
		
	// 	if( $hour != null && @trim($hour) != "" )
	// 	{
	// 		$hour = intval($hour);
	// 		if( $hour < 0 || $hour > 23 )
	// 		{
	// 			$this->render('error_message',array(
	// 				'error_message'=>"Invalid Hour Provided. Please Provide a Valid Hour."
	// 			));
	// 			Yii::app()->end();
	// 		}
	// 		$hour = str_pad($hour, 2, '0', STR_PAD_LEFT);
	// 	}
	// 	else
	// 	{
	// 		$hour = date("H");
	// 	}

	// 	if( $this->validateDate($date, 'd/m/Y') )
	// 	{
	// 		$pd = DateTime::createFromFormat('d/m/Y', $date);
	// 		$sel_ts = $pd->format('Y-m-d')." ".$hour.":00:00";

	// 		if( @strtotime($sel_ts) > @strtotime(date("Y-m-d H:00:00")) )
	// 		{
	// 			$this->render('error_message',array(
	// 				'error_message'=>"Invalid Hour Provided. Please Provide a Hour for Earlier then Now."
	// 			));
	// 			Yii::app()->end();
	// 		}
	// 	}
	// 	else
	// 	{
	// 		$this->render('error_message',array(
	// 			'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
	// 		));
	// 		Yii::app()->end();
	// 	}

	// 	session_write_close();

	// 	require_once (Yii::app()->basePath.'/extensions/PHPExcel-1.8/Classes/PHPExcel.php');

	// 	ini_set('max_execution_time', 300); // 5 minutes
	// 	ini_set("memory_limit", "-1");

	// 	$site_mem_resp = MemHelper::get_site_list();
	// 	if(!$site_mem_resp->success)
	// 		throw new CHttpException(500, "Error Getting Mem Site List: ".$site_mem_resp->message);

	// 	$inhouse_lookup = array();
	// 	$msd_lookup = array();
	// 	$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
	// 	if( $om_ofc_resp->success )
	// 	{
	// 		foreach ($om_ofc_resp->data as $key => $om_ofc)
	// 		{
	// 			if( $om_ofc->office_type_id == 1)
	// 			{
	// 				$inhouse_lookup [$om_ofc->id] = $om_ofc;
	// 			}
	// 			else if( $om_ofc->office_type_id == 2)
	// 			{
	// 				$msd_lookup [$om_ofc->id] = $om_ofc;
	// 			}
	// 		}
	// 	}
	// 	else
	// 	{
	// 		throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
	// 	}

	// 	// have to check that selected users hour should not be greater then current hour as sanity check
	// 	$now = time();
	// 	$std = date("Y-m-d H:00:00", @strtotime("-4 hours ", @strtotime($sel_ts) ) );
	// 	$edt = $sel_ts;

	// 	$huawei_id = Yii::app()->params["vendor_lookup"]["huawei"];
	// 	$zte_id = Yii::app()->params["vendor_lookup"]["zte"];
	// 	$nokia_id = Yii::app()->params["vendor_lookup"]["nokia"];

	// 	// last parameter is to skip the check for suppressing type2 outages as we are only using instantaneous analysis here
	// 	$outages = NetworkAvailabilityHelper::getDurationOutages( $std, $edt, $site_mem_resp, false, true );

	// 	$emslkp = Yii::app()->params["tech_lookup_txt"];
	// 	$ran_emss = array();
	// 	foreach ($emslkp as $tech_id => $domain)
	// 	{
	// 		if( $domain == "RAN" )
	// 			$ran_emss [] = $tech_id;
	// 	}
	// 	$tech_ems_cond = " FALSE ";
	// 	if( sizeof($ran_emss) > 0 )
	// 		$tech_ems_cond = " t.technology_id IN (".implode(",", $ran_emss).") ";

	// 	$actpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.entity_name as sname, t.perceived_severity, t.specific_problem as slogan, t.alarm_raised_time, NULL AS alarm_cleared_time_ums, TRUE AS active
	// 	FROM alarm t Where t.entity_type IS NOT NULL
	// 	AND t.entity_type = 1
	// 	AND $tech_ems_cond
	// 	AND t.entity_id IS NOT NULL
	// 	AND t.entity_id != -1
	// 	AND t.vendor_id IS NOT NULL
	// 	AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
	// 	AND t.alarm_raised_time IS NOT NULL
	// 	AND t.alarm_raised_time <= '$edt'::timestamp without time zone
	// 	AND (
	// 		lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON' OR t.specific_problem = 'LOW VOLTAGE'
	// 	) ORDER BY t.alarm_raised_time ASC ;
	// 	")->queryAll();

	// 	$logpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.entity_name as sname, t.perceived_severity, t.specific_problem as slogan, t.alarm_raised_time, t.alarm_cleared_time_ums, FALSE AS active
	// 	FROM log t Where t.entity_type IS NOT NULL
	// 	AND t.entity_type = 1
	// 	AND $tech_ems_cond
	// 	AND t.entity_id IS NOT NULL
	// 	AND t.entity_id != -1
	// 	AND t.vendor_id IS NOT NULL
	// 	AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
	// 	AND t.alarm_raised_time IS NOT NULL
	// 	AND t.alarm_raised_time <= '$edt'::timestamp without time zone 
	// 	AND t.alarm_cleared_time_ums IS NOT NULL
	// 	AND t.alarm_cleared_time_ums >= '$std'::timestamp without time zone 
	// 	AND (
	// 		lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON' OR t.specific_problem = 'LOW VOLTAGE'
	// 	) ORDER BY t.alarm_raised_time ASC  ;
	// 	")->queryAll();



	// 	$phpExcel = new PHPExcel;
	// 	// Setting font to Arial Black
	// 	$phpExcel->getDefaultStyle()->getFont()->setName('Calibri');
	// 	// Setting font size to 14
	// 	$phpExcel->getDefaultStyle()->getFont()->setSize(11);
	// 	//Setting description, creator and title
	// 	$phpExcel->getProperties()->setTitle("Hourly SMS Report");
	// 	$phpExcel->getProperties()->setCreator("UMS");
	// 	$phpExcel->getProperties()->setDescription("Hourly SMS Report");
	// 	// Creating PHPExcel spreadsheet writer object
	// 	// We will create xlsx file (Excel 2007 and above)
	// 	$writer = PHPExcel_IOFactory::createWriter($phpExcel, "Excel2007");
	// 	// When creating the writer object, the first sheet is also created

	// 	$ha_style = array(
	//         'alignment' => array(
	//             'horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER,
	//         )
	//     );

	// 	$sheet = $phpExcel->getActiveSheet();
	// 	$sheet->setTitle('Storm_Trend');

	// 	$sheet->getCell('A1')->setValue('Active power alarm');
	// 	$sheet->mergeCells('A1:J1');
	// 	$sheet->getCell('M1')->setValue('Active Site Down');
	// 	$sheet->mergeCells('M1:S1');
	// 	$sheet->getCell('V1')->setValue('Division-Wise Power Alarm and Site Down Trend for last 3 hrs');
	// 	$sheet->mergeCells('V1:AB1');

	// 	$sheet->getCell('A2')->setValue('RO');
	// 	$sheet->getCell('B2')->setValue('O&M Office');
	// 	$sheet->getCell('C2')->setValue('0<Hr<4');
	// 	$sheet->getCell('D2')->setValue('4<Hr<8');
	// 	$sheet->getCell('E2')->setValue('8<Hr<12');
	// 	$sheet->getCell('F2')->setValue('12<Hr<16');
	// 	$sheet->getCell('G2')->setValue('16<Hr<20');
	// 	$sheet->getCell('H2')->setValue('20<Hr<24');
	// 	$sheet->getCell('I2')->setValue('Hr>24');
	// 	$sheet->getCell('J2')->setValue('Total');

	// 	$sheet->getCell('M2')->setValue('RO');
	// 	$sheet->getCell('N2')->setValue('O&M Office');
	// 	$sheet->getCell('O2')->setValue('0<Hr<6');
	// 	$sheet->getCell('P2')->setValue('6<Hr<12');
	// 	$sheet->getCell('Q2')->setValue('12<Hr<24');
	// 	$sheet->getCell('R2')->setValue('Hr>24');
	// 	$sheet->getCell('S2')->setValue('Total');

	// 	$sheet->getCell('V2')->setValue('DIVISION');
	// 	$sheet->getCell('W2')->setValue("Power Alarm at ".date("H:00", @strtotime("-3 hours", @strtotime($sel_ts)))."Hrs");
	// 	$sheet->getCell('X2')->setValue("Power Alarm at ".date("H:00", @strtotime("-2 hours", @strtotime($sel_ts)))."Hrs");
	// 	$sheet->getCell('Y2')->setValue("Power Alarm at ".date("H:00", @strtotime("-1 hours", @strtotime($sel_ts)))."Hrs");
	// 	$sheet->getCell('Z2')->setValue("Site Down at ".date("H:00", @strtotime("-3 hours", @strtotime($sel_ts)))."Hrs");
	// 	$sheet->getCell('AA2')->setValue("Site Down at ".date("H:00", @strtotime("-2 hours", @strtotime($sel_ts)))."Hrs");
	// 	$sheet->getCell('AB2')->setValue("Site Down at ".date("H:00", @strtotime("-1 hours", @strtotime($sel_ts)))."Hrs");

	// 	$sheet->getStyle('A1:AB2')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle("A1:AB2")->applyFromArray($ha_style);

	// 	$ofc_counts = array();
	// 	$district_counts = array();

	// 	foreach ($om_ofc_resp->data as $key => $om_ofc)
	// 	{
	// 		if( $om_ofc->office_type_id == 1 && $om_ofc->ro != null )
	// 		{
	// 			$ofc_counts [$om_ofc->id] = array(
	// 				"name"=>$om_ofc->name,
	// 				"ro"=>$om_ofc->ro,
	// 				"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
	// 				"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 				"outage_3g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 				"outage_4g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 			);
	// 		}
	// 	}

	// 	foreach ($site_mem_resp->site_list as $site)
	// 	{
	// 		if( $site["district"] != null && $site["ro"] != null && !isset($district_counts[$site["district"]]) )
	// 		{
	// 			$district_counts [$site["district"]] = array(
	// 				"ro"=>$site["ro"],
	// 				"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
	// 				"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 			);
	// 		}
	// 	}

	// 	$sel_hours_stats = $this->get_affected_at_hour( $actpowers, $logpowers, $outages, $sel_ts );

	// 	foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($alrm_tm["alarm_raised_time"]);

	// 				if( $dif >= 0 && $dif < (4*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h0_4"]++;
	// 				else if( $dif >= (4*60*60) && $dif < (8*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h4_8"]++;
	// 				else if( $dif >= (8*60*60) && $dif < (12*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h8_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (16*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h12_16"]++;
	// 				else if( $dif >= (16*60*60) && $dif < (20*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h16_20"]++;
	// 				else if( $dif >= (20*60*60) && $dif < (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["h20_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["power"]["hg24"]++;
	// 			}

	// 			if( $site["district"] != null && isset($district_counts[$site["district"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($alrm_tm["alarm_raised_time"]);

	// 				if( $dif >= 0 && $dif < (4*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h0_4"]++;
	// 				else if( $dif >= (4*60*60) && $dif < (8*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h4_8"]++;
	// 				else if( $dif >= (8*60*60) && $dif < (12*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h8_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (16*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h12_16"]++;
	// 				else if( $dif >= (16*60*60) && $dif < (20*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h16_20"]++;
	// 				else if( $dif >= (20*60*60) && $dif < (24*60*60) )
	// 					$district_counts[$site["district"]]["power"]["h20_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$district_counts[$site["district"]]["power"]["hg24"]++;
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 				if( $dif >= 0 && $dif < (6*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_2g"]["h0_6"]++;
	// 				else if( $dif >= (6*60*60) && $dif < (12*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_2g"]["h6_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_2g"]["h12_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_2g"]["hg24"]++;
	// 			}

	// 			if( $site["district"] != null && isset($district_counts[$site["district"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 				if( $dif >= 0 && $dif < (6*60*60) )
	// 					$district_counts[$site["district"]]["outage_2g"]["h0_6"]++;
	// 				else if( $dif >= (6*60*60) && $dif < (12*60*60) )
	// 					$district_counts[$site["district"]]["outage_2g"]["h6_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (24*60*60) )
	// 					$district_counts[$site["district"]]["outage_2g"]["h12_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$district_counts[$site["district"]]["outage_2g"]["hg24"]++;
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_3go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 				if( $dif >= 0 && $dif < (6*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_3g"]["h0_6"]++;
	// 				else if( $dif >= (6*60*60) && $dif < (12*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_3g"]["h6_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_3g"]["h12_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_3g"]["hg24"]++;
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_4go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
	// 			{
	// 				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 				if( $dif >= 0 && $dif < (6*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_4g"]["h0_6"]++;
	// 				else if( $dif >= (6*60*60) && $dif < (12*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_4g"]["h6_12"]++;
	// 				else if( $dif >= (12*60*60) && $dif < (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_4g"]["h12_24"]++;
	// 				else if ( $dif >= (24*60*60) )
	// 					$ofc_counts[$site["om_office_id"]]["outage_4g"]["hg24"]++;
	// 			}
	// 		}
	// 	}

	// 	$ro_ofc_counts = array();
	// 	foreach ($ofc_counts as $ofc_id => $ofc_data)
	// 	{
	// 		if( !isset( $ro_ofc_counts[$ofc_data["ro"]] ) )
	// 			$ro_ofc_counts[$ofc_data["ro"]] = array();

	// 		$ro_ofc_counts[$ofc_data["ro"]] [] = $ofc_data;
	// 	}

	// 	ksort($ro_ofc_counts);
	// 	$rin = 3;

	// 	$totals = array(
	// 		"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
	// 		"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 	);
	// 	foreach ($ro_ofc_counts as $ro_name => $ro_ofcs)
	// 	{
	// 		foreach ($ro_ofcs as $ofc)
	// 		{
	// 			$sheet->getCell('A'.$rin)->setValue( $ro_name );
	// 			$sheet->getCell('B'.$rin)->setValue( $ofc["name"] );
	// 			$sheet->getCell('C'.$rin)->setValue( $ofc["power"]["h0_4"] );
	// 			$sheet->getCell('D'.$rin)->setValue( $ofc["power"]["h4_8"] );
	// 			$sheet->getCell('E'.$rin)->setValue( $ofc["power"]["h8_12"] );
	// 			$sheet->getCell('F'.$rin)->setValue( $ofc["power"]["h12_16"] );
	// 			$sheet->getCell('G'.$rin)->setValue( $ofc["power"]["h16_20"] );
	// 			$sheet->getCell('H'.$rin)->setValue( $ofc["power"]["h20_24"] );
	// 			$sheet->getCell('I'.$rin)->setValue( $ofc["power"]["hg24"] );
	// 			$sheet->getCell('J'.$rin)->setValue( ( $ofc["power"]["h0_4"] + $ofc["power"]["h4_8"] + $ofc["power"]["h8_12"] + $ofc["power"]["h12_16"] + $ofc["power"]["h16_20"] + $ofc["power"]["h20_24"] + $ofc["power"]["hg24"] ) );

	// 			$sheet->getCell('M'.$rin)->setValue( $ro_name );
	// 			$sheet->getCell('N'.$rin)->setValue( $ofc["name"] );
	// 			$sheet->getCell('O'.$rin)->setValue( $ofc["outage_2g"]["h0_6"] );
	// 			$sheet->getCell('P'.$rin)->setValue( $ofc["outage_2g"]["h6_12"] );
	// 			$sheet->getCell('Q'.$rin)->setValue( $ofc["outage_2g"]["h12_24"] );
	// 			$sheet->getCell('R'.$rin)->setValue( $ofc["outage_2g"]["hg24"] );
	// 			$sheet->getCell('S'.$rin)->setValue( ( $ofc["outage_2g"]["h0_6"] + $ofc["outage_2g"]["h6_12"] + $ofc["outage_2g"]["h12_24"] + $ofc["outage_2g"]["hg24"] ) );


	// 			$totals["power"]["h0_4"] += $ofc["power"]["h0_4"];
	// 			$totals["power"]["h4_8"] += $ofc["power"]["h4_8"];
	// 			$totals["power"]["h8_12"] += $ofc["power"]["h8_12"];
	// 			$totals["power"]["h12_16"] += $ofc["power"]["h12_16"];
	// 			$totals["power"]["h16_20"] += $ofc["power"]["h16_20"];
	// 			$totals["power"]["h20_24"] += $ofc["power"]["h20_24"];
	// 			$totals["power"]["hg24"] += $ofc["power"]["hg24"];

	// 			$totals["outage_2g"]["h0_6"] += $ofc["outage_2g"]["h0_6"];
	// 			$totals["outage_2g"]["h6_12"] += $ofc["outage_2g"]["h6_12"];
	// 			$totals["outage_2g"]["h12_24"] += $ofc["outage_2g"]["h12_24"];
	// 			$totals["outage_2g"]["hg24"] += $ofc["outage_2g"]["hg24"];

	// 			$rin++;
	// 		}
	// 	}

	// 	// total Row
	// 	$sheet->getCell('A'.$rin)->setValue( 'Total' );
	// 	$sheet->getCell('B'.$rin)->setValue( '' );
	// 	$sheet->getCell('C'.$rin)->setValue( $totals["power"]["h0_4"] );
	// 	$sheet->getCell('D'.$rin)->setValue( $totals["power"]["h4_8"] );
	// 	$sheet->getCell('E'.$rin)->setValue( $totals["power"]["h8_12"] );
	// 	$sheet->getCell('F'.$rin)->setValue( $totals["power"]["h12_16"] );
	// 	$sheet->getCell('G'.$rin)->setValue( $totals["power"]["h16_20"] );
	// 	$sheet->getCell('H'.$rin)->setValue( $totals["power"]["h20_24"] );
	// 	$sheet->getCell('I'.$rin)->setValue( $totals["power"]["hg24"] );
	// 	$sheet->getCell('J'.$rin)->setValue( ( $totals["power"]["h0_4"] + $totals["power"]["h4_8"] + $totals["power"]["h8_12"] + $totals["power"]["h12_16"] + $totals["power"]["h16_20"] + $totals["power"]["h20_24"] + $totals["power"]["hg24"] ) );

	// 	$sheet->getCell('M'.$rin)->setValue( 'Total' );
	// 	$sheet->getCell('N'.$rin)->setValue( '' );
	// 	$sheet->getCell('O'.$rin)->setValue( $totals["outage_2g"]["h0_6"] );
	// 	$sheet->getCell('P'.$rin)->setValue( $totals["outage_2g"]["h6_12"] );
	// 	$sheet->getCell('Q'.$rin)->setValue( $totals["outage_2g"]["h12_24"] );
	// 	$sheet->getCell('R'.$rin)->setValue( $totals["outage_2g"]["hg24"] );
	// 	$sheet->getCell('S'.$rin)->setValue( ( $totals["outage_2g"]["h0_6"] + $totals["outage_2g"]["h6_12"] + $totals["outage_2g"]["h12_24"] + $totals["outage_2g"]["hg24"] ) );

	// 	$rin++;
	// 	$rin++;
	// 	$rin++;


	// 	$sheet->getCell('A'.$rin)->setValue('District Wise Active power alarm');
	// 	$sheet->mergeCells('A'.$rin.':J'.$rin);
	// 	$sheet->getCell('M'.$rin)->setValue('District Wise Active Site Down');
	// 	$sheet->mergeCells('M'.$rin.':S'.$rin);
	// 	$rin++;

	// 	$sheet->getCell('A'.$rin)->setValue('RO');
	// 	$sheet->getCell('B'.$rin)->setValue('District');
	// 	$sheet->getCell('C'.$rin)->setValue('0<Hr<4');
	// 	$sheet->getCell('D'.$rin)->setValue('4<Hr<8');
	// 	$sheet->getCell('E'.$rin)->setValue('8<Hr<12');
	// 	$sheet->getCell('F'.$rin)->setValue('12<Hr<16');
	// 	$sheet->getCell('G'.$rin)->setValue('16<Hr<20');
	// 	$sheet->getCell('H'.$rin)->setValue('20<Hr<24');
	// 	$sheet->getCell('I'.$rin)->setValue('Hr>24');
	// 	$sheet->getCell('J'.$rin)->setValue('Total');

	// 	$sheet->getCell('M'.$rin)->setValue('RO');
	// 	$sheet->getCell('N'.$rin)->setValue('O&M Office');
	// 	$sheet->getCell('O'.$rin)->setValue('0<Hr<6');
	// 	$sheet->getCell('P'.$rin)->setValue('6<Hr<12');
	// 	$sheet->getCell('Q'.$rin)->setValue('12<Hr<24');
	// 	$sheet->getCell('R'.$rin)->setValue('Hr>24');
	// 	$sheet->getCell('S'.$rin)->setValue('Total');

	// 	$sheet->getStyle('A'.($rin-1).':S'.$rin)->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('A'.($rin-1).':S'.$rin)->applyFromArray($ha_style);
	// 	$rin++;


	// 	$totals = array(
	// 		"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
	// 		"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
	// 	);
	// 	ksort($district_counts);
	// 	foreach ($district_counts as $dis_name => $ddata)
	// 	{
	// 		$sheet->getCell('A'.$rin)->setValue( $ddata["ro"] );
	// 		$sheet->getCell('B'.$rin)->setValue( $dis_name );
	// 		$sheet->getCell('C'.$rin)->setValue( $ddata["power"]["h0_4"] );
	// 		$sheet->getCell('D'.$rin)->setValue( $ddata["power"]["h4_8"] );
	// 		$sheet->getCell('E'.$rin)->setValue( $ddata["power"]["h8_12"] );
	// 		$sheet->getCell('F'.$rin)->setValue( $ddata["power"]["h12_16"] );
	// 		$sheet->getCell('G'.$rin)->setValue( $ddata["power"]["h16_20"] );
	// 		$sheet->getCell('H'.$rin)->setValue( $ddata["power"]["h20_24"] );
	// 		$sheet->getCell('I'.$rin)->setValue( $ddata["power"]["hg24"] );
	// 		$sheet->getCell('J'.$rin)->setValue( ( $ddata["power"]["h0_4"] + $ddata["power"]["h4_8"] + $ddata["power"]["h8_12"] + $ddata["power"]["h12_16"] + $ddata["power"]["h16_20"] + $ddata["power"]["h20_24"] + $ddata["power"]["hg24"] ) );

	// 		$sheet->getCell('M'.$rin)->setValue( $ddata["ro"] );
	// 		$sheet->getCell('N'.$rin)->setValue( $dis_name );
	// 		$sheet->getCell('O'.$rin)->setValue( $ddata["outage_2g"]["h0_6"] );
	// 		$sheet->getCell('P'.$rin)->setValue( $ddata["outage_2g"]["h6_12"] );
	// 		$sheet->getCell('Q'.$rin)->setValue( $ddata["outage_2g"]["h12_24"] );
	// 		$sheet->getCell('R'.$rin)->setValue( $ddata["outage_2g"]["hg24"] );
	// 		$sheet->getCell('S'.$rin)->setValue( ( $ddata["outage_2g"]["h0_6"] + $ddata["outage_2g"]["h6_12"] + $ddata["outage_2g"]["h12_24"] + $ddata["outage_2g"]["hg24"] ) );


	// 		$totals["power"]["h0_4"] += $ddata["power"]["h0_4"];
	// 		$totals["power"]["h4_8"] += $ddata["power"]["h4_8"];
	// 		$totals["power"]["h8_12"] += $ddata["power"]["h8_12"];
	// 		$totals["power"]["h12_16"] += $ddata["power"]["h12_16"];
	// 		$totals["power"]["h16_20"] += $ddata["power"]["h16_20"];
	// 		$totals["power"]["h20_24"] += $ddata["power"]["h20_24"];
	// 		$totals["power"]["hg24"] += $ddata["power"]["hg24"];

	// 		$totals["outage_2g"]["h0_6"] += $ddata["outage_2g"]["h0_6"];
	// 		$totals["outage_2g"]["h6_12"] += $ddata["outage_2g"]["h6_12"];
	// 		$totals["outage_2g"]["h12_24"] += $ddata["outage_2g"]["h12_24"];
	// 		$totals["outage_2g"]["hg24"] += $ddata["outage_2g"]["hg24"];

	// 		$rin++;
	// 	}

	// 	// total Row
	// 	$sheet->getCell('A'.$rin)->setValue( 'Total' );
	// 	$sheet->getCell('B'.$rin)->setValue( '' );
	// 	$sheet->getCell('C'.$rin)->setValue( $totals["power"]["h0_4"] );
	// 	$sheet->getCell('D'.$rin)->setValue( $totals["power"]["h4_8"] );
	// 	$sheet->getCell('E'.$rin)->setValue( $totals["power"]["h8_12"] );
	// 	$sheet->getCell('F'.$rin)->setValue( $totals["power"]["h12_16"] );
	// 	$sheet->getCell('G'.$rin)->setValue( $totals["power"]["h16_20"] );
	// 	$sheet->getCell('H'.$rin)->setValue( $totals["power"]["h20_24"] );
	// 	$sheet->getCell('I'.$rin)->setValue( $totals["power"]["hg24"] );
	// 	$sheet->getCell('J'.$rin)->setValue( ( $totals["power"]["h0_4"] + $totals["power"]["h4_8"] + $totals["power"]["h8_12"] + $totals["power"]["h12_16"] + $totals["power"]["h16_20"] + $totals["power"]["h20_24"] + $totals["power"]["hg24"] ) );

	// 	$sheet->getCell('M'.$rin)->setValue( 'Total' );
	// 	$sheet->getCell('N'.$rin)->setValue( '' );
	// 	$sheet->getCell('O'.$rin)->setValue( $totals["outage_2g"]["h0_6"] );
	// 	$sheet->getCell('P'.$rin)->setValue( $totals["outage_2g"]["h6_12"] );
	// 	$sheet->getCell('Q'.$rin)->setValue( $totals["outage_2g"]["h12_24"] );
	// 	$sheet->getCell('R'.$rin)->setValue( $totals["outage_2g"]["hg24"] );
	// 	$sheet->getCell('S'.$rin)->setValue( ( $totals["outage_2g"]["h0_6"] + $totals["outage_2g"]["h6_12"] + $totals["outage_2g"]["h12_24"] + $totals["outage_2g"]["hg24"] ) );







	// 	$regions = array(
	// 		'BARISHAL',
	// 		'CHATTOGRAM',
	// 		'DHAKA',
	// 		'KHULNA',
	// 		'RAJSHAHI',
	// 		'SYLHET',
	// 		'RANGPUR',
	// 		'MYMENSINGH',
	// 	);

	// 	$reg_counts = array();
	// 	foreach ($regions as $reg)
	// 	{
	// 		$reg_counts [$reg] = array(
	// 			"power"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 			"outage_2g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 			"outage_3g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 			"outage_4g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 		);
	// 	}

	// 	$sel1b_hours_stats = null;
	// 	$sel2b_hours_stats = null;
	// 	$sel3b_hours_stats = null;

	// 	$sel1b_tmm_stats = array(
	// 		"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 	);
	// 	$sel2b_tmm_stats =  array(
	// 		"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 	);
	// 	$sel3b_tmm_stats =  array(
	// 		"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 		"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 	);

	// 	for ($i=1; $i <= 3; $i++)
	// 	{
	// 		${"sel".$i."b_hours_stats"} = $this->get_affected_at_hour( $actpowers, $logpowers, $outages, date("Y-m-d H:00:00", @strtotime("-$i hours", @strtotime($sel_ts))) );

	// 		foreach (${"sel".$i."b_hours_stats"}["power_sites"] as $sid => $alrm_tm)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];

	// 				if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
	// 				{
	// 					$reg_counts[$site["zone"]]["power"]["p".$i."hb"]++;
	// 				}
	// 			}
	// 		}

	// 		foreach (${"sel".$i."b_hours_stats"}["site_2go_ids"] as $sid => $outage_tm)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];

	// 				if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
	// 				{
	// 					$reg_counts[$site["zone"]]["outage_2g"]["p".$i."hb"]++;
	// 				}

	// 				${"sel".$i."b_tmm_stats"}["2g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					${"sel".$i."b_tmm_stats"}["2g"]["macro"]++;
	// 				else
	// 					${"sel".$i."b_tmm_stats"}["2g"]["micro"]++;
	// 			}
	// 		}

	// 		foreach (${"sel".$i."b_hours_stats"}["site_3go_ids"] as $sid => $outage_tm)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];

	// 				if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
	// 				{
	// 					$reg_counts[$site["zone"]]["outage_3g"]["p".$i."hb"]++;
	// 				}

	// 				${"sel".$i."b_tmm_stats"}["3g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					${"sel".$i."b_tmm_stats"}["3g"]["macro"]++;
	// 				else
	// 					${"sel".$i."b_tmm_stats"}["3g"]["micro"]++;
	// 			}
	// 		}

	// 		foreach (${"sel".$i."b_hours_stats"}["site_4go_ids"] as $sid => $outage_tm)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];

	// 				if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
	// 				{
	// 					$reg_counts[$site["zone"]]["outage_4g"]["p".$i."hb"]++;
	// 				}

	// 				${"sel".$i."b_tmm_stats"}["4g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					${"sel".$i."b_tmm_stats"}["4g"]["macro"]++;
	// 				else
	// 					${"sel".$i."b_tmm_stats"}["4g"]["micro"]++;
	// 			}
	// 		}
	// 	}

	// 	$rin = 3;
	// 	$totals = array(
	// 		"power"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 		"outage_2g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
	// 	);
	// 	foreach ($reg_counts as $reg_name => $reg_data)
	// 	{
	// 		$sheet->getCell('V'.$rin)->setValue($reg_name);
	// 		$sheet->getCell('W'.$rin)->setValue( $reg_data["power"]["p3hb"] );
	// 		$sheet->getCell('X'.$rin)->setValue( $reg_data["power"]["p2hb"] );
	// 		$sheet->getCell('Y'.$rin)->setValue( $reg_data["power"]["p1hb"] );
	// 		$sheet->getCell('Z'.$rin)->setValue( $reg_data["outage_2g"]["p3hb"] );
	// 		$sheet->getCell('AA'.$rin)->setValue( $reg_data["outage_2g"]["p2hb"] );
	// 		$sheet->getCell('AB'.$rin)->setValue( $reg_data["outage_2g"]["p1hb"] );

	// 		$totals["power"]["p3hb"] += $reg_data["power"]["p3hb"];
	// 		$totals["power"]["p2hb"] += $reg_data["power"]["p2hb"];
	// 		$totals["power"]["p1hb"] += $reg_data["power"]["p1hb"];
	// 		$totals["outage_2g"]["p3hb"] += $reg_data["outage_2g"]["p3hb"];
	// 		$totals["outage_2g"]["p2hb"] += $reg_data["outage_2g"]["p2hb"];
	// 		$totals["outage_2g"]["p1hb"] += $reg_data["outage_2g"]["p1hb"];

	// 		$rin++;
	// 	}

	// 	// Total Reg Data
	// 	$sheet->getCell('V'.$rin)->setValue( 'Total' );
	// 	$sheet->getCell('W'.$rin)->setValue( $totals["power"]["p3hb"] );
	// 	$sheet->getCell('X'.$rin)->setValue( $totals["power"]["p2hb"] );
	// 	$sheet->getCell('Y'.$rin)->setValue( $totals["power"]["p1hb"] );
	// 	$sheet->getCell('Z'.$rin)->setValue( $totals["outage_2g"]["p3hb"] );
	// 	$sheet->getCell('AA'.$rin)->setValue( $totals["outage_2g"]["p2hb"] );
	// 	$sheet->getCell('AB'.$rin)->setValue( $totals["outage_2g"]["p1hb"] );







	// 	$shind = 1;
	// 	$sheet = $phpExcel->createSheet($shind);
	// 	$sheet->setTitle("SMS");
	// 	$shind++;

	// 	$sheet->getCell('A1')->setValue('#');

	// 	$selhs = date("H:00", @strtotime($sel_ts))."Hrs";

	// 	$sheet->getCell('B2')->setValue('Priority SMS');
	// 	$sheet->getCell('B3')->setValue('2G Sites Down at '.$selhs);

	// 	$counts = array(
	// 		"p1"=>array("in_house"=>0,"msd"=>0),
	// 		"p2"=>array("in_house"=>0,"msd"=>0),
	// 		"p3"=>array("in_house"=>0,"msd"=>0),
	// 		"power"=>array("in_house"=>0,"msd"=>0),
	// 	);


	// 	$countspw = array(
	// 		"2g"=>array(
	// 			"total"=>0,
	// 			"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
	// 			"macro"=>0,
	// 			"micro"=>0,
	// 			"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"g2h"=>0,
	// 			"l2h"=>0,
	// 		),
	// 		"3g"=>array(
	// 			"total"=>0,
	// 			"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
	// 			"macro"=>0,
	// 			"micro"=>0,
	// 			"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"g2h"=>0,
	// 			"l2h"=>0,
	// 		),
	// 		"4g"=>array(
	// 			"total"=>0,
	// 			"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
	// 			"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
	// 			"macro"=>0,
	// 			"micro"=>0,
	// 			"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
	// 			"g2h"=>0,
	// 			"l2h"=>0,
	// 		),
	// 	);

	// 	$om_ofcs = array(
	// 		"in_house"=>array(),
	// 		"msd"=>array(),
	// 		"in_house_t"=>array(
	// 			"g2h"=>array(
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			),
	// 			"l2h"=>array(
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			),
	// 		),
	// 		"msd_t"=>array(
	// 			"g2h"=>array(
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			),
	// 			"l2h"=>array(
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			),
	// 		),
	// 	);
		
	// 	$shared_2g = array(
	// 		"gp"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"robi"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"airtel"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"stl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"e_co"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"ftb"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"ktbl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 		"btcl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
	// 	);

	// 	$regions = array(
	// 		'BARISHAL',
	// 		'CHATTOGRAM',
	// 		'DHAKA',
	// 		'KHULNA',
	// 		'RAJSHAHI',
	// 		'SYLHET',
	// 		'RANGPUR',
	// 		'MYMENSINGH',
	// 	);
	// 	$division_wise = array();
	// 	foreach ($regions as $reg)
	// 	{
	// 		$division_wise [$reg] = array(
	// 			"total_2g"=>0,
	// 			"outage_2g"=>0,
	// 			"total_3g"=>0,
	// 			"outage_3g"=>0,
	// 			"total_4g"=>0,
	// 			"outage_4g"=>0,
	// 		);
	// 	}

	// 	$countow = array();
	// 	foreach ($om_ofc_resp->data as $key => $om_ofc)
	// 	{
	// 		if( $om_ofc->office_type_id == 1 )
	// 		{
	// 			$countow [$om_ofc->id] = array(
	// 				"name"=>$om_ofc->name,
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			);
	// 		}

	// 		if( $om_ofc->office_type_id == 1 )
	// 		{
	// 			$om_ofcs["in_house"][$om_ofc->id] = array(
	// 				"name"=>$om_ofc->name,
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			);
	// 		}
	// 		else if( $om_ofc->office_type_id == 2 )
	// 		{
	// 			$om_ofcs["msd"][$om_ofc->id] = array(
	// 				"name"=>$om_ofc->name,
	// 				"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 				"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
	// 			);
	// 		}
	// 	}

	// 	foreach ($site_mem_resp->site_list as $site)
	// 	{
	// 		if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
	// 		{
	// 			if( $site["site_code_2g"] != null )
	// 				$division_wise[$site["zone"]]["total_2g"]++;

	// 			if( $site["site_code_3g"] != null )
	// 				$division_wise[$site["zone"]]["total_3g"]++;

	// 			if( $site["site_code_4g"] != null )
	// 				$division_wise[$site["zone"]]["total_4g"]++;
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			$countspw["2g"]["total"]++;
	// 			if( $site["om_office_type"] == 1 )
	// 				$countspw["2g"]["in_house"]["total"]++;
	// 			else if( $site["om_office_type"] == 2 )
	// 				$countspw["2g"]["msd"]["total"]++;

	// 			$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 			if( $dif >= 0 && $dif < (2*60*60) )
	// 			{
	// 				$countspw["2g"]["l2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["2g"]["in_house"]["l2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["2g"]["msd"]["l2h"]++;
	// 			}
	// 			else if( $dif >= (2*60*60) )
	// 			{
	// 				$countspw["2g"]["g2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["2g"]["in_house"]["g2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["2g"]["msd"]["g2h"]++;
	// 			}

	// 			$pkey = null;
	// 			if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
	// 				$pkey = "p1";
	// 			else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
	// 				$pkey = "p2";
	// 			else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
	// 				$pkey = "p3";
				
	// 			if( $pkey != null )
	// 			{
	// 				$countspw["2g"][$pkey]["total"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 				{
	// 					$counts[$pkey]["in_house"]++;
	// 					$countspw["2g"][$pkey]["in_house"]++;
	// 				}
	// 				else if( $site["om_office_type"] == 2 )
	// 				{
	// 					$counts[$pkey]["msd"]++;
	// 					$countspw["2g"][$pkey]["msd"]++;
	// 				}
	// 			}

	// 			$shr_key = null;
	// 			if( $site["shared_operator"] == "AIRTEL" )
	// 				$shr_key = "airtel";
	// 			else if( $site["shared_operator"] == "GP" )
	// 				$shr_key = "gp";
	// 			else if( $site["shared_operator"] == "ROBI" )
	// 				$shr_key = "robi";
	// 			else if( $site["shared_operator"] == "STL" )
	// 				$shr_key = "stl";
	// 			else if( $site["shared_operator"] == "E.Co" )
	// 				$shr_key = "e_co";
	// 			else if( $site["shared_operator"] == "FTB" )
	// 				$shr_key = "ftb";
	// 			else if( $site["shared_operator"] == "KTBL" )
	// 				$shr_key = "ktbl";
	// 			else if( $site["shared_operator"] == "BTCL" )
	// 				$shr_key = "btcl";

	// 			$shr_type = null;
	// 			if( $shr_key != null && $site["sharing_type"] != null )
	// 			{
	// 				if( $site["sharing_type"] == "BL Own Power" )
	// 					$shr_type = "bl_own";
	// 				else if( $site["sharing_type"] == "AC Power share" )
	// 					$shr_type = "ac_ps";
	// 				else if( $site["sharing_type"] == "DC power share, Common rectifier" )
	// 					$shr_type = "dc_ps_cr";
	// 				else if( $site["sharing_type"] == "DC power share, Separate rectifier" )
	// 					$shr_type = "dc_ps_sr";
	// 				else if( $site["sharing_type"] == "DG power share, Common rectifier" )
	// 					$shr_type = "dg_ps_cr";
	// 				// else if( $site["sharing_type"] == "DG power share, Separate rectifier" )
	// 				// 	$shr_type = "bl_own";
	// 			}

	// 			if( $shr_key != null )
	// 			{
	// 				$countspw["2g"]["shared"]["total"]++;
	// 				$countspw["2g"]["shared"][$shr_key]++;

	// 				$shared_2g[$shr_key]["total"]++;
	// 				if( $shr_key != null && $shr_type != null )
	// 				{
	// 					$shared_2g[$shr_key][$shr_type]++;
	// 				}
	// 			}

	// 			if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 			    $countspw["2g"]["macro"]++;
	// 			else
	// 				$countspw["2g"]["micro"]++;

	// 			if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
	// 			{
	// 				$countow[$site["om_office_id"]]["2g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					$countow[$site["om_office_id"]]["2g"]["macro"]++;
	// 				else
	// 					$countow[$site["om_office_id"]]["2g"]["micro"]++;
	// 			}

	// 			if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
	// 				$division_wise[$site["zone"]]["outage_2g"]++;

	// 			if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
	// 			{
	// 				$om_ofcs["in_house"][$site["om_office_id"]]["2g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["in_house"][$site["om_office_id"]]["2g"]["macro"]++;
	// 				else
	// 					$om_ofcs["in_house"][$site["om_office_id"]]["2g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["l2h"]["2g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["l2h"]["2g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["l2h"]["2g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["g2h"]["2g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["g2h"]["2g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["g2h"]["2g"]["micro"]++;
	// 				}
	// 			}
	// 			else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
	// 			{
	// 				$om_ofcs["msd"][$site["msd_office_id"]]["2g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["msd"][$site["msd_office_id"]]["2g"]["macro"]++;
	// 				else
	// 					$om_ofcs["msd"][$site["msd_office_id"]]["2g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["l2h"]["2g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["l2h"]["2g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["l2h"]["2g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["g2h"]["2g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["g2h"]["2g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["g2h"]["2g"]["micro"]++;
	// 				}
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_3go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			$countspw["3g"]["total"]++;
	// 			if( $site["om_office_type"] == 1 )
	// 				$countspw["3g"]["in_house"]["total"]++;
	// 			else if( $site["om_office_type"] == 2 )
	// 				$countspw["3g"]["msd"]["total"]++;

	// 			$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 			if( $dif >= 0 && $dif < (2*60*60) )
	// 			{
	// 				$countspw["3g"]["l2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["3g"]["in_house"]["l2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["3g"]["msd"]["l2h"]++;
	// 			}
	// 			else if( $dif >= (2*60*60) )
	// 			{
	// 				$countspw["3g"]["g2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["3g"]["in_house"]["g2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["3g"]["msd"]["g2h"]++;
	// 			}

	// 			$pkey = null;
	// 			if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
	// 				$pkey = "p1";
	// 			else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
	// 				$pkey = "p2";
	// 			else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
	// 				$pkey = "p3";

	// 			if( $pkey != null )
	// 			{
	// 				$countspw["3g"][$pkey]["total"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 				{
	// 					$countspw["3g"][$pkey]["in_house"]++;
	// 				}
	// 				else if( $site["om_office_type"] == 2 )
	// 				{
	// 					$countspw["3g"][$pkey]["msd"]++;
	// 				}
	// 			}

	// 			$shr_key = null;
	// 			if( $site["shared_operator"] == "AIRTEL" )
	// 				$shr_key = "airtel";
	// 			else if( $site["shared_operator"] == "GP" )
	// 				$shr_key = "gp";
	// 			else if( $site["shared_operator"] == "ROBI" )
	// 				$shr_key = "robi";
	// 			else if( $site["shared_operator"] == "STL" )
	// 				$shr_key = "stl";
	// 			else if( $site["shared_operator"] == "E.Co" )
	// 				$shr_key = "e_co";
	// 			else if( $site["shared_operator"] == "FTB" )
	// 				$shr_key = "ftb";
	// 			else if( $site["shared_operator"] == "KTBL" )
	// 				$shr_key = "ktbl";
	// 			else if( $site["shared_operator"] == "BTCL" )
	// 				$shr_key = "btcl";

	// 			if( $shr_key != null )
	// 			{
	// 				$countspw["3g"]["shared"]["total"]++;
	// 				$countspw["3g"]["shared"][$shr_key]++;
	// 			}

	// 			if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 			    $countspw["3g"]["macro"]++;
	// 			else
	// 				$countspw["3g"]["micro"]++;

	// 			if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
	// 			{
	// 				$countow[$site["om_office_id"]]["3g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					$countow[$site["om_office_id"]]["3g"]["macro"]++;
	// 				else
	// 					$countow[$site["om_office_id"]]["3g"]["micro"]++;
	// 			}

	// 			if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
	// 				$division_wise[$site["zone"]]["outage_3g"]++;

	// 			if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
	// 			{
	// 				$om_ofcs["in_house"][$site["om_office_id"]]["3g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["in_house"][$site["om_office_id"]]["3g"]["macro"]++;
	// 				else
	// 					$om_ofcs["in_house"][$site["om_office_id"]]["3g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["l2h"]["3g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["l2h"]["3g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["l2h"]["3g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["g2h"]["3g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["g2h"]["3g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["g2h"]["3g"]["micro"]++;
	// 				}
	// 			}
	// 			else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
	// 			{
	// 				$om_ofcs["msd"][$site["msd_office_id"]]["3g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["msd"][$site["msd_office_id"]]["3g"]["macro"]++;
	// 				else
	// 					$om_ofcs["msd"][$site["msd_office_id"]]["3g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["l2h"]["3g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["l2h"]["3g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["l2h"]["3g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["g2h"]["3g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["g2h"]["3g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["g2h"]["3g"]["micro"]++;
	// 				}
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["site_4go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			$countspw["4g"]["total"]++;
	// 			if( $site["om_office_type"] == 1 )
	// 				$countspw["4g"]["in_house"]["total"]++;
	// 			else if( $site["om_office_type"] == 2 )
	// 				$countspw["4g"]["msd"]["total"]++;

	// 			$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

	// 			if( $dif >= 0 && $dif < (2*60*60) )
	// 			{
	// 				$countspw["4g"]["l2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["4g"]["in_house"]["l2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["4g"]["msd"]["l2h"]++;
	// 			}
	// 			else if( $dif >= (2*60*60) )
	// 			{
	// 				$countspw["4g"]["g2h"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 					$countspw["4g"]["in_house"]["g2h"]++;
	// 				else if( $site["om_office_type"] == 2 )
	// 					$countspw["4g"]["msd"]["g2h"]++;
	// 			}

	// 			$pkey = null;
	// 			if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
	// 				$pkey = "p1";
	// 			else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
	// 				$pkey = "p2";
	// 			else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
	// 				$pkey = "p3";

	// 			if( $pkey != null )
	// 			{
	// 				$countspw["4g"][$pkey]["total"]++;
	// 				if( $site["om_office_type"] == 1 )
	// 				{
	// 					$countspw["4g"][$pkey]["in_house"]++;
	// 				}
	// 				else if( $site["om_office_type"] == 2 )
	// 				{
	// 					$countspw["4g"][$pkey]["msd"]++;
	// 				}
	// 			}

	// 			$shr_key = null;
	// 			if( $site["shared_operator"] == "AIRTEL" )
	// 				$shr_key = "airtel";
	// 			else if( $site["shared_operator"] == "GP" )
	// 				$shr_key = "gp";
	// 			else if( $site["shared_operator"] == "ROBI" )
	// 				$shr_key = "robi";
	// 			else if( $site["shared_operator"] == "STL" )
	// 				$shr_key = "stl";
	// 			else if( $site["shared_operator"] == "E.Co" )
	// 				$shr_key = "e_co";
	// 			else if( $site["shared_operator"] == "FTB" )
	// 				$shr_key = "ftb";
	// 			else if( $site["shared_operator"] == "KTBL" )
	// 				$shr_key = "ktbl";
	// 			else if( $site["shared_operator"] == "BTCL" )
	// 				$shr_key = "btcl";

	// 			if( $shr_key != null )
	// 			{
	// 				$countspw["4g"]["shared"]["total"]++;
	// 				$countspw["4g"]["shared"][$shr_key]++;
	// 			}

	// 			if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 			    $countspw["4g"]["macro"]++;
	// 			else
	// 				$countspw["4g"]["micro"]++;

	// 			if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
	// 			{
	// 				$countow[$site["om_office_id"]]["4g"]["total"]++;
	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					$countow[$site["om_office_id"]]["4g"]["macro"]++;
	// 				else
	// 					$countow[$site["om_office_id"]]["4g"]["micro"]++;
	// 			}

	// 			if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
	// 				$division_wise[$site["zone"]]["outage_4g"]++;

	// 			if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
	// 			{
	// 				$om_ofcs["in_house"][$site["om_office_id"]]["4g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["in_house"][$site["om_office_id"]]["4g"]["macro"]++;
	// 				else
	// 					$om_ofcs["in_house"][$site["om_office_id"]]["4g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["l2h"]["4g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["l2h"]["4g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["l2h"]["4g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["in_house_t"]["g2h"]["4g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["in_house_t"]["g2h"]["4g"]["macro"]++;
	// 					else
	// 						$om_ofcs["in_house_t"]["g2h"]["4g"]["micro"]++;
	// 				}
	// 			}
	// 			else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
	// 			{
	// 				$om_ofcs["msd"][$site["msd_office_id"]]["4g"]["total"]++;

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $om_ofcs["msd"][$site["msd_office_id"]]["4g"]["macro"]++;
	// 				else
	// 					$om_ofcs["msd"][$site["msd_office_id"]]["4g"]["micro"]++;

	// 				if( $dif >= 0 && $dif < (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["l2h"]["4g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["l2h"]["4g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["l2h"]["4g"]["micro"]++;
	// 				}
	// 				else if( $dif >= (2*60*60) )
	// 				{
	// 					$om_ofcs["msd_t"]["g2h"]["4g"]["total"]++;
	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $om_ofcs["msd_t"]["g2h"]["4g"]["macro"]++;
	// 					else
	// 						$om_ofcs["msd_t"]["g2h"]["4g"]["micro"]++;
	// 				}
	// 			}
	// 		}
	// 	}

	// 	foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["om_office_type"] == 1 )
	// 				$counts["power"]["in_house"]++;
	// 			else if( $site["om_office_type"] == 2 )
	// 				$counts["power"]["msd"]++;
	// 		}
	// 	}

	// 	// for 2G
	// 	$sheet->getCell('B4')->setValue('P1: '.($counts["p1"]["in_house"]+$counts["p1"]["msd"]).' (FLM:'.$counts["p1"]["msd"].', In-House:'.$counts["p1"]["in_house"].')');
	// 	$sheet->getCell('B5')->setValue('P2: '.($counts["p2"]["in_house"]+$counts["p2"]["msd"]).' (FLM:'.$counts["p2"]["msd"].', In-House:'.$counts["p2"]["in_house"].')');
	// 	$sheet->getCell('B6')->setValue('P3: '.($counts["p3"]["in_house"]+$counts["p3"]["msd"]).' (FLM:'.$counts["p3"]["msd"].', In-House:'.$counts["p3"]["in_house"].')');
	// 	$sheet->getCell('B7')->setValue('Grand Total: '.( ($counts["p1"]["in_house"]+$counts["p1"]["msd"]) + ($counts["p2"]["in_house"]+$counts["p2"]["msd"]) + ($counts["p3"]["in_house"]+$counts["p3"]["msd"]) ).' (FLM:'.( $counts["p1"]["msd"] + $counts["p2"]["msd"] + $counts["p3"]["msd"] ).', In-House:'.( $counts["p1"]["in_house"] + $counts["p2"]["in_house"] + $counts["p3"]["in_house"] ).')');
	// 	$sheet->getCell('B8')->setValue('Total Power Alarm: '.($counts["power"]["in_house"]+$counts["power"]["msd"]).' (FLM:'.$counts["power"]["msd"].', In-House:'.$counts["power"]["in_house"].')');

	// 	$sheet->getCell('B15')->setValue('General SMS');
	// 	$sheet->getCell('B16')->setValue('Network Update on '.$selhs);

	// 	$sheet->getStyle('B15:B16')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('B15:B16')->applyFromArray($ha_style);


	// 	$sheet->getCell('B18')->setValue('Sites with no commercial power- '.($counts["power"]["in_house"]+$counts["power"]["msd"]).' (FLM:'.$counts["power"]["msd"].', In-House:'.$counts["power"]["in_house"].')');

	// 	$sheet->getCell('B20')->setValue('Site outages: 2G, 3G, 4G (>2Hrs / <2Hrs)');

	// 	$sheet->getCell('B21')->setValue('Total- '.$countspw["2g"]["total"].','.$countspw["3g"]["total"].','.$countspw["4g"]["total"].' ('.$countspw["2g"]["g2h"].','.$countspw["3g"]["g2h"].','.$countspw["4g"]["g2h"].'/'.$countspw["2g"]["l2h"].','.$countspw["3g"]["l2h"].','.$countspw["4g"]["l2h"].')');

	// 	$sheet->getCell('B22')->setValue('FLM- '.$countspw["2g"]["msd"]["total"].','.$countspw["3g"]["msd"]["total"].','.$countspw["4g"]["msd"]["total"].' ('.$countspw["2g"]["msd"]["g2h"].','.$countspw["3g"]["msd"]["g2h"].','.$countspw["4g"]["msd"]["g2h"].'/'.$countspw["2g"]["msd"]["l2h"].','.$countspw["3g"]["msd"]["l2h"].','.$countspw["4g"]["msd"]["l2h"].')');

	// 	$sheet->getCell('B23')->setValue('In-House- '.$countspw["2g"]["in_house"]["total"].','.$countspw["3g"]["in_house"]["total"].','.$countspw["4g"]["in_house"]["total"].' ('.$countspw["2g"]["in_house"]["g2h"].','.$countspw["3g"]["in_house"]["g2h"].','.$countspw["4g"]["in_house"]["g2h"].'/'.$countspw["2g"]["in_house"]["l2h"].','.$countspw["3g"]["in_house"]["l2h"].','.$countspw["4g"]["in_house"]["l2h"].')');



	// 	$sheet->getCell('B25')->setValue('Site outages priority sites: 2G, 3G, 4G (FLM/ In-House)');
	// 	$sheet->getCell('B26')->setValue('P1: '.$countspw["2g"]["p1"]["total"].','.$countspw["3g"]["p1"]["total"].','.$countspw["4g"]["p1"]["total"].' ('.$countspw["2g"]["p1"]["msd"].','.$countspw["3g"]["p1"]["msd"].','.$countspw["4g"]["p1"]["msd"].'/'.$countspw["2g"]["p1"]["in_house"].','.$countspw["3g"]["p1"]["in_house"].','.$countspw["4g"]["p1"]["in_house"].')');

	// 	$sheet->getCell('B27')->setValue('P2: '.$countspw["2g"]["p2"]["total"].','.$countspw["3g"]["p2"]["total"].','.$countspw["4g"]["p2"]["total"].' ('.$countspw["2g"]["p2"]["msd"].','.$countspw["3g"]["p2"]["msd"].','.$countspw["4g"]["p2"]["msd"].'/'.$countspw["2g"]["p2"]["in_house"].','.$countspw["3g"]["p2"]["in_house"].','.$countspw["4g"]["p2"]["in_house"].')');

	// 	$sheet->getCell('B28')->setValue('P3: '.$countspw["2g"]["p3"]["total"].','.$countspw["3g"]["p3"]["total"].','.$countspw["4g"]["p3"]["total"].' ('.$countspw["2g"]["p3"]["msd"].','.$countspw["3g"]["p3"]["msd"].','.$countspw["4g"]["p3"]["msd"].'/'.$countspw["2g"]["p3"]["in_house"].','.$countspw["3g"]["p3"]["in_house"].','.$countspw["4g"]["p3"]["in_house"].')');


	// 	$sheet->getCell('B30')->setValue('Major outages: 2G, 3G, 4G (Macro/ Micro)');
	// 	$rin = 30;
	// 	foreach ($countow as $ofc_data)
	// 	{
	// 		if( $ofc_data["2g"]["total"] > 10 || $ofc_data["3g"]["total"] > 10 || $ofc_data["4g"]["total"] > 10 )
	// 		{
	// 			$rin++;
	// 			$sheet->getCell('B'.$rin)->setValue( $ofc_data["name"].': '.$ofc_data["2g"]["total"].','.$ofc_data["3g"]["total"].','.$ofc_data["4g"]["total"].' ('.$ofc_data["2g"]["macro"].','.$ofc_data["3g"]["macro"].','.$ofc_data["4g"]["macro"].'/'.$ofc_data["2g"]["micro"].','.$ofc_data["3g"]["micro"].','.$ofc_data["4g"]["micro"].')');
	// 		}
	// 	}

	// 	$rin++;
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('Shared Sites Down: 2G, 3G, 4G');
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('Total: '.$countspw["2g"]["shared"]["total"].','.$countspw["3g"]["shared"]["total"].','.$countspw["4g"]["shared"]["total"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('GP: '.$countspw["2g"]["shared"]["gp"].','.$countspw["3g"]["shared"]["gp"].','.$countspw["4g"]["shared"]["gp"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('ROBI: '.$countspw["2g"]["shared"]["robi"].','.$countspw["3g"]["shared"]["robi"].','.$countspw["4g"]["shared"]["robi"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('AIRTEL: '.$countspw["2g"]["shared"]["airtel"].','.$countspw["3g"]["shared"]["airtel"].','.$countspw["4g"]["shared"]["airtel"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('STL: '.$countspw["2g"]["shared"]["stl"].','.$countspw["3g"]["shared"]["stl"].','.$countspw["4g"]["shared"]["stl"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('E.Co: '.$countspw["2g"]["shared"]["e_co"].','.$countspw["3g"]["shared"]["e_co"].','.$countspw["4g"]["shared"]["e_co"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('FTB: '.$countspw["2g"]["shared"]["ftb"].','.$countspw["3g"]["shared"]["ftb"].','.$countspw["4g"]["shared"]["ftb"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('KTBL: '.$countspw["2g"]["shared"]["ktbl"].','.$countspw["3g"]["shared"]["ktbl"].','.$countspw["4g"]["shared"]["ktbl"]);
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('BTCL: '.$countspw["2g"]["shared"]["btcl"].','.$countspw["3g"]["shared"]["btcl"].','.$countspw["4g"]["shared"]["btcl"]);

	// 	$rin++;
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue('Total site outages: 2G, 3G, 4G (Macro/ Micro)');

	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-3 hours", @strtotime($sel_ts))).'Hrs: '.$sel3b_tmm_stats["2g"]["total"].','.$sel3b_tmm_stats["3g"]["total"].','.$sel3b_tmm_stats["4g"]["total"].' ('.$sel3b_tmm_stats["2g"]["macro"].','.$sel3b_tmm_stats["3g"]["macro"].','.$sel3b_tmm_stats["4g"]["macro"].'/'.$sel3b_tmm_stats["2g"]["micro"].','.$sel3b_tmm_stats["3g"]["micro"].','.$sel3b_tmm_stats["3g"]["micro"].')');
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-2 hours", @strtotime($sel_ts))).'Hrs: '.$sel2b_tmm_stats["2g"]["total"].','.$sel2b_tmm_stats["3g"]["total"].','.$sel2b_tmm_stats["4g"]["total"].' ('.$sel2b_tmm_stats["2g"]["macro"].','.$sel2b_tmm_stats["3g"]["macro"].','.$sel2b_tmm_stats["4g"]["macro"].'/'.$sel2b_tmm_stats["2g"]["micro"].','.$sel2b_tmm_stats["3g"]["micro"].','.$sel2b_tmm_stats["4g"]["micro"].')');
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-1 hours", @strtotime($sel_ts))).'Hrs: '.$sel1b_tmm_stats["2g"]["total"].','.$sel1b_tmm_stats["3g"]["total"].','.$sel1b_tmm_stats["4g"]["total"].' ('.$sel1b_tmm_stats["2g"]["macro"].','.$sel1b_tmm_stats["3g"]["macro"].','.$sel1b_tmm_stats["4g"]["macro"].'/'.$sel1b_tmm_stats["2g"]["micro"].','.$sel1b_tmm_stats["3g"]["micro"].','.$sel1b_tmm_stats["4g"]["micro"].')');
	// 	$rin++;
	// 	$sheet->getCell('B'.$rin)->setValue($selhs.': '.$countspw["2g"]["total"].','.$countspw["3g"]["total"].','.$countspw["4g"]["total"].' ('.$countspw["2g"]["macro"].','.$countspw["3g"]["macro"].','.$countspw["4g"]["macro"].'/'.$countspw["2g"]["micro"].','.$countspw["3g"]["micro"].','.$countspw["4g"]["micro"].')');




	// 	$sheet->getCell('C2')->setValue('Division SMS');
	// 	$sheet->getCell('C3')->setValue('% of Division wise 2G sites Down at '.$selhs);

	// 	$rin = 4;
	// 	foreach ($division_wise as $dname => $ddata)
	// 	{
	// 		$perc = 0;
	// 		if( $ddata["total_2g"] > 0 )
	// 		{
	// 			$perc = round( ( ($ddata["outage_2g"]*100)/$ddata["total_2g"] ), 2);
	// 		}

	// 		if( $perc > 1 )
	// 		{
	// 			$sheet->getCell('C'.$rin)->setValue($dname.': '.$perc.'%');
	// 			$rin++;
	// 		}
	// 	}



	// 	$sheet->getCell('D2')->setValue('In house SMS');
	// 	$sheet->getCell('D3')->setValue('In-House 2G(Macro/Micro):3G(Macro/Micro):4G(Macro/Micro) Down at '.$selhs);

	// 	$rin = 4;
	// 	foreach ($om_ofcs["in_house"] as $oname => $odata)
	// 	{
	// 		if( $odata["2g"]["total"] > 0 || $odata["3g"]["total"] > 0 || $odata["4g"]["total"] > 0 )
	// 		{
	// 			$sheet->getCell('D'.$rin)->setValue($odata["name"].': '.$odata["2g"]["total"].'('.$odata["2g"]["macro"].'/'.$odata["2g"]["micro"].'),'.$odata["3g"]["total"].'('.$odata["3g"]["macro"].'/'.$odata["3g"]["micro"].'),'.$odata["4g"]["total"].'('.$odata["4g"]["macro"].'/'.$odata["4g"]["micro"].')');
	// 			$rin++;
	// 		}
	// 	}

	// 	$sheet->getCell('D'.$rin)->setValue('>=2Hrs: '.$om_ofcs["in_house_t"]["g2h"]["2g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["2g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["2g"]["micro"].'),'.$om_ofcs["in_house_t"]["g2h"]["3g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["3g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["3g"]["micro"].'),'.$om_ofcs["in_house_t"]["g2h"]["4g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["4g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["4g"]["micro"].')');
	// 	$rin++;

	// 	$sheet->getCell('D'.$rin)->setValue('<2Hrs: '.$om_ofcs["in_house_t"]["l2h"]["2g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["2g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["2g"]["micro"].'),'.$om_ofcs["in_house_t"]["l2h"]["3g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["3g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["3g"]["micro"].'),'.$om_ofcs["in_house_t"]["l2h"]["4g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["4g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["4g"]["micro"].')');


	// 	$sheet->getCell('E2')->setValue('FLM SMS');
	// 	$sheet->getCell('E3')->setValue('FLM 2G(Macro/Micro):3G(Macro/Micro) Down at '.$selhs);

	// 	$rin = 4;
	// 	foreach ($om_ofcs["msd"] as $oname => $odata)
	// 	{
	// 		if( $odata["2g"]["total"] > 0 || $odata["3g"]["total"] > 0 )
	// 		{
	// 			$sheet->getCell('E'.$rin)->setValue($odata["name"].': '.$odata["2g"]["total"].'('.$odata["2g"]["macro"].'/'.$odata["2g"]["micro"].'),'.$odata["3g"]["total"].'('.$odata["3g"]["macro"].'/'.$odata["3g"]["micro"].'),'.$odata["4g"]["total"].'('.$odata["4g"]["macro"].'/'.$odata["4g"]["micro"].')');
	// 			$rin++;
	// 		}
	// 	}

	// 	$sheet->getCell('E'.$rin)->setValue('>=2Hrs: '.$om_ofcs["msd_t"]["g2h"]["2g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["2g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["2g"]["micro"].'),'.$om_ofcs["msd_t"]["g2h"]["3g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["3g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["3g"]["micro"].'),'.$om_ofcs["msd_t"]["g2h"]["4g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["4g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["4g"]["micro"].')');
	// 	$rin++;

	// 	$sheet->getCell('E'.$rin)->setValue('<2Hrs: '.$om_ofcs["msd_t"]["l2h"]["2g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["2g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["2g"]["micro"].'),'.$om_ofcs["msd_t"]["l2h"]["3g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["3g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["3g"]["micro"].'),'.$om_ofcs["msd_t"]["l2h"]["4g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["4g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["4g"]["micro"].')');



	// 	$sheet->getCell('F2')->setValue('Shared Site down');
	// 	$sheet->getCell('F3')->setValue('2G Shared Sites Down at '.$selhs);
		
	// 	$sheet->getCell('F4')->setValue('GP: '.$shared_2g["gp"]["total"].' (BL Own:'.$shared_2g["gp"]["bl_own"].', AC PS:'.$shared_2g["gp"]["ac_ps"].', DC PS[CR]:'.$shared_2g["gp"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["gp"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["gp"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F5')->setValue('ROBI: '.$shared_2g["robi"]["total"].' (BL Own:'.$shared_2g["robi"]["bl_own"].', AC PS:'.$shared_2g["robi"]["ac_ps"].', DC PS[CR]:'.$shared_2g["robi"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["robi"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["robi"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F6')->setValue('AIRTEL: '.$shared_2g["airtel"]["total"].' (BL Own:'.$shared_2g["airtel"]["bl_own"].', AC PS:'.$shared_2g["airtel"]["ac_ps"].', DC PS[CR]:'.$shared_2g["airtel"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["airtel"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["airtel"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F7')->setValue('STL: '.$shared_2g["stl"]["total"].' (BL Own:'.$shared_2g["stl"]["bl_own"].', AC PS:'.$shared_2g["stl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["stl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["stl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["stl"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F8')->setValue('E.Co: '.$shared_2g["e_co"]["total"].' (BL Own:'.$shared_2g["e_co"]["bl_own"].', AC PS:'.$shared_2g["e_co"]["ac_ps"].', DC PS[CR]:'.$shared_2g["e_co"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["e_co"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["e_co"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F9')->setValue('FTB: '.$shared_2g["ftb"]["total"].' (BL Own:'.$shared_2g["ftb"]["bl_own"].', AC PS:'.$shared_2g["ftb"]["ac_ps"].', DC PS[CR]:'.$shared_2g["ftb"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["ftb"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["ftb"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F10')->setValue('KTBL: '.$shared_2g["ktbl"]["total"].' (BL Own:'.$shared_2g["ktbl"]["bl_own"].', AC PS:'.$shared_2g["ktbl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["ktbl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["ktbl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["ktbl"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F10')->setValue('BTCL: '.$shared_2g["btcl"]["total"].' (BL Own:'.$shared_2g["btcl"]["bl_own"].', AC PS:'.$shared_2g["btcl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["btcl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["btcl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["btcl"]["dg_ps_cr"].')');

	// 	$sheet->getCell('F11')->setValue('Total: '.( $shared_2g["gp"]["total"] + $shared_2g["robi"]["total"] + $shared_2g["airtel"]["total"] + $shared_2g["stl"]["total"] + $shared_2g["e_co"]["total"] + $shared_2g["ftb"]["total"] + $shared_2g["ktbl"]["total"] + $shared_2g["btcl"]["total"] )
	// 		.' (BL Own:'.( $shared_2g["gp"]["bl_own"] + $shared_2g["robi"]["bl_own"] + $shared_2g["airtel"]["bl_own"] + $shared_2g["stl"]["bl_own"] + $shared_2g["e_co"]["bl_own"] + $shared_2g["ftb"]["bl_own"] + $shared_2g["ktbl"]["bl_own"] + $shared_2g["btcl"]["bl_own"] )
	// 		.', AC PS:'.( $shared_2g["gp"]["ac_ps"] + $shared_2g["robi"]["ac_ps"] + $shared_2g["airtel"]["ac_ps"] + $shared_2g["stl"]["ac_ps"] + $shared_2g["e_co"]["ac_ps"] + $shared_2g["ftb"]["ac_ps"] + $shared_2g["ktbl"]["ac_ps"] + $shared_2g["btcl"]["ac_ps"] )
	// 		.', DC PS[CR]:'.( $shared_2g["gp"]["dc_ps_cr"] + $shared_2g["robi"]["dc_ps_cr"] + $shared_2g["airtel"]["dc_ps_cr"] + $shared_2g["stl"]["dc_ps_cr"] + $shared_2g["e_co"]["dc_ps_cr"] + $shared_2g["ftb"]["dc_ps_cr"] + $shared_2g["ktbl"]["dc_ps_cr"] + $shared_2g["btcl"]["dc_ps_cr"] )
	// 		.', DC PS[SR]:'.( $shared_2g["gp"]["dc_ps_sr"] + $shared_2g["robi"]["dc_ps_sr"] + $shared_2g["airtel"]["dc_ps_sr"] + $shared_2g["stl"]["dc_ps_sr"] + $shared_2g["e_co"]["dc_ps_sr"] + $shared_2g["ftb"]["dc_ps_sr"] + $shared_2g["ktbl"]["dc_ps_sr"] + $shared_2g["btcl"]["dc_ps_sr"] )
	// 		.', DG PS[CR]:'.( $shared_2g["gp"]["dg_ps_cr"] + $shared_2g["robi"]["dg_ps_cr"] + $shared_2g["airtel"]["dg_ps_cr"] + $shared_2g["stl"]["dg_ps_cr"] + $shared_2g["e_co"]["dg_ps_cr"] + $shared_2g["ftb"]["dg_ps_cr"] + $shared_2g["ktbl"]["dg_ps_cr"] + $shared_2g["btcl"]["dg_ps_cr"] ).')');
		

	// 	$sw_2g_out = array();
	// 	$sw_3g_out = array();
	// 	$sw_4g_out = array();

	// 	foreach ($outages as $outage)
	// 	{
	// 		$onact = false;
	// 		if( $outage["running"] )
	// 		{
	// 			if( @strtotime($outage["start_time"]) <= @strtotime($sel_ts) )
	// 				$onact = true;
	// 		}
	// 		else
	// 		{
	// 			if( @strtotime($outage["start_time"]) <= @strtotime($sel_ts) && @strtotime($outage["end_time"]) >= @strtotime($sel_ts) )
	// 				$onact = true;
	// 		}

	// 		if( $onact )
	// 		{
	// 			$tvrname = null;
	// 			if( $outage["technology"] == "2G" )
	// 				$tvrname = "sw_2g_out";
	// 			else if( $outage["technology"] == "3G" )
	// 				$tvrname = "sw_3g_out";
	// 			else if( $outage["technology"] == "4G" )
	// 				$tvrname = "sw_4g_out";

	// 			if( $tvrname != null )
	// 			{
	// 				if( !isset(${$tvrname}[$outage["site_id"]]) )
	// 				{
	// 					${$tvrname}[$outage["site_id"]] = array();
	// 					${$tvrname}[$outage["site_id"]]["site"] = null;
	// 					${$tvrname}[$outage["site_id"]]["cells"] = array();
	// 				}

	// 				if( ${$tvrname}[$outage["site_id"]]["site"] == null && ($outage["type"] == "site" || $outage["type"] == "site_by_cell")  )
	// 				{
	// 					${$tvrname}[$outage["site_id"]]["site"] = $outage;
	// 				}
	// 				else if( $outage["cell_name"] != null && !isset(${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]]) 
	// 					&& $outage["type"] == "cell" )
	// 				{
	// 					${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]] = $outage;
	// 				}
	// 			}
	// 		}
	// 	}

	// 	$ro_wise_sd = array();
	// 	$ros = array('RO-1','RO-2','RO-3','RO-4','RO-5','RO-6');
	// 	foreach ($ros as $ro)
	// 	{
	// 		$ro_wise_sd [$ro] = array(
	// 			"2g"=>array(
	// 				"site"=>array(),
	// 				"cell"=>array(),
	// 			),
	// 			"3g"=>array(
	// 				"site"=>array(),
	// 				"cell"=>array(),
	// 			),
	// 			"4g"=>array(
	// 				"site"=>array(),
	// 				"cell"=>array(),
	// 			),
	// 			"hub_power"=>array(),
	// 		);
	// 	}

	// 	for ($i=2; $i <= 4; $i++)
	// 	{
	// 		$tvrname = "sw_".$i."g_out";
	// 		foreach (${$tvrname} as $sid => $site_outs)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];
	// 				if( $site["ro"] != null && isset($ro_wise_sd[$site["ro"]]) )
	// 				{
	// 					if( $site_outs["site"] != null )
	// 					{
	// 						$sde = array();
	// 						$sde["site_id"] = $sid;
	// 						$sde["site_code"] = $site["site_code_".$i."g"];
	// 						$sde["priority"] = $site["site_priority"];
	// 						$sde["start_time"] = date("d/m H:i", @strtotime($site_outs["site"]["start_time"]) );
	// 						$sde["office_code"] = null;
	// 						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 						{
	// 							$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
	// 						}
	// 						$ro_wise_sd[$site["ro"]][$i."g"]["site"][] = $sde;
	// 					}
	// 					else if( sizeof($site_outs["cells"]) > 0 )
	// 					{
	// 						foreach ($site_outs["cells"] as $cell_name => $cell_out)
	// 						{
	// 							$sde = array();
	// 							$sde["site_id"] = $sid;
	// 							$sde["site_code"] = $site["site_code_".$i."g"];
	// 							$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
	// 							$sde["priority"] = $site["site_priority"];
	// 							$sde["start_time"] = date("d/m H:i", @strtotime($cell_out["start_time"]) );
	// 							$sde["office_code"] = null;
	// 							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 							{
	// 								$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
	// 							}
	// 							$ro_wise_sd[$site["ro"]][$i."g"]["cell"][] = $sde;
	// 						}
	// 					}
	// 				}
	// 			}
	// 		}
	// 	}

	// 	$sheet->getCell('G2')->setValue('RO wise site Down SMS');

	// 	$rin = 3;
	// 	foreach ($ro_wise_sd as $ro_name => $ro_outs)
	// 	{
	// 		$sheet->getCell('G'.$rin)->setValue('Site Down List of '.$ro_name.' at '.$selhs.' (2G-'.sizeof($ro_outs["2g"]["site"]).',3G-'.sizeof($ro_outs["3g"]["site"]).',4G-'.sizeof($ro_outs["4g"]["site"]).')');
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["2g"]["site"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["2g"]["site"] as $site_down)
	// 			{
	// 				$col_data .= $site_down["site_code"];
	// 				$col_data .= " (".$site_down["priority"].")";
	// 				$col_data .= " ".$site_down["start_time"];
	// 				$col_data .= "-".$site_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('G'.$rin)->setValue('2G: '.$col_data);
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["3g"]["site"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["3g"]["site"] as $site_down)
	// 			{
	// 				$col_data .= $site_down["site_code"];
	// 				$col_data .= " (".$site_down["priority"].")";
	// 				$col_data .= " ".$site_down["start_time"];
	// 				$col_data .= "-".$site_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('G'.$rin)->setValue('3G: '.$col_data);
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["4g"]["site"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["4g"]["site"] as $site_down)
	// 			{
	// 				$col_data .= $site_down["site_code"];
	// 				$col_data .= " (".$site_down["priority"].")";
	// 				$col_data .= " ".$site_down["start_time"];
	// 				$col_data .= "-".$site_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('G'.$rin)->setValue('4G: '.$col_data);
	// 		$rin++;
	// 		$rin++;
	// 	}

	// 	$sheet->getCell('H2')->setValue('RO wise Cell SMS');
		
	// 	$rin = 3;
	// 	foreach ($ro_wise_sd as $ro_name => $ro_outs)
	// 	{
	// 		$sheet->getCell('H'.$rin)->setValue('Cell Down List of '.$ro_name.' at '.$selhs.' (2G-'.sizeof($ro_outs["2g"]["cell"]).',3G-'.sizeof($ro_outs["3g"]["cell"]).',4G-'.sizeof($ro_outs["4g"]["cell"]).')');
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["2g"]["cell"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["2g"]["cell"] as $cell_down)
	// 			{
	// 				$col_data .= $cell_down["cell_code"];
	// 				$col_data .= " (".$cell_down["priority"].")";
	// 				$col_data .= " ".$cell_down["start_time"];
	// 				$col_data .= "-".$cell_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('H'.$rin)->setValue('2G: '.$col_data);
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["3g"]["cell"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["3g"]["cell"] as $cell_down)
	// 			{
	// 				$col_data .= $cell_down["cell_code"];
	// 				$col_data .= " (".$cell_down["priority"].")";
	// 				$col_data .= " ".$cell_down["start_time"];
	// 				$col_data .= "-".$cell_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('H'.$rin)->setValue('3G: '.$col_data);
	// 		$rin++;

	// 		$col_data = "";
	// 		if( sizeof($ro_outs["4g"]["cell"]) > 0 )
	// 		{
	// 			foreach ($ro_outs["4g"]["cell"] as $cell_down)
	// 			{
	// 				$col_data .= $cell_down["cell_code"];
	// 				$col_data .= " (".$cell_down["priority"].")";
	// 				$col_data .= " ".$cell_down["start_time"];
	// 				$col_data .= "-".$cell_down["office_code"];
	// 				$col_data .= "\n";
	// 			}
	// 		}
	// 		else
	// 			$col_data = "Null";
	// 		$sheet->getCell('H'.$rin)->setValue('4G: '.$col_data);
	// 		$rin++;
	// 		$rin++;
	// 	}

	// 	foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if( $site["ro"] != null && isset($ro_wise_sd[$site["ro"]]) && $site["no_of_sites"] != null && $site["no_of_sites"] >= 5 )
	// 			{
	// 				$sde = array();
	// 				$sde["site_id"] = $sid;
	// 				$sde["site_code"] = $site["site_code_2g"];
	// 				$sde["priority"] = $site["site_priority"];
	// 				$sde["start_time"] = date("d/m H:i", @strtotime($alrm_tm["alarm_raised_time"]) );
	// 				$sde["office_code"] = null;
	// 				if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 				{
	// 					$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
	// 				}
	// 				$ro_wise_sd[$site["ro"]]["hub_power"][] = $sde;
	// 			}
	// 		}
	// 	}

	// 	$sheet->getCell('I2')->setValue('RO wise Hub site SMS');

	// 	$rin = 3;
	// 	foreach ($ro_wise_sd as $ro_name => $ro_outs)
	// 	{
	// 		$sheet->getCell('I'.$rin)->setValue('Power alarm HUB Site- '.$ro_name.' at '.$selhs.' -'.sizeof($ro_outs["hub_power"]) );
	// 		$rin++;

	// 		$col_data = "";
	// 		foreach ($ro_outs["hub_power"] as $power_down)
	// 		{
	// 			$col_data .= $power_down["site_code"];
	// 			$col_data .= " (".$power_down["priority"].")";
	// 			$col_data .= " ".$power_down["start_time"];
	// 			$col_data .= "-".$power_down["office_code"];
	// 			$col_data .= "\n";
	// 		}
	// 		$sheet->getCell('I'.$rin)->setValue($col_data);
	// 		$rin++;
	// 		$rin++;
	// 	}

	// 	$sheet->getStyle('B2:I2')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('B2:I2')->applyFromArray($ha_style);

	//     $border_style = array(
	// 		'borders' => array(
	// 			'allborders' => array(
	// 				'style' => PHPExcel_Style_Border::BORDER_THIN,
	// 			)
	// 		)
	// 	);

	//     $sheet->getCell('L2')->setValue('DG 2G Sites Down at '.$selhs);
	// 	$sheet->mergeCells('L2:S2');

	// 	$sheet->getCell('L3')->setValue('Sitecode');
	// 	$sheet->getCell('M3')->setValue('Priority');
	// 	$sheet->getCell('N3')->setValue('Office');
	// 	$sheet->getCell('O3')->setValue('RO');
	// 	$sheet->getCell('P3')->setValue('Appear Time');
	// 	$sheet->getCell('Q3')->setValue('Effect');
	// 	$sheet->getCell('R3')->setValue('Power Status');
	// 	$sheet->getCell('S3')->setValue('PowerAlarmStatus');

	// 	$sheet->getStyle('L2:S3')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('L2:S3')->applyFromArray($ha_style);

	// 	$rin = 4;
	// 	foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if ( $site["power_status"] != null && ( @strpos(@strtolower($site["power_status"]), 'dg') !== false || @strpos(@strtolower($site["power_status"]), 'generator') !== false ) )
	// 			{
	// 				$sheet->getCell('L'.$rin)->setValue( $site["site_code_2g"] );
	// 				$sheet->getCell('M'.$rin)->setValue( $site["site_priority"] );

	// 				if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 				{
	// 					$sheet->getCell('N'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
	// 				}
	// 				else
	// 				{
	// 					$sheet->getCell('N'.$rin)->setValue('');
	// 				}
					
	// 				$sheet->getCell('O'.$rin)->setValue( $site["ro"] );
	// 				$sheet->getCell('P'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outage_tm)) ) );
	// 				$sheet->getStyle('P'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

	// 				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 				    $sheet->getCell('Q'.$rin)->setValue( "Site Down" );
	// 				else
	// 					$sheet->getCell('Q'.$rin)->setValue( "Micro BTS Down" );

					
	// 				$sheet->getCell('R'.$rin)->setValue($site["power_status"]);

	// 				$power_slogans = array();
	// 				if( isset($sel_hours_stats["power_sites"][$sid]) )
	// 				{
	// 					$power_slogans [] = $sel_hours_stats["power_sites"][$sid]["slogan"];
	// 				}

	// 				if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
	// 				{
	// 					$power_slogans [] = $sel_hours_stats["lowvoltage_sites"][$sid]["slogan"];
	// 				}

	// 				$sheet->getCell('S'.$rin)->setValue(implode(" / ", $power_slogans));
	// 				$rin++;
	// 			}
	// 		}
	// 	}
	// 	$sheet->getStyle("L2:S".($rin-1))->applyFromArray($border_style);


	//     $g4h_sds = array();
	//     $g4h_cds = array();
	//     for ($i=2; $i <= 4; $i++)
	// 	{
	// 		$tvrname = "sw_".$i."g_out";
	// 		foreach (${$tvrname} as $sid => $site_outs)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];
	// 				if( $site_outs["site"] != null )
	// 				{
	// 					$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);
	// 					if( $dif > (4*60*60) )
	// 					{
	// 						$sde = array();
	// 						$sde["site_id"] = $sid;
	// 						$sde["site_code"] = $site["site_code_".$i."g"];
	// 						$sde["technology"] = $i."G";
	// 						$sde["priority"] = $site["site_priority"];
	// 						$sde["appear_time"] = $site_outs["site"]["start_time"];
	// 						$sde["duration_sec"] = $dif;
	// 						$sde["duration_hm"] = round($dif/(60*60), 2);
	// 						$sde["office"] = null;
	// 						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 						{
	// 							$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
	// 						}
	// 						$sde["ro"] = $site["ro"];

	// 						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 						    $sde["effect"] = "Site Down";
	// 						else
	// 							$sde["effect"] = "Micro BTS Down";

	// 						$g4h_sds [] = $sde;
	// 					}
	// 				}
	// 				else if ( sizeof($site_outs["cells"]) > 0 )
	// 				{
	// 					foreach ($site_outs["cells"] as $cell_name => $cell_out)
	// 					{
	// 						$dif = @strtotime($sel_ts) - @strtotime($cell_out["start_time"]);
	// 						if( $dif > (4*60*60) )
	// 						{
	// 							$sde = array();
	// 							$sde["site_id"] = $sid;
	// 							$sde["site_code"] = $site["site_code_".$i."g"];
	// 							$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
	// 							$sde["technology"] = $i."G";
	// 							$sde["priority"] = $site["site_priority"];
	// 							$sde["appear_time"] = $cell_out["start_time"];
	// 							$sde["duration_sec"] = $dif;
	// 							$sde["duration_hm"] = round($dif/(60*60), 2);
	// 							$sde["office"] = null;
	// 							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 							{
	// 								$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
	// 							}
	// 							$sde["ro"] = $site["ro"];
	// 							$sde["effect"] = "1 Cell (".$cell_name.") Down";

	// 							$g4h_cds [] = $sde;
	// 						}
	// 					}
	// 				}
	// 			}
	// 		}
	// 	}

	// 	usort($g4h_sds, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	// 	usort($g4h_cds, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	// 	$sheet->getCell('V2')->setValue('>4Hours Sites Down at '.$selhs);
	// 	$sheet->mergeCells('V2:AC2');

	// 	$sheet->getCell('V3')->setValue('Sitecode');
	// 	$sheet->getCell('W3')->setValue('Technology');
	// 	$sheet->getCell('X3')->setValue('Priority');
	// 	$sheet->getCell('Y3')->setValue('Office');
	// 	$sheet->getCell('Z3')->setValue('RO');
	// 	$sheet->getCell('AA3')->setValue('Appear Time');
	// 	$sheet->getCell('AB3')->setValue('Duration (Hrs)');
	// 	$sheet->getCell('AC3')->setValue('Effect');

	// 	$sheet->getStyle('V2:AC3')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('V2:AC3')->applyFromArray($ha_style);

	//     $rin = 4;
	//     foreach ($g4h_sds as $sd)
	//     {
	//     	$sheet->getCell('V'.$rin)->setValue( $sd["site_code"] );
	// 		$sheet->getCell('W'.$rin)->setValue( $sd["technology"] );
	// 		$sheet->getCell('X'.$rin)->setValue( $sd["priority"] );
	// 		$sheet->getCell('Y'.$rin)->setValue( $sd["office"] );
	// 		$sheet->getCell('Z'.$rin)->setValue( $sd["ro"] );
	// 		$sheet->getCell('AA'.$rin)->setValue( $sd["appear_time"] );

	// 		$sheet->getCell('AA'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) ) );
	// 		$sheet->getStyle('AA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

	// 		$sheet->getCell('AB'.$rin)->setValue( $sd["duration_hm"] );
	// 		$sheet->getCell('AC'.$rin)->setValue( $sd["effect"] );
	// 		$rin++;
	//     }
	//     $sheet->getStyle("V2:AC".($rin-1))->applyFromArray($border_style);

	//     $sheet->getCell('AE2')->setValue('>4Hours Cells Down at '.$selhs);
	// 	$sheet->mergeCells('AE2:AL2');

	// 	$sheet->getCell('AE3')->setValue('Cell ID');
	// 	$sheet->getCell('AF3')->setValue('Technology');
	// 	$sheet->getCell('AG3')->setValue('Priority');
	// 	$sheet->getCell('AH3')->setValue('Office');
	// 	$sheet->getCell('AI3')->setValue('RO');
	// 	$sheet->getCell('AJ3')->setValue('Appear Time');
	// 	$sheet->getCell('AK3')->setValue('Duration (Hrs)');
	// 	$sheet->getCell('AL3')->setValue('Effect');

	// 	$sheet->getStyle('AE2:AL3')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AE2:AL3')->applyFromArray($ha_style);

	//     $rin = 4;
	//     foreach ($g4h_cds as $sd)
	//     {
	//     	$sheet->getCell('AE'.$rin)->setValue( $sd["cell_code"] );
	// 		$sheet->getCell('AF'.$rin)->setValue( $sd["technology"] );
	// 		$sheet->getCell('AG'.$rin)->setValue( $sd["priority"] );
	// 		$sheet->getCell('AH'.$rin)->setValue( $sd["office"] );
	// 		$sheet->getCell('AI'.$rin)->setValue( $sd["ro"] );

	// 		$sheet->getCell('AJ'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) ) );
	// 		$sheet->getStyle('AJ'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

	// 		$sheet->getCell('AK'.$rin)->setValue( $sd["duration_hm"] );
	// 		$sheet->getCell('AL'.$rin)->setValue( $sd["effect"] );
	// 		$rin++;
	//     }
	//     $sheet->getStyle("AE2:AL".($rin-1))->applyFromArray($border_style);

	//     $solar_down_sites = array();

	//     foreach ($sel_hours_stats["power_sites"] as $sid => $outage_tm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];

	// 			if ( $site["power_status"] != null && $site["power_status"] == 'Rented solar power' )
	// 			{
	// 				$sde = array();
	// 				$sde["site_id"] = $sid;
	// 				$sde["site_code"] = $site["site_code_2g"];
	// 				$sde["office"] = null;
	// 				if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 				{
	// 					$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
	// 				}
	// 				$sde["ro"] = $site["ro"];
	// 				$sde["power_alarm"] = $outage_tm["alarm_raised_time"];

	// 				$sde["site_down_2g"] = null;
	// 				if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
	// 				{
	// 					$sde["site_down_2g"] = $sel_hours_stats["site_2go_ids"][$sid];
	// 				}

	// 				$sde["low_voltage"] = null;
	// 				if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
	// 				{
	// 					$sde["low_voltage"] = $sel_hours_stats["lowvoltage_sites"][$sid]["alarm_raised_time"];
	// 				}

	// 				$solar_down_sites [] = $sde;
	// 			}
	// 		}
	// 	}



	//     $sheet->getCell('AN2')->setValue('Solar sites Down at '.$selhs);
	// 	$sheet->mergeCells('AN2:AS2');

	// 	$sheet->getCell('AN3')->setValue('Solar Sites');
	// 	$sheet->getCell('AO3')->setValue('Office');
	// 	$sheet->getCell('AP3')->setValue('RO');
	// 	$sheet->getCell('AQ3')->setValue('PowerAlarm');
	// 	$sheet->getCell('AR3')->setValue('LowVoltage');
	// 	$sheet->getCell('AS3')->setValue('2G SiteDown');

	// 	$sheet->getStyle('AN2:AS3')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AN2:AS3')->applyFromArray($ha_style);

	//     $rin = 4;
	//     foreach ($solar_down_sites as $sls)
	//     {
	//     	$sheet->getCell('AN'.$rin)->setValue( $sls["site_code"] );
	// 		$sheet->getCell('AO'.$rin)->setValue( $sls["office"] );
	// 		$sheet->getCell('AP'.$rin)->setValue( $sls["ro"] );
	// 		$sheet->getCell('AQ'.$rin)->setValue( $sls["power_alarm"] );

	// 		$sheet->getCell('AQ'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["power_alarm"])) ) );
	// 		$sheet->getStyle('AQ'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

	// 		if( $sls["low_voltage"] != null )
	// 		{
	// 			$sheet->getCell('AR'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["low_voltage"])) ) );
	// 			$sheet->getStyle('AR'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");
	// 		}

	// 		if( $sls["site_down_2g"] != null )
	// 		{
	// 			$sheet->getCell('AS'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["site_down_2g"])) ) );
	// 			$sheet->getStyle('AS'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");
	// 		}
	// 		$rin++;
	//     }
	//     $sheet->getStyle("AN2:AS".($rin-1))->applyFromArray($border_style);

	//     $g8cs = array();
	//     $g8s2gs = array();
	//     $g8s3gs = array();
	//     $g8s4gs = array();
	//     for ($i=2; $i <= 4; $i++)
	// 	{
	// 		$tvrname = "sw_".$i."g_out";
	// 		foreach (${$tvrname} as $sid => $site_outs)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];
	// 				if( $site_outs["site"] != null )
	// 				{
	// 					$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);
	// 					if( $dif > (8*60*60) )
	// 					{
	// 						$sde = array();
	// 						$sde["site_id"] = $sid;
	// 						$sde["site_code"] = $site["site_code_".$i."g"];
	// 						$sde["technology"] = $i."G";
	// 						$sde["priority"] = $site["site_priority"];
	// 						$sde["appear_time"] = $site_outs["site"]["start_time"];
	// 						$sde["duration_sec"] = $dif;
	// 						$sde["duration_hm"] = round($dif/(60*60), 2);
	// 						$sde["office"] = null;
	// 						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 						{
	// 							$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
	// 						}
	// 						$sde["ro"] = $site["ro"];

	// 						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 						    $sde["effect"] = "Site Down";
	// 						else
	// 							$sde["effect"] = "Micro BTS Down";

	// 						${"g8s".$i."gs"} [] = $sde;
	// 					}
	// 				}
	// 				else if ( sizeof($site_outs["cells"]) > 0 )
	// 				{
	// 					foreach ($site_outs["cells"] as $cell_name => $cell_out)
	// 					{
	// 						$dif = @strtotime($sel_ts) - @strtotime($cell_out["start_time"]);
	// 						if( $dif > (8*60*60) )
	// 						{
	// 							$sde = array();
	// 							$sde["site_id"] = $sid;
	// 							$sde["site_code"] = $site["site_code_".$i."g"];
	// 							$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
	// 							$sde["technology"] = $i."G";
	// 							$sde["priority"] = $site["site_priority"];
	// 							$sde["appear_time"] = $cell_out["start_time"];
	// 							$sde["duration_sec"] = $dif;
	// 							$sde["duration_hm"] = round($dif/(60*60), 2);
	// 							$sde["office"] = null;
	// 							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 							{
	// 								$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
	// 							}
	// 							$sde["ro"] = $site["ro"];
	// 							$sde["effect"] = "1 Cell (".$cell_name.") Down";

	// 							$g8cs [] = $sde;
	// 						}
	// 					}
	// 				}
	// 			}
	// 		}
	// 	}

	// 	usort($g8s2gs, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	// 	usort($g8s3gs, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	// 	usort($g8s4gs, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	// 	usort($g8cs, function($a, $b)
	// 	{
	// 		if($a['duration_sec']==$b['duration_sec']) return 0;
	// 		return $a['duration_sec'] < $b['duration_sec']?1:-1;
	// 	});

	//     $sheet->getCell('AW2')->setValue('Update for More than 08 hrs Down Site');
	// 	$sheet->mergeCells('AW2:BE2');
	// 	$sheet->getStyle("AW2:BE2")->applyFromArray($border_style);

	// 	$rin = 3;
	// 	$last_rin = 3;
	//     $sheet->getCell('AW'.$rin)->setValue('2G');
	//     $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	//     $rin++;
	//     $last_rin = $rin;
	// 	$sheet->getCell('AW'.$rin)->setValue('Sitecode');
	// 	$sheet->getCell('AX'.$rin)->setValue('Priority');
	// 	$sheet->getCell('AY'.$rin)->setValue('Office');
	// 	$sheet->getCell('AZ'.$rin)->setValue('RO');
	// 	$sheet->getCell('BA'.$rin)->setValue('Appear Date');
	// 	$sheet->getCell('BB'.$rin)->setValue('Appear Time');
	// 	$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
	// 	$sheet->getCell('BD'.$rin)->setValue('Effect');
	// 	$sheet->getCell('BE'.$rin)->setValue('Reason');

	// 	$sheet->getStyle('AW'.($rin-2).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AW'.($rin-3).':BE'.$rin)->applyFromArray($ha_style);

	//     $rin++;
	//     if( sizeof($g8s2gs) > 0 )
	//     {
	// 	    foreach ($g8s2gs as $sd)
	// 	    {
	// 	    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
	// 			$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
	// 			$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
	// 			$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
	// 			$sheet->getCell('BA'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
	// 			$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
	// 			$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
	// 			$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
	// 			$sheet->getCell('BE'.$rin)->setValue( '' );
	// 			$rin++;
	// 	    }
	//     }
	//     else
	//     {
	//     	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	//     	$rin++;
	//     }
	//     $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	//     $rin++;
	//     $sheet->getCell('AW'.$rin)->setValue('3G');
	//     $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	//     $rin++;
	//     $last_rin = $rin;
	// 	$sheet->getCell('AW'.$rin)->setValue('Sitecode');
	// 	$sheet->getCell('AX'.$rin)->setValue('Priority');
	// 	$sheet->getCell('AY'.$rin)->setValue('Office');
	// 	$sheet->getCell('AZ'.$rin)->setValue('RO');
	// 	$sheet->getCell('BA'.$rin)->setValue('Appear Date');
	// 	$sheet->getCell('BB'.$rin)->setValue('Appear Time');
	// 	$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
	// 	$sheet->getCell('BD'.$rin)->setValue('Effect');
	// 	$sheet->getCell('BE'.$rin)->setValue('Reason');

	// 	$sheet->getStyle('AW'.($rin-1).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AW'.($rin-1).':BE'.$rin)->applyFromArray($ha_style);

	//     $rin++;
	//     if( sizeof($g8s3gs) > 0 )
	//     {
	// 		foreach ($g8s3gs as $sd)
	// 	    {
	// 	    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
	// 			$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
	// 			$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
	// 			$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
	// 			$sheet->getCell('BA'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
	// 			$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
	// 			$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
	// 			$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
	// 			$sheet->getCell('BE'.$rin)->setValue( '' );
	// 			$rin++;
	// 	    }
	//     }
	//     else
	//     {
	//     	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	//     	$rin++;
	//     }
	//     $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	//     $rin++;
	//     $sheet->getCell('AW'.$rin)->setValue('4G');
	//     $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	//     $rin++;
	//     $last_rin = $rin;
	// 	$sheet->getCell('AW'.$rin)->setValue('Sitecode');
	// 	$sheet->getCell('AX'.$rin)->setValue('Priority');
	// 	$sheet->getCell('AY'.$rin)->setValue('Office');
	// 	$sheet->getCell('AZ'.$rin)->setValue('RO');
	// 	$sheet->getCell('BA'.$rin)->setValue('Appear Date');
	// 	$sheet->getCell('BB'.$rin)->setValue('Appear Time');
	// 	$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
	// 	$sheet->getCell('BD'.$rin)->setValue('Effect');
	// 	$sheet->getCell('BE'.$rin)->setValue('Reason');

	// 	$sheet->getStyle('AW'.($rin-1).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AW'.($rin-1).':BE'.$rin)->applyFromArray($ha_style);

	//     $rin++;
	//     if( sizeof($g8s4gs) > 0 )
	//     {
	// 		foreach ($g8s4gs as $sd)
	// 	    {
	// 	    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
	// 			$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
	// 			$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
	// 			$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
	// 			$sheet->getCell('BA'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
	// 			$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
	// 			$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
	// 			$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
	// 			$sheet->getCell('BE'.$rin)->setValue( '' );
	// 			$rin++;
	// 	    }
	// 	}
	//     else
	//     {
	//     	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	//     	$rin++;
	//     }
	//     $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	//     $rin++;
	//     $last_rin = $rin;
	//     $sheet->getCell('AW'.$rin)->setValue('Update for More than 08 hrs Cell Down');
	//     $sheet->mergeCells('AW'.$rin.':BF'.$rin);
	//     $rin++;
	// 	$sheet->getCell('AW'.$rin)->setValue('Sitecode');
	// 	$sheet->getCell('AX'.$rin)->setValue('Technology');
	// 	$sheet->getCell('AY'.$rin)->setValue('Priority');
	// 	$sheet->getCell('AZ'.$rin)->setValue('Office');
	// 	$sheet->getCell('BA'.$rin)->setValue('RO');
	// 	$sheet->getCell('BB'.$rin)->setValue('Appear Date');
	// 	$sheet->getCell('BC'.$rin)->setValue('Appear Time');
	// 	$sheet->getCell('BD'.$rin)->setValue('Duration (Hrs)');
	// 	$sheet->getCell('BE'.$rin)->setValue('Effect');
	// 	$sheet->getCell('BF'.$rin)->setValue('Reason');

	// 	$sheet->getStyle('AW'.($rin-1).':BF'.$rin)->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('AW'.($rin-1).':BF'.$rin)->applyFromArray($ha_style);

	//     $rin++;
	//     if( sizeof($g8cs) > 0 )
	//     {
	// 		foreach ($g8cs as $sd)
	// 	    {
	// 	    	$sheet->getCell('AW'.$rin)->setValue( $sd["cell_code"] );
	// 			$sheet->getCell('AX'.$rin)->setValue( $sd["technology"] );
	// 			$sheet->getCell('AY'.$rin)->setValue( $sd["priority"] );
	// 			$sheet->getCell('AZ'.$rin)->setValue( $sd["office"] );
	// 			$sheet->getCell('BA'.$rin)->setValue( $sd["ro"] );
	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
	// 			$sheet->getCell('BB'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
	// 			$sheet->getCell('BC'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('BC'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
	// 			$sheet->getCell('BD'.$rin)->setValue( $sd["duration_hm"] );
	// 			$sheet->getCell('BE'.$rin)->setValue( $sd["effect"] );
	// 			$sheet->getCell('BF'.$rin)->setValue( '' );
	// 			$rin++;
	// 	    }
	//     }
	//     else
	//     {
	//     	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	//     	$rin++;
	//     }
	//     $sheet->getStyle("AW".$last_rin.":BF".($rin-1))->applyFromArray($border_style);



	//     // already in ascending sorted order so no need
	//     $ocells_down = array();
	//     for ($i=2; $i <= 4; $i++)
	// 	{
	// 		$tvrname = "sw_".$i."g_out";

	// 		$sheet = $phpExcel->createSheet($shind);
	// 		$sheet->setTitle($i."G_Down");
	// 		$shind++;

	// 		$sheet->getCell('A1')->setValue('SL');
	// 		$sheet->getCell('B1')->setValue('UniqueSitecode');
	// 		$sheet->getCell('C1')->setValue('Sitecode');
	// 		$sheet->getCell('D1')->setValue('Priority');
	// 		$sheet->getCell('E1')->setValue('Office');
	// 		$sheet->getCell('F1')->setValue('MSD Office');
	// 		$sheet->getCell('G1')->setValue('District');
	// 		$sheet->getCell('H1')->setValue('Thana');
	// 		$sheet->getCell('I1')->setValue('Area');
	// 		$sheet->getCell('J1')->setValue('RO');
	// 		$sheet->getCell('K1')->setValue('Appear Date');
	// 		$sheet->getCell('L1')->setValue('Appear Time');
	// 		$sheet->getCell('M1')->setValue('Duration (Hrs)');
	// 		$sheet->getCell('N1')->setValue('Address');
	// 		$sheet->getCell('O1')->setValue('Effect');
	// 		$sheet->getCell('P1')->setValue('Alarm');
	// 		$sheet->getCell('Q1')->setValue('BTS Type');
	// 		$sheet->getCell('R1')->setValue('Share Operator');
	// 		$sheet->getCell('S1')->setValue('Sharing Type');
	// 		$sheet->getCell('T1')->setValue('NTTN info/Minihuub');
	// 		$sheet->getCell('U1')->setValue('Power Status');
	// 		$sheet->getCell('V1')->setValue('PowerAlarmStatus');

	// 		if( $i==2 )
	// 			$sheet->getCell('W1')->setValue('Common with 3G');
	// 		else if( $i==3 )
	// 			$sheet->getCell('W1')->setValue('Common with 2G');
	// 		if( $i==4 )
	// 			$sheet->getCell('W1')->setValue('Common with 3G');

	// 		$sheet->getStyle('A1:W1')->getFont()->setBold(true)->setSize(12);
	// 	    $sheet->getStyle('A1:W1')->applyFromArray($ha_style);

	// 	    $rin = 2;
	// 		foreach (${$tvrname} as $sid => $site_outs)
	// 		{
	// 			if( isset($site_mem_resp->site_list[$sid]) )
	// 			{
	// 				$site = $site_mem_resp->site_list[$sid];
	// 				if( $site_outs["site"] != null )
	// 				{
	// 					$sheet->getCell('A'.$rin)->setValue($rin-1);
	// 					$sheet->getCell('B'.$rin)->setValue($site["generic_id"]);
	// 					$sheet->getCell('C'.$rin)->setValue($site["site_code_".$i."g"]);
	// 					$sheet->getCell('D'.$rin)->setValue($site["site_priority"]);

	// 					if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 						$sheet->getCell('E'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
	// 					else
	// 						$sheet->getCell('E'.$rin)->setValue('');

	// 					if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
	// 						$sheet->getCell('F'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
	// 					else
	// 						$sheet->getCell('F'.$rin)->setValue('');

	// 					$sheet->getCell('G'.$rin)->setValue($site["district"]);
	// 					$sheet->getCell('H'.$rin)->setValue($site["thana"]);
	// 					$sheet->getCell('I'.$rin)->setValue($site["zone"]);
	// 					$sheet->getCell('J'.$rin)->setValue($site["ro"]);

	// 					$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($site_outs["site"]["start_time"])) );
	// 					$sheet->getCell('K'.$rin)->setValue( $extime );
	// 					$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

	// 					$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
	// 					$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

	// 					$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);

	// 					$sheet->getCell('M'.$rin)->setValue( round($dif/(60*60), 2) );
	// 					$sheet->getCell('N'.$rin)->setValue($site["address"]);

	// 					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
	// 					    $sheet->getCell('O'.$rin)->setValue("Site Down");
	// 					else
	// 						$sheet->getCell('O'.$rin)->setValue("Micro BTS Down");

	// 					$sheet->getCell('P'.$rin)->setValue($site_outs["site"]["slogan"]);
	// 					$sheet->getCell('Q'.$rin)->setValue($site["bts_type"]);
	// 					$sheet->getCell('R'.$rin)->setValue($site["shared_operator"]);
	// 					$sheet->getCell('S'.$rin)->setValue($site["sharing_type"]);
	// 					$sheet->getCell('T'.$rin)->setValue( implode(" / ", array($site["service_type"], $site["mini_hub"]) ));
	// 					$sheet->getCell('U'.$rin)->setValue($site["power_status"]);

	// 					$power_slogans = array();
	// 					if( isset($sel_hours_stats["power_sites"][$sid]) )
	// 					{
	// 						$power_slogans [] = $sel_hours_stats["power_sites"][$sid]["slogan"];
	// 					}

	// 					if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
	// 					{
	// 						$power_slogans [] = $sel_hours_stats["lowvoltage_sites"][$sid]["slogan"];
	// 					}

	// 					$sheet->getCell('V'.$rin)->setValue( implode(" / ", $power_slogans) );

	// 					if( $i==2 )
	// 					{
	// 						if( isset($sel_hours_stats["site_3go_ids"][$sid]) )
	// 						{
	// 							$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
	// 						}
	// 					}
	// 					else if( $i==3 )
	// 					{
	// 						if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
	// 						{
	// 							$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
	// 						}
	// 					}
	// 					if( $i==4 )
	// 					{
	// 						if( isset($sel_hours_stats["site_3go_ids"][$sid]) )
	// 						{
	// 							$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
	// 						}
	// 					}
	// 					$rin++;
	// 				}
	// 				else if ( sizeof($site_outs["cells"]) > 0 )
	// 				{
	// 					foreach ($site_outs["cells"] as $cell_name => $cell_out)
	// 					{
	// 						$ocells_down [] = $cell_out;
	// 					}
	// 				}
	// 			}
	// 		}
	// 	}


	// 	$sheet = $phpExcel->createSheet($shind);
	// 	$sheet->setTitle("CellsDown");
	// 	$shind++;

	// 	$sheet->getCell('A1')->setValue('SL');
	// 	$sheet->getCell('B1')->setValue('Cell ID');
	// 	$sheet->getCell('C1')->setValue('Technology');
	// 	$sheet->getCell('D1')->setValue('Priority');
	// 	$sheet->getCell('E1')->setValue('Office');
	// 	$sheet->getCell('F1')->setValue('District');
	// 	$sheet->getCell('G1')->setValue('Thana');
	// 	$sheet->getCell('H1')->setValue('MSD Office');
	// 	$sheet->getCell('I1')->setValue('Zone');
	// 	$sheet->getCell('J1')->setValue('RO');
	// 	$sheet->getCell('K1')->setValue('Appear Date');
	// 	$sheet->getCell('L1')->setValue('Appear Time');
	// 	$sheet->getCell('M1')->setValue('Duration (Hrs)');
	// 	$sheet->getCell('N1')->setValue('Alarm');
	// 	$sheet->getCell('O1')->setValue('Effect');

	// 	$sheet->getStyle('A1:O1')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('A1:O1')->applyFromArray($ha_style);

	// 	$rin = 2;
	// 	foreach ($ocells_down as $cell_down)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$cell_down["site_id"]]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$cell_down["site_id"]];

	// 			$site_code = null;
	// 			if( $cell_down["technology"] == "2G" ) $site_code = $site["site_code_2g"];
	// 			else if( $cell_down["technology"] == "3G" ) $site_code = $site["site_code_3g"];
	// 			else if( $cell_down["technology"] == "4G" ) $site_code = $site["site_code_4g"];

	// 			if( $site_code != null ) $site_code = $cell_down["site_code"];

	// 			$sheet->getCell('A'.$rin)->setValue($rin-1);
	// 			$sheet->getCell('B'.$rin)->setValue($site_code.'_'.$this->atonumlookup($cell_down["cell_name"]));
	// 			$sheet->getCell('C'.$rin)->setValue($cell_down["technology"]);
	// 			$sheet->getCell('D'.$rin)->setValue($site["site_priority"]);

	// 			if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 				$sheet->getCell('E'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
	// 			else
	// 				$sheet->getCell('E'.$rin)->setValue('');

	// 			$sheet->getCell('F'.$rin)->setValue($site["district"]);
	// 			$sheet->getCell('G'.$rin)->setValue($site["thana"]);

	// 			if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
	// 				$sheet->getCell('H'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
	// 			else
	// 				$sheet->getCell('H'.$rin)->setValue('');

	// 			$sheet->getCell('I'.$rin)->setValue($site["zone"]);
	// 			$sheet->getCell('J'.$rin)->setValue($site["ro"]);

	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($cell_down["start_time"])) );
	// 			$sheet->getCell('K'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

	// 			$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

	// 			$dif = @strtotime($sel_ts) - @strtotime($cell_down["start_time"]);

	// 			$sheet->getCell('M'.$rin)->setValue( round($dif/(60*60), 2) );
	// 			$sheet->getCell('N'.$rin)->setValue($cell_down["slogan"]);
	// 			$sheet->getCell('O'.$rin)->setValue("1 Cell (".$cell_down["cell_name"].") Down");

	// 			$rin++;
	// 		}
	// 	}


	// 	$sheet = $phpExcel->createSheet($shind);
	// 	$sheet->setTitle("PowerAlarm");
	// 	$shind++;

	// 	$sheet->getCell('A1')->setValue('BSC');
	// 	$sheet->getCell('B1')->setValue('Sitecode');
	// 	$sheet->getCell('C1')->setValue('Unique Sites');
	// 	$sheet->getCell('D1')->setValue('Technology');
	// 	$sheet->getCell('E1')->setValue('Priority');
	// 	$sheet->getCell('F1')->setValue('Office');
	// 	$sheet->getCell('G1')->setValue('MSD Office');
	// 	$sheet->getCell('H1')->setValue('District');
	// 	$sheet->getCell('I1')->setValue('Thana');
	// 	$sheet->getCell('J1')->setValue('Zone');
	// 	$sheet->getCell('K1')->setValue('RO');
	// 	$sheet->getCell('L1')->setValue('Commercial Zone');
	// 	$sheet->getCell('M1')->setValue('Address');
	// 	$sheet->getCell('N1')->setValue('Appear Date');
	// 	$sheet->getCell('O1')->setValue('Appear Time');
	// 	$sheet->getCell('P1')->setValue('Duration (Hrs)');
	// 	$sheet->getCell('Q1')->setValue('Severity');
	// 	$sheet->getCell('R1')->setValue('Alarm');
	// 	$sheet->getCell('S1')->setValue('Specific');
	// 	$sheet->getCell('T1')->setValue('Additional');
	// 	$sheet->getCell('U1')->setValue('Power Status');
	// 	$sheet->getCell('V1')->setValue('HUB(connected sites)');
	// 	$sheet->getCell('W1')->setValue('SiteDown Time');

	// 	$sheet->getStyle('A1:W1')->getFont()->setBold(true)->setSize(12);
	//     $sheet->getStyle('A1:W1')->applyFromArray($ha_style);

	//     $rin = 2;
	//     foreach ($sel_hours_stats["power_sites"] as $sid => $palarm)
	// 	{
	// 		if( isset($site_mem_resp->site_list[$sid]) )
	// 		{
	// 			$site = $site_mem_resp->site_list[$sid];
	// 			$bsc_rnc = "N/A";
	// 			$technology = "N/A";
	// 			if( $palarm["sname"] == $site["site_code_2g"] )
	// 			{
	// 				$bsc_rnc = $site["bsc_2g"];
	// 				$technology = "2G";
	// 			}
	// 			else if( $palarm["sname"] == $site["site_code_3g"] )
	// 			{
	// 				$bsc_rnc = $site["rnc_3g"];
	// 				$technology = "3G";
	// 			}
	// 			else if( $palarm["sname"] == $site["site_code_4g"] )
	// 			{
	// 				$technology = "4G";
	// 			}

	// 			$bscs [] = $bsc_rnc;

	// 			// $sheet->getCell('A'.$rin)->setValue($bsc_rnc);
	// 			// BSC/RNC contains formulas.
	// 			$sheet->setCellValueExplicit('A'.$rin, $bsc_rnc);

	// 			$sheet->getCell('B'.$rin)->setValue($palarm["sname"]);
	// 			$sheet->getCell('C'.$rin)->setValue($site["generic_id"]);
	// 			$sheet->getCell('D'.$rin)->setValue($technology);
	// 			$sheet->getCell('E'.$rin)->setValue($site["site_priority"]);

	// 			if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
	// 				$sheet->getCell('F'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
	// 			else
	// 				$sheet->getCell('F'.$rin)->setValue('');

	// 			if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
	// 				$sheet->getCell('G'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
	// 			else
	// 				$sheet->getCell('G'.$rin)->setValue('');

	// 			$sheet->getCell('H'.$rin)->setValue($site["district"]);
	// 			$sheet->getCell('I'.$rin)->setValue($site["thana"]);
	// 			$sheet->getCell('J'.$rin)->setValue($site["zone"]);
	// 			$sheet->getCell('K'.$rin)->setValue($site["ro"]);
	// 			$sheet->getCell('L'.$rin)->setValue($site["commercial_zone"]);
	// 			$sheet->getCell('M'.$rin)->setValue($site["address"]);


	// 			$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($palarm["alarm_raised_time"])) );
	// 			$sheet->getCell('N'.$rin)->setValue( $extime );
	// 			$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

	// 			$sheet->getCell('O'.$rin)->setValue( $extime - floor($extime) );
	// 			$sheet->getStyle('O'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

	// 			$dif = @strtotime($sel_ts) - @strtotime($palarm["alarm_raised_time"]);

	// 			$sheet->getCell('P'.$rin)->setValue( round($dif/(60*60), 2) );
	// 			$sheet->getCell('Q'.$rin)->setValue( $palarm["perceived_severity"] );
	// 			$sheet->getCell('R'.$rin)->setValue( $palarm["slogan"] );
	// 			$sheet->getCell('S'.$rin)->setValue('');
	// 			$sheet->getCell('T'.$rin)->setValue('');
	// 			$sheet->getCell('U'.$rin)->setValue($site["power_status"]);
	// 			$sheet->getCell('V'.$rin)->setValue($site["no_of_sites"]);

	// 			if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
	// 			{
	// 				$sheet->getCell('W'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($palarm["alarm_raised_time"])) ) );
	// 				$sheet->getStyle('W'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm:ss");
	// 			}
	// 			$rin++;
	// 		}
	// 	}

	// 	$phpExcel->setActiveSheetIndex(0);

    //    	$filename = "hourly_sms_" . date("Y-m-d @ H:i", @strtotime($sel_ts)) . ".xlsx";

	//     header('Content-Type: application/vnd.ms-excel');
	//     header('Content-Disposition: attachment;filename="'.$filename.'"');
	//     header('Cache-Control: max-age=0');
	//     $writer->setPreCalculateFormulas();
	//     $writer->save('php://output');
	// }

	public function actionExtractHourlyReport($date, $hour=null)
	{
		$sel_ts = null;
		if( $date == null || @trim($date) == "" )
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}
		
		if( $hour != null && @trim($hour) != "" )
		{
			$hour = intval($hour);
			if( $hour < 0 || $hour > 23 )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Hour Provided. Please Provide a Valid Hour."
				));
				Yii::app()->end();
			}
			$hour = str_pad($hour, 2, '0', STR_PAD_LEFT);
		}
		else
		{
			$hour = date("H");
		}

		if( $this->validateDate($date, 'd/m/Y') )
		{
			$pd = DateTime::createFromFormat('d/m/Y', $date);
			$sel_ts = $pd->format('Y-m-d')." ".$hour.":00:00";

			if( @strtotime($sel_ts) > @strtotime(date("Y-m-d H:00:00")) )
			{
				$this->render('error_message',array(
					'error_message'=>"Invalid Hour Provided. Please Provide a Hour for Earlier then Now."
				));
				Yii::app()->end();
			}
		}
		else
		{
			$this->render('error_message',array(
				'error_message'=>"Invalid Date Provided. Please Provide a Valid date."
			));
			Yii::app()->end();
		}

		session_write_close();

		require_once (Yii::app()->basePath.'/extensions/PHPExcel-1.8/Classes/PHPExcel.php');

		ini_set('max_execution_time', 300); // 5 minutes
		ini_set("memory_limit", "-1");

		$site_mem_resp = MemHelper::get_site_list();
		if(!$site_mem_resp->success)
			throw new CHttpException(500, "Error Getting Mem Site List: ".$site_mem_resp->message);

		$inhouse_lookup = array();
		$msd_lookup = array();
		$om_ofc_resp = OMofficeHelper::all_ofc_lookup();
		if( $om_ofc_resp->success )
		{
			foreach ($om_ofc_resp->data as $key => $om_ofc)
			{
				if( $om_ofc->office_type_id == 1)
				{
					$inhouse_lookup [$om_ofc->id] = $om_ofc;
				}
				else if( $om_ofc->office_type_id == 2)
				{
					$msd_lookup [$om_ofc->id] = $om_ofc;
				}
			}
		}
		else
		{
			throw new CHttpException(500,'Error while communicating with atlas: '.$om_ofc_resp->message);
		}

		// have to check that selected users hour should not be greater then current hour as sanity check
		$now = time();
		$std = date("Y-m-d H:00:00", @strtotime("-4 hours ", @strtotime($sel_ts) ) );
		$edt = $sel_ts;

		$huawei_id = Yii::app()->params["vendor_lookup"]["huawei"];
		$zte_id = Yii::app()->params["vendor_lookup"]["zte"];
		$nokia_id = Yii::app()->params["vendor_lookup"]["nokia"];

		// last parameter is to skip the check for suppressing type2 outages as we are only using instantaneous analysis here
		$outages = NetworkAvailabilityHelper::getDurationOutages( $std, $edt, $site_mem_resp, false, true );

		$emslkp = Yii::app()->params["tech_lookup_txt"];
		$ran_emss = array();
		foreach ($emslkp as $tech_id => $domain)
		{
			if( $domain == "RAN" )
				$ran_emss [] = $tech_id;
		}
		$tech_ems_cond = " FALSE ";
		if( sizeof($ran_emss) > 0 )
			$tech_ems_cond = " t.technology_id IN (".implode(",", $ran_emss).") ";

		$actpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.entity_name as sname, t.perceived_severity, t.specific_problem as slogan, t.alarm_raised_time, NULL AS alarm_cleared_time_ums, TRUE AS active
		FROM alarm t Where t.entity_type IS NOT NULL
		AND t.entity_type = 1
		AND $tech_ems_cond
		AND t.entity_id IS NOT NULL
		AND t.entity_id != -1
		AND t.vendor_id IS NOT NULL
		AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
		AND t.alarm_raised_time IS NOT NULL
		AND t.alarm_raised_time <= '$edt'::timestamp without time zone
		AND (
			lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON' OR t.specific_problem = 'LOW VOLTAGE'
		) ORDER BY t.alarm_raised_time ASC ;
		")->queryAll();

		$logpowers = Yii::app()->db->createCommand("SELECT t.id, t.entity_id as psid, t.entity_name as sname, t.perceived_severity, t.specific_problem as slogan, t.alarm_raised_time, t.alarm_cleared_time_ums, FALSE AS active
		FROM log t Where t.entity_type IS NOT NULL
		AND t.entity_type = 1
		AND $tech_ems_cond
		AND t.entity_id IS NOT NULL
		AND t.entity_id != -1
		AND t.vendor_id IS NOT NULL
		AND t.vendor_id IN ($huawei_id,$zte_id,$nokia_id)
		AND t.alarm_raised_time IS NOT NULL
		AND t.alarm_raised_time <= '$edt'::timestamp without time zone 
		AND t.alarm_cleared_time_ums IS NOT NULL
		AND t.alarm_cleared_time_ums >= '$std'::timestamp without time zone 
		AND (
			lower(t.specific_problem) LIKE '%mains fail%' OR lower(t.specific_problem) LIKE '%mains input%' OR t.specific_problem = 'GENSET ON' OR t.specific_problem = 'LOW VOLTAGE'
		) ORDER BY t.alarm_raised_time ASC  ;
		")->queryAll();



		$phpExcel = new PHPExcel;
		// Setting font to Arial Black
		$phpExcel->getDefaultStyle()->getFont()->setName('Calibri');
		// Setting font size to 14
		$phpExcel->getDefaultStyle()->getFont()->setSize(11);
		//Setting description, creator and title
		$phpExcel->getProperties()->setTitle("Hourly SMS Report");
		$phpExcel->getProperties()->setCreator("UMS");
		$phpExcel->getProperties()->setDescription("Hourly SMS Report");
		// Creating PHPExcel spreadsheet writer object
		// We will create xlsx file (Excel 2007 and above)
		$writer = PHPExcel_IOFactory::createWriter($phpExcel, "Excel2007");
		// When creating the writer object, the first sheet is also created

		$ha_style = array(
	        'alignment' => array(
	            'horizontal' => PHPExcel_Style_Alignment::HORIZONTAL_CENTER,
	        )
	    );

		$sheet = $phpExcel->getActiveSheet();
		$sheet->setTitle('Storm_Trend');

		$sheet->getCell('A1')->setValue('Active power alarm');
		$sheet->mergeCells('A1:J1');
		$sheet->getCell('M1')->setValue('Active Site Down');
		$sheet->mergeCells('M1:S1');
		$sheet->getCell('V1')->setValue('Division-Wise Power Alarm and Site Down Trend for last 3 hrs');
		$sheet->mergeCells('V1:AB1');

		$sheet->getCell('A2')->setValue('RO');
		$sheet->getCell('B2')->setValue('O&M Office');
		$sheet->getCell('C2')->setValue('0<Hr<4');
		$sheet->getCell('D2')->setValue('4<Hr<8');
		$sheet->getCell('E2')->setValue('8<Hr<12');
		$sheet->getCell('F2')->setValue('12<Hr<16');
		$sheet->getCell('G2')->setValue('16<Hr<20');
		$sheet->getCell('H2')->setValue('20<Hr<24');
		$sheet->getCell('I2')->setValue('Hr>24');
		$sheet->getCell('J2')->setValue('Total');

		$sheet->getCell('M2')->setValue('RO');
		$sheet->getCell('N2')->setValue('O&M Office');
		$sheet->getCell('O2')->setValue('0<Hr<6');
		$sheet->getCell('P2')->setValue('6<Hr<12');
		$sheet->getCell('Q2')->setValue('12<Hr<24');
		$sheet->getCell('R2')->setValue('Hr>24');
		$sheet->getCell('S2')->setValue('Total');

		$sheet->getCell('V2')->setValue('DIVISION');
		$sheet->getCell('W2')->setValue("Power Alarm at ".date("H:00", @strtotime("-3 hours", @strtotime($sel_ts)))."Hrs");
		$sheet->getCell('X2')->setValue("Power Alarm at ".date("H:00", @strtotime("-2 hours", @strtotime($sel_ts)))."Hrs");
		$sheet->getCell('Y2')->setValue("Power Alarm at ".date("H:00", @strtotime("-1 hours", @strtotime($sel_ts)))."Hrs");
		$sheet->getCell('Z2')->setValue("Site Down at ".date("H:00", @strtotime("-3 hours", @strtotime($sel_ts)))."Hrs");
		$sheet->getCell('AA2')->setValue("Site Down at ".date("H:00", @strtotime("-2 hours", @strtotime($sel_ts)))."Hrs");
		$sheet->getCell('AB2')->setValue("Site Down at ".date("H:00", @strtotime("-1 hours", @strtotime($sel_ts)))."Hrs");

		$sheet->getStyle('A1:AB2')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle("A1:AB2")->applyFromArray($ha_style);

		$ofc_counts = array();
		$district_counts = array();

		foreach ($om_ofc_resp->data as $key => $om_ofc)
		{
			if( $om_ofc->office_type_id == 1 && $om_ofc->ro != null )
			{
				$ofc_counts [$om_ofc->id] = array(
					"name"=>$om_ofc->name,
					"ro"=>$om_ofc->ro,
					"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
					"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
					"outage_3g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
					"outage_4g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
				);
			}
		}

		foreach ($site_mem_resp->site_list as $site)
		{
			if( $site["district"] != null && $site["ro"] != null && !isset($district_counts[$site["district"]]) )
			{
				$district_counts [$site["district"]] = array(
					"ro"=>$site["ro"],
					"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
					"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
				);
			}
		}

		$sel_hours_stats = $this->get_affected_at_hour( $actpowers, $logpowers, $outages, $sel_ts );

		foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($alrm_tm["alarm_raised_time"]);

					if( $dif >= 0 && $dif < (4*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h0_4"]++;
					else if( $dif >= (4*60*60) && $dif < (8*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h4_8"]++;
					else if( $dif >= (8*60*60) && $dif < (12*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h8_12"]++;
					else if( $dif >= (12*60*60) && $dif < (16*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h12_16"]++;
					else if( $dif >= (16*60*60) && $dif < (20*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h16_20"]++;
					else if( $dif >= (20*60*60) && $dif < (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["h20_24"]++;
					else if ( $dif >= (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["power"]["hg24"]++;
				}

				if( $site["district"] != null && isset($district_counts[$site["district"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($alrm_tm["alarm_raised_time"]);

					if( $dif >= 0 && $dif < (4*60*60) )
						$district_counts[$site["district"]]["power"]["h0_4"]++;
					else if( $dif >= (4*60*60) && $dif < (8*60*60) )
						$district_counts[$site["district"]]["power"]["h4_8"]++;
					else if( $dif >= (8*60*60) && $dif < (12*60*60) )
						$district_counts[$site["district"]]["power"]["h8_12"]++;
					else if( $dif >= (12*60*60) && $dif < (16*60*60) )
						$district_counts[$site["district"]]["power"]["h12_16"]++;
					else if( $dif >= (16*60*60) && $dif < (20*60*60) )
						$district_counts[$site["district"]]["power"]["h16_20"]++;
					else if( $dif >= (20*60*60) && $dif < (24*60*60) )
						$district_counts[$site["district"]]["power"]["h20_24"]++;
					else if ( $dif >= (24*60*60) )
						$district_counts[$site["district"]]["power"]["hg24"]++;
				}
			}
		}

		foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

					if( $dif >= 0 && $dif < (6*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_2g"]["h0_6"]++;
					else if( $dif >= (6*60*60) && $dif < (12*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_2g"]["h6_12"]++;
					else if( $dif >= (12*60*60) && $dif < (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_2g"]["h12_24"]++;
					else if ( $dif >= (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_2g"]["hg24"]++;
				}

				if( $site["district"] != null && isset($district_counts[$site["district"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

					if( $dif >= 0 && $dif < (6*60*60) )
						$district_counts[$site["district"]]["outage_2g"]["h0_6"]++;
					else if( $dif >= (6*60*60) && $dif < (12*60*60) )
						$district_counts[$site["district"]]["outage_2g"]["h6_12"]++;
					else if( $dif >= (12*60*60) && $dif < (24*60*60) )
						$district_counts[$site["district"]]["outage_2g"]["h12_24"]++;
					else if ( $dif >= (24*60*60) )
						$district_counts[$site["district"]]["outage_2g"]["hg24"]++;
				}
			}
		}

		foreach ($sel_hours_stats["site_3go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

					if( $dif >= 0 && $dif < (6*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_3g"]["h0_6"]++;
					else if( $dif >= (6*60*60) && $dif < (12*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_3g"]["h6_12"]++;
					else if( $dif >= (12*60*60) && $dif < (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_3g"]["h12_24"]++;
					else if ( $dif >= (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_3g"]["hg24"]++;
				}
			}
		}

		foreach ($sel_hours_stats["site_4go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["om_office_id"] != null && isset($ofc_counts[$site["om_office_id"]]) )
				{
					$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

					if( $dif >= 0 && $dif < (6*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_4g"]["h0_6"]++;
					else if( $dif >= (6*60*60) && $dif < (12*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_4g"]["h6_12"]++;
					else if( $dif >= (12*60*60) && $dif < (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_4g"]["h12_24"]++;
					else if ( $dif >= (24*60*60) )
						$ofc_counts[$site["om_office_id"]]["outage_4g"]["hg24"]++;
				}
			}
		}

		$ro_ofc_counts = array();
		foreach ($ofc_counts as $ofc_id => $ofc_data)
		{
			if( !isset( $ro_ofc_counts[$ofc_data["ro"]] ) )
				$ro_ofc_counts[$ofc_data["ro"]] = array();

			$ro_ofc_counts[$ofc_data["ro"]] [] = $ofc_data;
		}

		ksort($ro_ofc_counts);
		$rin = 3;

		$totals = array(
			"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
			"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
		);
		foreach ($ro_ofc_counts as $ro_name => $ro_ofcs)
		{
			foreach ($ro_ofcs as $ofc)
			{
				$sheet->getCell('A'.$rin)->setValue( $ro_name );
				$sheet->getCell('B'.$rin)->setValue( $ofc["name"] );
				$sheet->getCell('C'.$rin)->setValue( $ofc["power"]["h0_4"] );
				$sheet->getCell('D'.$rin)->setValue( $ofc["power"]["h4_8"] );
				$sheet->getCell('E'.$rin)->setValue( $ofc["power"]["h8_12"] );
				$sheet->getCell('F'.$rin)->setValue( $ofc["power"]["h12_16"] );
				$sheet->getCell('G'.$rin)->setValue( $ofc["power"]["h16_20"] );
				$sheet->getCell('H'.$rin)->setValue( $ofc["power"]["h20_24"] );
				$sheet->getCell('I'.$rin)->setValue( $ofc["power"]["hg24"] );
				$sheet->getCell('J'.$rin)->setValue( ( $ofc["power"]["h0_4"] + $ofc["power"]["h4_8"] + $ofc["power"]["h8_12"] + $ofc["power"]["h12_16"] + $ofc["power"]["h16_20"] + $ofc["power"]["h20_24"] + $ofc["power"]["hg24"] ) );

				$sheet->getCell('M'.$rin)->setValue( $ro_name );
				$sheet->getCell('N'.$rin)->setValue( $ofc["name"] );
				$sheet->getCell('O'.$rin)->setValue( $ofc["outage_2g"]["h0_6"] );
				$sheet->getCell('P'.$rin)->setValue( $ofc["outage_2g"]["h6_12"] );
				$sheet->getCell('Q'.$rin)->setValue( $ofc["outage_2g"]["h12_24"] );
				$sheet->getCell('R'.$rin)->setValue( $ofc["outage_2g"]["hg24"] );
				$sheet->getCell('S'.$rin)->setValue( ( $ofc["outage_2g"]["h0_6"] + $ofc["outage_2g"]["h6_12"] + $ofc["outage_2g"]["h12_24"] + $ofc["outage_2g"]["hg24"] ) );


				$totals["power"]["h0_4"] += $ofc["power"]["h0_4"];
				$totals["power"]["h4_8"] += $ofc["power"]["h4_8"];
				$totals["power"]["h8_12"] += $ofc["power"]["h8_12"];
				$totals["power"]["h12_16"] += $ofc["power"]["h12_16"];
				$totals["power"]["h16_20"] += $ofc["power"]["h16_20"];
				$totals["power"]["h20_24"] += $ofc["power"]["h20_24"];
				$totals["power"]["hg24"] += $ofc["power"]["hg24"];

				$totals["outage_2g"]["h0_6"] += $ofc["outage_2g"]["h0_6"];
				$totals["outage_2g"]["h6_12"] += $ofc["outage_2g"]["h6_12"];
				$totals["outage_2g"]["h12_24"] += $ofc["outage_2g"]["h12_24"];
				$totals["outage_2g"]["hg24"] += $ofc["outage_2g"]["hg24"];

				$rin++;
			}
		}

		// total Row
		$sheet->getCell('A'.$rin)->setValue( 'Total' );
		$sheet->getCell('B'.$rin)->setValue( '' );
		$sheet->getCell('C'.$rin)->setValue( $totals["power"]["h0_4"] );
		$sheet->getCell('D'.$rin)->setValue( $totals["power"]["h4_8"] );
		$sheet->getCell('E'.$rin)->setValue( $totals["power"]["h8_12"] );
		$sheet->getCell('F'.$rin)->setValue( $totals["power"]["h12_16"] );
		$sheet->getCell('G'.$rin)->setValue( $totals["power"]["h16_20"] );
		$sheet->getCell('H'.$rin)->setValue( $totals["power"]["h20_24"] );
		$sheet->getCell('I'.$rin)->setValue( $totals["power"]["hg24"] );
		$sheet->getCell('J'.$rin)->setValue( ( $totals["power"]["h0_4"] + $totals["power"]["h4_8"] + $totals["power"]["h8_12"] + $totals["power"]["h12_16"] + $totals["power"]["h16_20"] + $totals["power"]["h20_24"] + $totals["power"]["hg24"] ) );

		$sheet->getCell('M'.$rin)->setValue( 'Total' );
		$sheet->getCell('N'.$rin)->setValue( '' );
		$sheet->getCell('O'.$rin)->setValue( $totals["outage_2g"]["h0_6"] );
		$sheet->getCell('P'.$rin)->setValue( $totals["outage_2g"]["h6_12"] );
		$sheet->getCell('Q'.$rin)->setValue( $totals["outage_2g"]["h12_24"] );
		$sheet->getCell('R'.$rin)->setValue( $totals["outage_2g"]["hg24"] );
		$sheet->getCell('S'.$rin)->setValue( ( $totals["outage_2g"]["h0_6"] + $totals["outage_2g"]["h6_12"] + $totals["outage_2g"]["h12_24"] + $totals["outage_2g"]["hg24"] ) );

		$rin++;
		$rin++;
		$rin++;


		$sheet->getCell('A'.$rin)->setValue('District Wise Active power alarm');
		$sheet->mergeCells('A'.$rin.':J'.$rin);
		$sheet->getCell('M'.$rin)->setValue('District Wise Active Site Down');
		$sheet->mergeCells('M'.$rin.':S'.$rin);
		$rin++;

		$sheet->getCell('A'.$rin)->setValue('RO');
		$sheet->getCell('B'.$rin)->setValue('District');
		$sheet->getCell('C'.$rin)->setValue('0<Hr<4');
		$sheet->getCell('D'.$rin)->setValue('4<Hr<8');
		$sheet->getCell('E'.$rin)->setValue('8<Hr<12');
		$sheet->getCell('F'.$rin)->setValue('12<Hr<16');
		$sheet->getCell('G'.$rin)->setValue('16<Hr<20');
		$sheet->getCell('H'.$rin)->setValue('20<Hr<24');
		$sheet->getCell('I'.$rin)->setValue('Hr>24');
		$sheet->getCell('J'.$rin)->setValue('Total');

		$sheet->getCell('M'.$rin)->setValue('RO');
		$sheet->getCell('N'.$rin)->setValue('O&M Office');
		$sheet->getCell('O'.$rin)->setValue('0<Hr<6');
		$sheet->getCell('P'.$rin)->setValue('6<Hr<12');
		$sheet->getCell('Q'.$rin)->setValue('12<Hr<24');
		$sheet->getCell('R'.$rin)->setValue('Hr>24');
		$sheet->getCell('S'.$rin)->setValue('Total');

		$sheet->getStyle('A'.($rin-1).':S'.$rin)->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('A'.($rin-1).':S'.$rin)->applyFromArray($ha_style);
		$rin++;


		$totals = array(
			"power" => array("h0_4"=>0,"h4_8"=>0,"h8_12"=>0,"h12_16"=>0,"h16_20"=>0,"h20_24"=>0,"hg24"=>0),
			"outage_2g" => array("h0_6"=>0,"h6_12"=>0,"h12_24"=>0,"hg24"=>0),
		);
		ksort($district_counts);
		foreach ($district_counts as $dis_name => $ddata)
		{
			$sheet->getCell('A'.$rin)->setValue( $ddata["ro"] );
			$sheet->getCell('B'.$rin)->setValue( $dis_name );
			$sheet->getCell('C'.$rin)->setValue( $ddata["power"]["h0_4"] );
			$sheet->getCell('D'.$rin)->setValue( $ddata["power"]["h4_8"] );
			$sheet->getCell('E'.$rin)->setValue( $ddata["power"]["h8_12"] );
			$sheet->getCell('F'.$rin)->setValue( $ddata["power"]["h12_16"] );
			$sheet->getCell('G'.$rin)->setValue( $ddata["power"]["h16_20"] );
			$sheet->getCell('H'.$rin)->setValue( $ddata["power"]["h20_24"] );
			$sheet->getCell('I'.$rin)->setValue( $ddata["power"]["hg24"] );
			$sheet->getCell('J'.$rin)->setValue( ( $ddata["power"]["h0_4"] + $ddata["power"]["h4_8"] + $ddata["power"]["h8_12"] + $ddata["power"]["h12_16"] + $ddata["power"]["h16_20"] + $ddata["power"]["h20_24"] + $ddata["power"]["hg24"] ) );

			$sheet->getCell('M'.$rin)->setValue( $ddata["ro"] );
			$sheet->getCell('N'.$rin)->setValue( $dis_name );
			$sheet->getCell('O'.$rin)->setValue( $ddata["outage_2g"]["h0_6"] );
			$sheet->getCell('P'.$rin)->setValue( $ddata["outage_2g"]["h6_12"] );
			$sheet->getCell('Q'.$rin)->setValue( $ddata["outage_2g"]["h12_24"] );
			$sheet->getCell('R'.$rin)->setValue( $ddata["outage_2g"]["hg24"] );
			$sheet->getCell('S'.$rin)->setValue( ( $ddata["outage_2g"]["h0_6"] + $ddata["outage_2g"]["h6_12"] + $ddata["outage_2g"]["h12_24"] + $ddata["outage_2g"]["hg24"] ) );


			$totals["power"]["h0_4"] += $ddata["power"]["h0_4"];
			$totals["power"]["h4_8"] += $ddata["power"]["h4_8"];
			$totals["power"]["h8_12"] += $ddata["power"]["h8_12"];
			$totals["power"]["h12_16"] += $ddata["power"]["h12_16"];
			$totals["power"]["h16_20"] += $ddata["power"]["h16_20"];
			$totals["power"]["h20_24"] += $ddata["power"]["h20_24"];
			$totals["power"]["hg24"] += $ddata["power"]["hg24"];

			$totals["outage_2g"]["h0_6"] += $ddata["outage_2g"]["h0_6"];
			$totals["outage_2g"]["h6_12"] += $ddata["outage_2g"]["h6_12"];
			$totals["outage_2g"]["h12_24"] += $ddata["outage_2g"]["h12_24"];
			$totals["outage_2g"]["hg24"] += $ddata["outage_2g"]["hg24"];

			$rin++;
		}

		// total Row
		$sheet->getCell('A'.$rin)->setValue( 'Total' );
		$sheet->getCell('B'.$rin)->setValue( '' );
		$sheet->getCell('C'.$rin)->setValue( $totals["power"]["h0_4"] );
		$sheet->getCell('D'.$rin)->setValue( $totals["power"]["h4_8"] );
		$sheet->getCell('E'.$rin)->setValue( $totals["power"]["h8_12"] );
		$sheet->getCell('F'.$rin)->setValue( $totals["power"]["h12_16"] );
		$sheet->getCell('G'.$rin)->setValue( $totals["power"]["h16_20"] );
		$sheet->getCell('H'.$rin)->setValue( $totals["power"]["h20_24"] );
		$sheet->getCell('I'.$rin)->setValue( $totals["power"]["hg24"] );
		$sheet->getCell('J'.$rin)->setValue( ( $totals["power"]["h0_4"] + $totals["power"]["h4_8"] + $totals["power"]["h8_12"] + $totals["power"]["h12_16"] + $totals["power"]["h16_20"] + $totals["power"]["h20_24"] + $totals["power"]["hg24"] ) );

		$sheet->getCell('M'.$rin)->setValue( 'Total' );
		$sheet->getCell('N'.$rin)->setValue( '' );
		$sheet->getCell('O'.$rin)->setValue( $totals["outage_2g"]["h0_6"] );
		$sheet->getCell('P'.$rin)->setValue( $totals["outage_2g"]["h6_12"] );
		$sheet->getCell('Q'.$rin)->setValue( $totals["outage_2g"]["h12_24"] );
		$sheet->getCell('R'.$rin)->setValue( $totals["outage_2g"]["hg24"] );
		$sheet->getCell('S'.$rin)->setValue( ( $totals["outage_2g"]["h0_6"] + $totals["outage_2g"]["h6_12"] + $totals["outage_2g"]["h12_24"] + $totals["outage_2g"]["hg24"] ) );







		$regions = array(
			'BARISHAL',
			'CHATTOGRAM',
			'DHAKA',
			'KHULNA',
			'RAJSHAHI',
			'SYLHET',
			'RANGPUR',
			'MYMENSINGH',
		);

		$reg_counts = array();
		foreach ($regions as $reg)
		{
			$reg_counts [$reg] = array(
				"power"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
				"outage_2g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
				"outage_3g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
				"outage_4g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
			);
		}

		$sel1b_hours_stats = null;
		$sel2b_hours_stats = null;
		$sel3b_hours_stats = null;

		$sel1b_tmm_stats = array(
			"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
		);
		$sel2b_tmm_stats =  array(
			"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
		);
		$sel3b_tmm_stats =  array(
			"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
			"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
		);

		for ($i=1; $i <= 3; $i++)
		{
			${"sel".$i."b_hours_stats"} = $this->get_affected_at_hour( $actpowers, $logpowers, $outages, date("Y-m-d H:00:00", @strtotime("-$i hours", @strtotime($sel_ts))) );

			foreach (${"sel".$i."b_hours_stats"}["power_sites"] as $sid => $alrm_tm)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];

					if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
					{
						$reg_counts[$site["zone"]]["power"]["p".$i."hb"]++;
					}
				}
			}

			foreach (${"sel".$i."b_hours_stats"}["site_2go_ids"] as $sid => $outage_tm)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];

					if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
					{
						$reg_counts[$site["zone"]]["outage_2g"]["p".$i."hb"]++;
					}

					${"sel".$i."b_tmm_stats"}["2g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						${"sel".$i."b_tmm_stats"}["2g"]["macro"]++;
					else
						${"sel".$i."b_tmm_stats"}["2g"]["micro"]++;
				}
			}

			foreach (${"sel".$i."b_hours_stats"}["site_3go_ids"] as $sid => $outage_tm)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];

					if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
					{
						$reg_counts[$site["zone"]]["outage_3g"]["p".$i."hb"]++;
					}

					${"sel".$i."b_tmm_stats"}["3g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						${"sel".$i."b_tmm_stats"}["3g"]["macro"]++;
					else
						${"sel".$i."b_tmm_stats"}["3g"]["micro"]++;
				}
			}

			foreach (${"sel".$i."b_hours_stats"}["site_4go_ids"] as $sid => $outage_tm)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];

					if( $site["zone"] != null && isset($reg_counts[$site["zone"]]) )
					{
						$reg_counts[$site["zone"]]["outage_4g"]["p".$i."hb"]++;
					}

					${"sel".$i."b_tmm_stats"}["4g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						${"sel".$i."b_tmm_stats"}["4g"]["macro"]++;
					else
						${"sel".$i."b_tmm_stats"}["4g"]["micro"]++;
				}
			}
		}

		$rin = 3;
		$totals = array(
			"power"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
			"outage_2g"=>array("p1hb"=>0,"p2hb"=>0,"p3hb"=>0),
		);
		foreach ($reg_counts as $reg_name => $reg_data)
		{
			$sheet->getCell('V'.$rin)->setValue($reg_name);
			$sheet->getCell('W'.$rin)->setValue( $reg_data["power"]["p3hb"] );
			$sheet->getCell('X'.$rin)->setValue( $reg_data["power"]["p2hb"] );
			$sheet->getCell('Y'.$rin)->setValue( $reg_data["power"]["p1hb"] );
			$sheet->getCell('Z'.$rin)->setValue( $reg_data["outage_2g"]["p3hb"] );
			$sheet->getCell('AA'.$rin)->setValue( $reg_data["outage_2g"]["p2hb"] );
			$sheet->getCell('AB'.$rin)->setValue( $reg_data["outage_2g"]["p1hb"] );

			$totals["power"]["p3hb"] += $reg_data["power"]["p3hb"];
			$totals["power"]["p2hb"] += $reg_data["power"]["p2hb"];
			$totals["power"]["p1hb"] += $reg_data["power"]["p1hb"];
			$totals["outage_2g"]["p3hb"] += $reg_data["outage_2g"]["p3hb"];
			$totals["outage_2g"]["p2hb"] += $reg_data["outage_2g"]["p2hb"];
			$totals["outage_2g"]["p1hb"] += $reg_data["outage_2g"]["p1hb"];

			$rin++;
		}

		// Total Reg Data
		$sheet->getCell('V'.$rin)->setValue( 'Total' );
		$sheet->getCell('W'.$rin)->setValue( $totals["power"]["p3hb"] );
		$sheet->getCell('X'.$rin)->setValue( $totals["power"]["p2hb"] );
		$sheet->getCell('Y'.$rin)->setValue( $totals["power"]["p1hb"] );
		$sheet->getCell('Z'.$rin)->setValue( $totals["outage_2g"]["p3hb"] );
		$sheet->getCell('AA'.$rin)->setValue( $totals["outage_2g"]["p2hb"] );
		$sheet->getCell('AB'.$rin)->setValue( $totals["outage_2g"]["p1hb"] );







		$shind = 1;
		$sheet = $phpExcel->createSheet($shind);
		$sheet->setTitle("SMS");
		$shind++;

		$sheet->getCell('A1')->setValue('#');

		$selhs = date("H:00", @strtotime($sel_ts))."Hrs";

		$sheet->getCell('B2')->setValue('Priority SMS');
		$sheet->getCell('B3')->setValue('2G Sites Down at '.$selhs);

		$counts = array(
			"p1"=>array("in_house"=>0,"msd"=>0),
			"p2"=>array("in_house"=>0,"msd"=>0),
			"p3"=>array("in_house"=>0,"msd"=>0),
			"power"=>array("in_house"=>0,"msd"=>0),
		);


		$countspw = array(
			"2g"=>array(
				"total"=>0,
				"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
				"macro"=>0,
				"micro"=>0,
				"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"g2h"=>0,
				"l2h"=>0,
			),
			"3g"=>array(
				"total"=>0,
				"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
				"macro"=>0,
				"micro"=>0,
				"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"g2h"=>0,
				"l2h"=>0,
			),
			"4g"=>array(
				"total"=>0,
				"p1"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p2"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"p3"=>array("in_house"=>0,"msd"=>0,"total"=>0),
				"shared"=>array("gp"=>0,"robi"=>0,"airtel"=>0,"stl"=>0,"e_co"=>0,"ftb"=>0,"ktbl"=>0,"btcl"=>0,"total"=>0),
				"macro"=>0,
				"micro"=>0,
				"in_house"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"msd"=>array("g2h"=>0,"l2h"=>0,"total"=>0),
				"g2h"=>0,
				"l2h"=>0,
			),
		);

		$om_ofcs = array(
			"in_house"=>array(),
			"msd"=>array(),
			"in_house_t"=>array(
				"g2h"=>array(
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				),
				"l2h"=>array(
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				),
			),
			"msd_t"=>array(
				"g2h"=>array(
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				),
				"l2h"=>array(
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				),
			),
		);
		
		$shared_2g = array(
			"gp"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"robi"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"airtel"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"stl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"e_co"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"ftb"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"ktbl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
			"btcl"=>array("bl_own"=>0,"ac_ps"=>0,"dc_ps_cr"=>0,"dc_ps_sr"=>0,"dg_ps_cr"=>0,"total"=>0),
		);

		$regions = array(
			'BARISHAL',
			'CHATTOGRAM',
			'DHAKA',
			'KHULNA',
			'RAJSHAHI',
			'SYLHET',
			'RANGPUR',
			'MYMENSINGH',
		);
		$division_wise = array();
		foreach ($regions as $reg)
		{
			$division_wise [$reg] = array(
				"total_2g"=>0,
				"outage_2g"=>0,
				"total_3g"=>0,
				"outage_3g"=>0,
				"total_4g"=>0,
				"outage_4g"=>0,
			);
		}

		$countow = array();
		foreach ($om_ofc_resp->data as $key => $om_ofc)
		{
			if( $om_ofc->office_type_id == 1 )
			{
				$countow [$om_ofc->id] = array(
					"name"=>$om_ofc->name,
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				);
			}

			if( $om_ofc->office_type_id == 1 )
			{
				$om_ofcs["in_house"][$om_ofc->id] = array(
					"name"=>$om_ofc->name,
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				);
			}
			else if( $om_ofc->office_type_id == 2 )
			{
				$om_ofcs["msd"][$om_ofc->id] = array(
					"name"=>$om_ofc->name,
					"2g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"3g"=>array("macro"=>0,"micro"=>0,"total"=>0),
					"4g"=>array("macro"=>0,"micro"=>0,"total"=>0),
				);
			}
		}

		foreach ($site_mem_resp->site_list as $site)
		{
			if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
			{
				if( $site["site_code_2g"] != null )
					$division_wise[$site["zone"]]["total_2g"]++;

				if( $site["site_code_3g"] != null )
					$division_wise[$site["zone"]]["total_3g"]++;

				if( $site["site_code_4g"] != null )
					$division_wise[$site["zone"]]["total_4g"]++;
			}
		}

		foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				$countspw["2g"]["total"]++;
				if( $site["om_office_type"] == 1 )
					$countspw["2g"]["in_house"]["total"]++;
				else if( $site["om_office_type"] == 2 )
					$countspw["2g"]["msd"]["total"]++;

				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

				if( $dif >= 0 && $dif < (2*60*60) )
				{
					$countspw["2g"]["l2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["2g"]["in_house"]["l2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["2g"]["msd"]["l2h"]++;
				}
				else if( $dif >= (2*60*60) )
				{
					$countspw["2g"]["g2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["2g"]["in_house"]["g2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["2g"]["msd"]["g2h"]++;
				}

				$pkey = null;
				if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
					$pkey = "p1";
				else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
					$pkey = "p2";
				else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
					$pkey = "p3";
				
				if( $pkey != null )
				{
					$countspw["2g"][$pkey]["total"]++;
					if( $site["om_office_type"] == 1 )
					{
						$counts[$pkey]["in_house"]++;
						$countspw["2g"][$pkey]["in_house"]++;
					}
					else if( $site["om_office_type"] == 2 )
					{
						$counts[$pkey]["msd"]++;
						$countspw["2g"][$pkey]["msd"]++;
					}
				}

				$shr_key = null;
				if( $site["shared_operator"] == "AIRTEL" )
					$shr_key = "airtel";
				else if( $site["shared_operator"] == "GP" )
					$shr_key = "gp";
				else if( $site["shared_operator"] == "ROBI" )
					$shr_key = "robi";
				else if( $site["shared_operator"] == "STL" )
					$shr_key = "stl";
				else if( $site["shared_operator"] == "E.Co" )
					$shr_key = "e_co";
				else if( $site["shared_operator"] == "FTB" )
					$shr_key = "ftb";
				else if( $site["shared_operator"] == "KTBL" )
					$shr_key = "ktbl";
				else if( $site["shared_operator"] == "BTCL" )
					$shr_key = "btcl";

				$shr_type = null;
				if( $shr_key != null && $site["sharing_type"] != null )
				{
					if( $site["sharing_type"] == "BL Own Power" )
						$shr_type = "bl_own";
					else if( $site["sharing_type"] == "AC Power share" )
						$shr_type = "ac_ps";
					else if( $site["sharing_type"] == "DC power share, Common rectifier" )
						$shr_type = "dc_ps_cr";
					else if( $site["sharing_type"] == "DC power share, Separate rectifier" )
						$shr_type = "dc_ps_sr";
					else if( $site["sharing_type"] == "DG power share, Common rectifier" )
						$shr_type = "dg_ps_cr";
					// else if( $site["sharing_type"] == "DG power share, Separate rectifier" )
					// 	$shr_type = "bl_own";
				}

				if( $shr_key != null )
				{
					$countspw["2g"]["shared"]["total"]++;
					$countspw["2g"]["shared"][$shr_key]++;

					$shared_2g[$shr_key]["total"]++;
					if( $shr_key != null && $shr_type != null )
					{
						$shared_2g[$shr_key][$shr_type]++;
					}
				}

				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
				    $countspw["2g"]["macro"]++;
				else
					$countspw["2g"]["micro"]++;

				if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
				{
					$countow[$site["om_office_id"]]["2g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						$countow[$site["om_office_id"]]["2g"]["macro"]++;
					else
						$countow[$site["om_office_id"]]["2g"]["micro"]++;
				}

				if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
					$division_wise[$site["zone"]]["outage_2g"]++;

				if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
				{
					$om_ofcs["in_house"][$site["om_office_id"]]["2g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["in_house"][$site["om_office_id"]]["2g"]["macro"]++;
					else
						$om_ofcs["in_house"][$site["om_office_id"]]["2g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["in_house_t"]["l2h"]["2g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["l2h"]["2g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["l2h"]["2g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["in_house_t"]["g2h"]["2g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["g2h"]["2g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["g2h"]["2g"]["micro"]++;
					}
				}
				else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
				{
					$om_ofcs["msd"][$site["msd_office_id"]]["2g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["msd"][$site["msd_office_id"]]["2g"]["macro"]++;
					else
						$om_ofcs["msd"][$site["msd_office_id"]]["2g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["msd_t"]["l2h"]["2g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["l2h"]["2g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["l2h"]["2g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["msd_t"]["g2h"]["2g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["g2h"]["2g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["g2h"]["2g"]["micro"]++;
					}
				}
			}
		}

		foreach ($sel_hours_stats["site_3go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				$countspw["3g"]["total"]++;
				if( $site["om_office_type"] == 1 )
					$countspw["3g"]["in_house"]["total"]++;
				else if( $site["om_office_type"] == 2 )
					$countspw["3g"]["msd"]["total"]++;

				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

				if( $dif >= 0 && $dif < (2*60*60) )
				{
					$countspw["3g"]["l2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["3g"]["in_house"]["l2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["3g"]["msd"]["l2h"]++;
				}
				else if( $dif >= (2*60*60) )
				{
					$countspw["3g"]["g2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["3g"]["in_house"]["g2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["3g"]["msd"]["g2h"]++;
				}

				$pkey = null;
				if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
					$pkey = "p1";
				else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
					$pkey = "p2";
				else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
					$pkey = "p3";

				if( $pkey != null )
				{
					$countspw["3g"][$pkey]["total"]++;
					if( $site["om_office_type"] == 1 )
					{
						$countspw["3g"][$pkey]["in_house"]++;
					}
					else if( $site["om_office_type"] == 2 )
					{
						$countspw["3g"][$pkey]["msd"]++;
					}
				}

				$shr_key = null;
				if( $site["shared_operator"] == "AIRTEL" )
					$shr_key = "airtel";
				else if( $site["shared_operator"] == "GP" )
					$shr_key = "gp";
				else if( $site["shared_operator"] == "ROBI" )
					$shr_key = "robi";
				else if( $site["shared_operator"] == "STL" )
					$shr_key = "stl";
				else if( $site["shared_operator"] == "E.Co" )
					$shr_key = "e_co";
				else if( $site["shared_operator"] == "FTB" )
					$shr_key = "ftb";
				else if( $site["shared_operator"] == "KTBL" )
					$shr_key = "ktbl";
				else if( $site["shared_operator"] == "BTCL" )
					$shr_key = "btcl";

				if( $shr_key != null )
				{
					$countspw["3g"]["shared"]["total"]++;
					$countspw["3g"]["shared"][$shr_key]++;
				}

				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
				    $countspw["3g"]["macro"]++;
				else
					$countspw["3g"]["micro"]++;

				if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
				{
					$countow[$site["om_office_id"]]["3g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						$countow[$site["om_office_id"]]["3g"]["macro"]++;
					else
						$countow[$site["om_office_id"]]["3g"]["micro"]++;
				}

				if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
					$division_wise[$site["zone"]]["outage_3g"]++;

				if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
				{
					$om_ofcs["in_house"][$site["om_office_id"]]["3g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["in_house"][$site["om_office_id"]]["3g"]["macro"]++;
					else
						$om_ofcs["in_house"][$site["om_office_id"]]["3g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["in_house_t"]["l2h"]["3g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["l2h"]["3g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["l2h"]["3g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["in_house_t"]["g2h"]["3g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["g2h"]["3g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["g2h"]["3g"]["micro"]++;
					}
				}
				else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
				{
					$om_ofcs["msd"][$site["msd_office_id"]]["3g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["msd"][$site["msd_office_id"]]["3g"]["macro"]++;
					else
						$om_ofcs["msd"][$site["msd_office_id"]]["3g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["msd_t"]["l2h"]["3g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["l2h"]["3g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["l2h"]["3g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["msd_t"]["g2h"]["3g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["g2h"]["3g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["g2h"]["3g"]["micro"]++;
					}
				}
			}
		}

		foreach ($sel_hours_stats["site_4go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				$countspw["4g"]["total"]++;
				if( $site["om_office_type"] == 1 )
					$countspw["4g"]["in_house"]["total"]++;
				else if( $site["om_office_type"] == 2 )
					$countspw["4g"]["msd"]["total"]++;

				$dif = @strtotime($sel_ts) - @strtotime($outage_tm);

				if( $dif >= 0 && $dif < (2*60*60) )
				{
					$countspw["4g"]["l2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["4g"]["in_house"]["l2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["4g"]["msd"]["l2h"]++;
				}
				else if( $dif >= (2*60*60) )
				{
					$countspw["4g"]["g2h"]++;
					if( $site["om_office_type"] == 1 )
						$countspw["4g"]["in_house"]["g2h"]++;
					else if( $site["om_office_type"] == 2 )
						$countspw["4g"]["msd"]["g2h"]++;
				}

				$pkey = null;
				if( $site["site_priority"] == "P1" || $site["site_priority"] == "Platinum-P1" || $site["site_priority"] == "Gold-P1" )
					$pkey = "p1";
				else if( $site["site_priority"] == "P2" || $site["site_priority"] == "Platinum-P2" )
					$pkey = "p2";
				else if( $site["site_priority"] == "P3" || $site["site_priority"] == "Platinum-P3" )
					$pkey = "p3";

				if( $pkey != null )
				{
					$countspw["4g"][$pkey]["total"]++;
					if( $site["om_office_type"] == 1 )
					{
						$countspw["4g"][$pkey]["in_house"]++;
					}
					else if( $site["om_office_type"] == 2 )
					{
						$countspw["4g"][$pkey]["msd"]++;
					}
				}

				$shr_key = null;
				if( $site["shared_operator"] == "AIRTEL" )
					$shr_key = "airtel";
				else if( $site["shared_operator"] == "GP" )
					$shr_key = "gp";
				else if( $site["shared_operator"] == "ROBI" )
					$shr_key = "robi";
				else if( $site["shared_operator"] == "STL" )
					$shr_key = "stl";
				else if( $site["shared_operator"] == "E.Co" )
					$shr_key = "e_co";
				else if( $site["shared_operator"] == "FTB" )
					$shr_key = "ftb";
				else if( $site["shared_operator"] == "KTBL" )
					$shr_key = "ktbl";
				else if( $site["shared_operator"] == "BTCL" )
					$shr_key = "btcl";

				if( $shr_key != null )
				{
					$countspw["4g"]["shared"]["total"]++;
					$countspw["4g"]["shared"][$shr_key]++;
				}

				if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
				    $countspw["4g"]["macro"]++;
				else
					$countspw["4g"]["micro"]++;

				if( $site["om_office_id"] != null && isset($countow[$site["om_office_id"]]) )
				{
					$countow[$site["om_office_id"]]["4g"]["total"]++;
					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						$countow[$site["om_office_id"]]["4g"]["macro"]++;
					else
						$countow[$site["om_office_id"]]["4g"]["micro"]++;
				}

				if( $site["zone"] != null && isset($division_wise[$site["zone"]]) )
					$division_wise[$site["zone"]]["outage_4g"]++;

				if( $site["om_office_type"] == 1 && $site["om_office_id"] != null && isset($om_ofcs["in_house"][$site["om_office_id"]]) )
				{
					$om_ofcs["in_house"][$site["om_office_id"]]["4g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["in_house"][$site["om_office_id"]]["4g"]["macro"]++;
					else
						$om_ofcs["in_house"][$site["om_office_id"]]["4g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["in_house_t"]["l2h"]["4g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["l2h"]["4g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["l2h"]["4g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["in_house_t"]["g2h"]["4g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["in_house_t"]["g2h"]["4g"]["macro"]++;
						else
							$om_ofcs["in_house_t"]["g2h"]["4g"]["micro"]++;
					}
				}
				else if( $site["om_office_type"] == 2 && $site["msd_office_id"] != null && isset($om_ofcs["msd"][$site["msd_office_id"]]) )
				{
					$om_ofcs["msd"][$site["msd_office_id"]]["4g"]["total"]++;

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $om_ofcs["msd"][$site["msd_office_id"]]["4g"]["macro"]++;
					else
						$om_ofcs["msd"][$site["msd_office_id"]]["4g"]["micro"]++;

					if( $dif >= 0 && $dif < (2*60*60) )
					{
						$om_ofcs["msd_t"]["l2h"]["4g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["l2h"]["4g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["l2h"]["4g"]["micro"]++;
					}
					else if( $dif >= (2*60*60) )
					{
						$om_ofcs["msd_t"]["g2h"]["4g"]["total"]++;
						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $om_ofcs["msd_t"]["g2h"]["4g"]["macro"]++;
						else
							$om_ofcs["msd_t"]["g2h"]["4g"]["micro"]++;
					}
				}
			}
		}

		foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["om_office_type"] == 1 )
					$counts["power"]["in_house"]++;
				else if( $site["om_office_type"] == 2 )
					$counts["power"]["msd"]++;
			}
		}

		// for 2G
		$sheet->getCell('B4')->setValue('P1: '.($counts["p1"]["in_house"]+$counts["p1"]["msd"]).' (FLM:'.$counts["p1"]["msd"].', In-House:'.$counts["p1"]["in_house"].')');
		$sheet->getCell('B5')->setValue('P2: '.($counts["p2"]["in_house"]+$counts["p2"]["msd"]).' (FLM:'.$counts["p2"]["msd"].', In-House:'.$counts["p2"]["in_house"].')');
		$sheet->getCell('B6')->setValue('P3: '.($counts["p3"]["in_house"]+$counts["p3"]["msd"]).' (FLM:'.$counts["p3"]["msd"].', In-House:'.$counts["p3"]["in_house"].')');
		$sheet->getCell('B7')->setValue('Grand Total: '.( ($counts["p1"]["in_house"]+$counts["p1"]["msd"]) + ($counts["p2"]["in_house"]+$counts["p2"]["msd"]) + ($counts["p3"]["in_house"]+$counts["p3"]["msd"]) ).' (FLM:'.( $counts["p1"]["msd"] + $counts["p2"]["msd"] + $counts["p3"]["msd"] ).', In-House:'.( $counts["p1"]["in_house"] + $counts["p2"]["in_house"] + $counts["p3"]["in_house"] ).')');
		$sheet->getCell('B8')->setValue('Total Power Alarm: '.($counts["power"]["in_house"]+$counts["power"]["msd"]).' (FLM:'.$counts["power"]["msd"].', In-House:'.$counts["power"]["in_house"].')');

		$sheet->getCell('B15')->setValue('General SMS');
		$sheet->getCell('B16')->setValue('Network Update on '.$selhs);

		$sheet->getStyle('B15:B16')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('B15:B16')->applyFromArray($ha_style);


		$sheet->getCell('B18')->setValue('Sites with no commercial power- '.($counts["power"]["in_house"]+$counts["power"]["msd"]).' (FLM:'.$counts["power"]["msd"].', In-House:'.$counts["power"]["in_house"].')');

		$sheet->getCell('B20')->setValue('Site outages: 2G, 4G (>2Hrs / <2Hrs)');

		$sheet->getCell('B21')->setValue('Total- '.$countspw["2g"]["total"].','.$countspw["4g"]["total"].' ('.$countspw["2g"]["g2h"].','.$countspw["4g"]["g2h"].'/'.$countspw["2g"]["l2h"].','.$countspw["4g"]["l2h"].')');

		$sheet->getCell('B22')->setValue('FLM- '.$countspw["2g"]["msd"]["total"].','.$countspw["4g"]["msd"]["total"].' ('.$countspw["2g"]["msd"]["g2h"].','.$countspw["4g"]["msd"]["g2h"].'/'.$countspw["2g"]["msd"]["l2h"].','.$countspw["4g"]["msd"]["l2h"].')');

		$sheet->getCell('B23')->setValue('In-House- '.$countspw["2g"]["in_house"]["total"].','.$countspw["4g"]["in_house"]["total"].' ('.$countspw["2g"]["in_house"]["g2h"].','.$countspw["4g"]["in_house"]["g2h"].'/'.$countspw["2g"]["in_house"]["l2h"].','.$countspw["4g"]["in_house"]["l2h"].')');



		$sheet->getCell('B25')->setValue('Site outages priority sites: 2G, 4G (FLM/ In-House)');
		$sheet->getCell('B26')->setValue('P1: '.$countspw["2g"]["p1"]["total"].','.$countspw["4g"]["p1"]["total"].' ('.$countspw["2g"]["p1"]["msd"].','.$countspw["4g"]["p1"]["msd"].'/'.$countspw["2g"]["p1"]["in_house"].','.$countspw["4g"]["p1"]["in_house"].')');

		$sheet->getCell('B27')->setValue('P2: '.$countspw["2g"]["p2"]["total"].','.$countspw["4g"]["p2"]["total"].' ('.$countspw["2g"]["p2"]["msd"].','.$countspw["4g"]["p2"]["msd"].'/'.$countspw["2g"]["p2"]["in_house"].','.$countspw["4g"]["p2"]["in_house"].')');

		$sheet->getCell('B28')->setValue('P3: '.$countspw["2g"]["p3"]["total"].','.$countspw["4g"]["p3"]["total"].' ('.$countspw["2g"]["p3"]["msd"].','.$countspw["4g"]["p3"]["msd"].'/'.$countspw["2g"]["p3"]["in_house"].','.$countspw["4g"]["p3"]["in_house"].')');


		$sheet->getCell('B30')->setValue('Major outages: 2G, 4G (Macro/ Micro)');
		$rin = 30;
		foreach ($countow as $ofc_data)
		{
			if( $ofc_data["2g"]["total"] > 10 || $ofc_data["4g"]["total"] > 10 )
			{
				$rin++;
				$sheet->getCell('B'.$rin)->setValue( $ofc_data["name"].': '.$ofc_data["2g"]["total"].','.$ofc_data["4g"]["total"].' ('.$ofc_data["2g"]["macro"].','.$ofc_data["4g"]["macro"].'/'.$ofc_data["2g"]["micro"].','.$ofc_data["4g"]["micro"].')');
			}
		}

		$rin++;
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('Shared Sites Down: 2G, 4G');
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('Total: '.$countspw["2g"]["shared"]["total"].','.$countspw["4g"]["shared"]["total"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('GP: '.$countspw["2g"]["shared"]["gp"].','.$countspw["4g"]["shared"]["gp"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('ROBI: '.$countspw["2g"]["shared"]["robi"].','.$countspw["4g"]["shared"]["robi"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('AIRTEL: '.$countspw["2g"]["shared"]["airtel"].','.$countspw["4g"]["shared"]["airtel"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('STL: '.$countspw["2g"]["shared"]["stl"].','.$countspw["4g"]["shared"]["stl"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('E.Co: '.$countspw["2g"]["shared"]["e_co"].','.$countspw["4g"]["shared"]["e_co"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('FTB: '.$countspw["2g"]["shared"]["ftb"].','.$countspw["4g"]["shared"]["ftb"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('KTBL: '.$countspw["2g"]["shared"]["ktbl"].','.$countspw["4g"]["shared"]["ktbl"]);
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('BTCL: '.$countspw["2g"]["shared"]["btcl"].','.$countspw["4g"]["shared"]["btcl"]);

		$rin++;
		$rin++;
		$sheet->getCell('B'.$rin)->setValue('Total site outages: 2G, 4G (Macro/ Micro)');

		$rin++;
		$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-3 hours", @strtotime($sel_ts))).'Hrs: '.$sel3b_tmm_stats["2g"]["total"].','.$sel3b_tmm_stats["4g"]["total"].' ('.$sel3b_tmm_stats["2g"]["macro"].','.$sel3b_tmm_stats["4g"]["macro"].'/'.$sel3b_tmm_stats["2g"]["micro"].','.$sel3b_tmm_stats["4g"]["micro"].')');
		$rin++;
		$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-2 hours", @strtotime($sel_ts))).'Hrs: '.$sel2b_tmm_stats["2g"]["total"].','.$sel2b_tmm_stats["4g"]["total"].' ('.$sel2b_tmm_stats["2g"]["macro"].','.$sel2b_tmm_stats["4g"]["macro"].'/'.$sel2b_tmm_stats["2g"]["micro"].','.$sel2b_tmm_stats["4g"]["micro"].')');
		$rin++;
		$sheet->getCell('B'.$rin)->setValue(date("H:00", @strtotime("-1 hours", @strtotime($sel_ts))).'Hrs: '.$sel1b_tmm_stats["2g"]["total"].','.$sel1b_tmm_stats["4g"]["total"].' ('.$sel1b_tmm_stats["2g"]["macro"].','.$sel1b_tmm_stats["4g"]["macro"].'/'.$sel1b_tmm_stats["2g"]["micro"].','.$sel1b_tmm_stats["4g"]["micro"].')');
		$rin++;
		$sheet->getCell('B'.$rin)->setValue($selhs.': '.$countspw["2g"]["total"].','.$countspw["4g"]["total"].' ('.$countspw["2g"]["macro"].','.$countspw["4g"]["macro"].'/'.$countspw["2g"]["micro"].','.$countspw["4g"]["micro"].')');




		$sheet->getCell('C2')->setValue('Division SMS');
		$sheet->getCell('C3')->setValue('% of Division wise 2G sites Down at '.$selhs);

		$rin = 4;
		foreach ($division_wise as $dname => $ddata)
		{
			$perc = 0;
			if( $ddata["total_2g"] > 0 )
			{
				$perc = round( ( ($ddata["outage_2g"]*100)/$ddata["total_2g"] ), 2);
			}

			if( $perc > 1 )
			{
				$sheet->getCell('C'.$rin)->setValue($dname.': '.$perc.'%');
				$rin++;
			}
		}



		$sheet->getCell('D2')->setValue('In house SMS');
		$sheet->getCell('D3')->setValue('In-House 2G(Macro/Micro):3G(Macro/Micro):4G(Macro/Micro) Down at '.$selhs);

		$rin = 4;
		foreach ($om_ofcs["in_house"] as $oname => $odata)
		{
			if( $odata["2g"]["total"] > 0 || $odata["3g"]["total"] > 0 || $odata["4g"]["total"] > 0 )
			{
				$sheet->getCell('D'.$rin)->setValue($odata["name"].': '.$odata["2g"]["total"].'('.$odata["2g"]["macro"].'/'.$odata["2g"]["micro"].'),'.$odata["3g"]["total"].'('.$odata["3g"]["macro"].'/'.$odata["3g"]["micro"].'),'.$odata["4g"]["total"].'('.$odata["4g"]["macro"].'/'.$odata["4g"]["micro"].')');
				$rin++;
			}
		}

		$sheet->getCell('D'.$rin)->setValue('>=2Hrs: '.$om_ofcs["in_house_t"]["g2h"]["2g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["2g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["2g"]["micro"].'),'.$om_ofcs["in_house_t"]["g2h"]["3g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["3g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["3g"]["micro"].'),'.$om_ofcs["in_house_t"]["g2h"]["4g"]["total"].'('.$om_ofcs["in_house_t"]["g2h"]["4g"]["macro"].'/'.$om_ofcs["in_house_t"]["g2h"]["4g"]["micro"].')');
		$rin++;

		$sheet->getCell('D'.$rin)->setValue('<2Hrs: '.$om_ofcs["in_house_t"]["l2h"]["2g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["2g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["2g"]["micro"].'),'.$om_ofcs["in_house_t"]["l2h"]["3g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["3g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["3g"]["micro"].'),'.$om_ofcs["in_house_t"]["l2h"]["4g"]["total"].'('.$om_ofcs["in_house_t"]["l2h"]["4g"]["macro"].'/'.$om_ofcs["in_house_t"]["l2h"]["4g"]["micro"].')');


		$sheet->getCell('E2')->setValue('FLM SMS');
		$sheet->getCell('E3')->setValue('FLM 2G(Macro/Micro):3G(Macro/Micro) Down at '.$selhs);

		$rin = 4;
		foreach ($om_ofcs["msd"] as $oname => $odata)
		{
			if( $odata["2g"]["total"] > 0 || $odata["3g"]["total"] > 0 )
			{
				$sheet->getCell('E'.$rin)->setValue($odata["name"].': '.$odata["2g"]["total"].'('.$odata["2g"]["macro"].'/'.$odata["2g"]["micro"].'),'.$odata["3g"]["total"].'('.$odata["3g"]["macro"].'/'.$odata["3g"]["micro"].'),'.$odata["4g"]["total"].'('.$odata["4g"]["macro"].'/'.$odata["4g"]["micro"].')');
				$rin++;
			}
		}

		$sheet->getCell('E'.$rin)->setValue('>=2Hrs: '.$om_ofcs["msd_t"]["g2h"]["2g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["2g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["2g"]["micro"].'),'.$om_ofcs["msd_t"]["g2h"]["3g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["3g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["3g"]["micro"].'),'.$om_ofcs["msd_t"]["g2h"]["4g"]["total"].'('.$om_ofcs["msd_t"]["g2h"]["4g"]["macro"].'/'.$om_ofcs["msd_t"]["g2h"]["4g"]["micro"].')');
		$rin++;

		$sheet->getCell('E'.$rin)->setValue('<2Hrs: '.$om_ofcs["msd_t"]["l2h"]["2g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["2g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["2g"]["micro"].'),'.$om_ofcs["msd_t"]["l2h"]["3g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["3g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["3g"]["micro"].'),'.$om_ofcs["msd_t"]["l2h"]["4g"]["total"].'('.$om_ofcs["msd_t"]["l2h"]["4g"]["macro"].'/'.$om_ofcs["msd_t"]["l2h"]["4g"]["micro"].')');



		$sheet->getCell('F2')->setValue('Shared Site down');
		$sheet->getCell('F3')->setValue('2G Shared Sites Down at '.$selhs);
		
		$sheet->getCell('F4')->setValue('GP: '.$shared_2g["gp"]["total"].' (BL Own:'.$shared_2g["gp"]["bl_own"].', AC PS:'.$shared_2g["gp"]["ac_ps"].', DC PS[CR]:'.$shared_2g["gp"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["gp"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["gp"]["dg_ps_cr"].')');

		$sheet->getCell('F5')->setValue('ROBI: '.$shared_2g["robi"]["total"].' (BL Own:'.$shared_2g["robi"]["bl_own"].', AC PS:'.$shared_2g["robi"]["ac_ps"].', DC PS[CR]:'.$shared_2g["robi"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["robi"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["robi"]["dg_ps_cr"].')');

		$sheet->getCell('F6')->setValue('AIRTEL: '.$shared_2g["airtel"]["total"].' (BL Own:'.$shared_2g["airtel"]["bl_own"].', AC PS:'.$shared_2g["airtel"]["ac_ps"].', DC PS[CR]:'.$shared_2g["airtel"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["airtel"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["airtel"]["dg_ps_cr"].')');

		$sheet->getCell('F7')->setValue('STL: '.$shared_2g["stl"]["total"].' (BL Own:'.$shared_2g["stl"]["bl_own"].', AC PS:'.$shared_2g["stl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["stl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["stl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["stl"]["dg_ps_cr"].')');

		$sheet->getCell('F8')->setValue('E.Co: '.$shared_2g["e_co"]["total"].' (BL Own:'.$shared_2g["e_co"]["bl_own"].', AC PS:'.$shared_2g["e_co"]["ac_ps"].', DC PS[CR]:'.$shared_2g["e_co"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["e_co"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["e_co"]["dg_ps_cr"].')');

		$sheet->getCell('F9')->setValue('FTB: '.$shared_2g["ftb"]["total"].' (BL Own:'.$shared_2g["ftb"]["bl_own"].', AC PS:'.$shared_2g["ftb"]["ac_ps"].', DC PS[CR]:'.$shared_2g["ftb"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["ftb"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["ftb"]["dg_ps_cr"].')');

		$sheet->getCell('F10')->setValue('KTBL: '.$shared_2g["ktbl"]["total"].' (BL Own:'.$shared_2g["ktbl"]["bl_own"].', AC PS:'.$shared_2g["ktbl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["ktbl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["ktbl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["ktbl"]["dg_ps_cr"].')');

		$sheet->getCell('F10')->setValue('BTCL: '.$shared_2g["btcl"]["total"].' (BL Own:'.$shared_2g["btcl"]["bl_own"].', AC PS:'.$shared_2g["btcl"]["ac_ps"].', DC PS[CR]:'.$shared_2g["btcl"]["dc_ps_cr"].', DC PS[SR]:'.$shared_2g["btcl"]["dc_ps_sr"].', DG PS[CR]:'.$shared_2g["btcl"]["dg_ps_cr"].')');

		$sheet->getCell('F11')->setValue('Total: '.( $shared_2g["gp"]["total"] + $shared_2g["robi"]["total"] + $shared_2g["airtel"]["total"] + $shared_2g["stl"]["total"] + $shared_2g["e_co"]["total"] + $shared_2g["ftb"]["total"] + $shared_2g["ktbl"]["total"] + $shared_2g["btcl"]["total"] )
			.' (BL Own:'.( $shared_2g["gp"]["bl_own"] + $shared_2g["robi"]["bl_own"] + $shared_2g["airtel"]["bl_own"] + $shared_2g["stl"]["bl_own"] + $shared_2g["e_co"]["bl_own"] + $shared_2g["ftb"]["bl_own"] + $shared_2g["ktbl"]["bl_own"] + $shared_2g["btcl"]["bl_own"] )
			.', AC PS:'.( $shared_2g["gp"]["ac_ps"] + $shared_2g["robi"]["ac_ps"] + $shared_2g["airtel"]["ac_ps"] + $shared_2g["stl"]["ac_ps"] + $shared_2g["e_co"]["ac_ps"] + $shared_2g["ftb"]["ac_ps"] + $shared_2g["ktbl"]["ac_ps"] + $shared_2g["btcl"]["ac_ps"] )
			.', DC PS[CR]:'.( $shared_2g["gp"]["dc_ps_cr"] + $shared_2g["robi"]["dc_ps_cr"] + $shared_2g["airtel"]["dc_ps_cr"] + $shared_2g["stl"]["dc_ps_cr"] + $shared_2g["e_co"]["dc_ps_cr"] + $shared_2g["ftb"]["dc_ps_cr"] + $shared_2g["ktbl"]["dc_ps_cr"] + $shared_2g["btcl"]["dc_ps_cr"] )
			.', DC PS[SR]:'.( $shared_2g["gp"]["dc_ps_sr"] + $shared_2g["robi"]["dc_ps_sr"] + $shared_2g["airtel"]["dc_ps_sr"] + $shared_2g["stl"]["dc_ps_sr"] + $shared_2g["e_co"]["dc_ps_sr"] + $shared_2g["ftb"]["dc_ps_sr"] + $shared_2g["ktbl"]["dc_ps_sr"] + $shared_2g["btcl"]["dc_ps_sr"] )
			.', DG PS[CR]:'.( $shared_2g["gp"]["dg_ps_cr"] + $shared_2g["robi"]["dg_ps_cr"] + $shared_2g["airtel"]["dg_ps_cr"] + $shared_2g["stl"]["dg_ps_cr"] + $shared_2g["e_co"]["dg_ps_cr"] + $shared_2g["ftb"]["dg_ps_cr"] + $shared_2g["ktbl"]["dg_ps_cr"] + $shared_2g["btcl"]["dg_ps_cr"] ).')');
		

		$sw_2g_out = array();
		$sw_3g_out = array();
		$sw_4g_out = array();

		foreach ($outages as $outage)
		{
			$onact = false;
			if( $outage["running"] )
			{
				if( @strtotime($outage["start_time"]) <= @strtotime($sel_ts) )
					$onact = true;
			}
			else
			{
				if( @strtotime($outage["start_time"]) <= @strtotime($sel_ts) && @strtotime($outage["end_time"]) >= @strtotime($sel_ts) )
					$onact = true;
			}

			if( $onact )
			{
				$tvrname = null;
				if( $outage["technology"] == "2G" )
					$tvrname = "sw_2g_out";
				else if( $outage["technology"] == "3G" )
					$tvrname = "sw_3g_out";
				else if( $outage["technology"] == "4G" )
					$tvrname = "sw_4g_out";

				if( $tvrname != null )
				{
					if( !isset(${$tvrname}[$outage["site_id"]]) )
					{
						${$tvrname}[$outage["site_id"]] = array();
						${$tvrname}[$outage["site_id"]]["site"] = null;
						${$tvrname}[$outage["site_id"]]["cells"] = array();
					}

					if( ${$tvrname}[$outage["site_id"]]["site"] == null && ($outage["type"] == "site" || $outage["type"] == "site_by_cell")  )
					{
						${$tvrname}[$outage["site_id"]]["site"] = $outage;
					}
					else if( $outage["cell_name"] != null && !isset(${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]]) 
						&& $outage["type"] == "cell" )
					{
						${$tvrname}[$outage["site_id"]]["cells"][$outage["cell_name"]] = $outage;
					}
				}
			}
		}

		$ro_wise_sd = array();
		$ros = array('RO-1','RO-2','RO-3','RO-4','RO-5','RO-6');
		foreach ($ros as $ro)
		{
			$ro_wise_sd [$ro] = array(
				"2g"=>array(
					"site"=>array(),
					"cell"=>array(),
				),
				"3g"=>array(
					"site"=>array(),
					"cell"=>array(),
				),
				"4g"=>array(
					"site"=>array(),
					"cell"=>array(),
				),
				"hub_power"=>array(),
			);
		}

		for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";
			foreach (${$tvrname} as $sid => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];
					if( $site["ro"] != null && isset($ro_wise_sd[$site["ro"]]) )
					{
						if( $site_outs["site"] != null )
						{
							$sde = array();
							$sde["site_id"] = $sid;
							$sde["site_code"] = $site["site_code_".$i."g"];
							$sde["priority"] = $site["site_priority"];
							$sde["start_time"] = date("d/m H:i", @strtotime($site_outs["site"]["start_time"]) );
							$sde["office_code"] = null;
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
							}
							$ro_wise_sd[$site["ro"]][$i."g"]["site"][] = $sde;
						}
						else if( sizeof($site_outs["cells"]) > 0 )
						{
							foreach ($site_outs["cells"] as $cell_name => $cell_out)
							{
								$sde = array();
								$sde["site_id"] = $sid;
								$sde["site_code"] = $site["site_code_".$i."g"];
								$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
								$sde["priority"] = $site["site_priority"];
								$sde["start_time"] = date("d/m H:i", @strtotime($cell_out["start_time"]) );
								$sde["office_code"] = null;
								if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
								{
									$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
								}
								$ro_wise_sd[$site["ro"]][$i."g"]["cell"][] = $sde;
							}
						}
					}
				}
			}
		}

		$sheet->getCell('G2')->setValue('RO wise site Down SMS');

		$rin = 3;
		foreach ($ro_wise_sd as $ro_name => $ro_outs)
		{
			$sheet->getCell('G'.$rin)->setValue('Site Down List of '.$ro_name.' at '.$selhs.' (2G-'.sizeof($ro_outs["2g"]["site"]).',3G-'.sizeof($ro_outs["3g"]["site"]).',4G-'.sizeof($ro_outs["4g"]["site"]).')');
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["2g"]["site"]) > 0 )
			{
				foreach ($ro_outs["2g"]["site"] as $site_down)
				{
					$col_data .= $site_down["site_code"];
					$col_data .= " (".$site_down["priority"].")";
					$col_data .= " ".$site_down["start_time"];
					$col_data .= "-".$site_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('G'.$rin)->setValue('2G: '.$col_data);
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["3g"]["site"]) > 0 )
			{
				foreach ($ro_outs["3g"]["site"] as $site_down)
				{
					$col_data .= $site_down["site_code"];
					$col_data .= " (".$site_down["priority"].")";
					$col_data .= " ".$site_down["start_time"];
					$col_data .= "-".$site_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('G'.$rin)->setValue('3G: '.$col_data);
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["4g"]["site"]) > 0 )
			{
				foreach ($ro_outs["4g"]["site"] as $site_down)
				{
					$col_data .= $site_down["site_code"];
					$col_data .= " (".$site_down["priority"].")";
					$col_data .= " ".$site_down["start_time"];
					$col_data .= "-".$site_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('G'.$rin)->setValue('4G: '.$col_data);
			$rin++;
			$rin++;
		}

		$sheet->getCell('H2')->setValue('RO wise Cell SMS');
		
		$rin = 3;
		foreach ($ro_wise_sd as $ro_name => $ro_outs)
		{
			$sheet->getCell('H'.$rin)->setValue('Cell Down List of '.$ro_name.' at '.$selhs.' (2G-'.sizeof($ro_outs["2g"]["cell"]).',3G-'.sizeof($ro_outs["3g"]["cell"]).',4G-'.sizeof($ro_outs["4g"]["cell"]).')');
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["2g"]["cell"]) > 0 )
			{
				foreach ($ro_outs["2g"]["cell"] as $cell_down)
				{
					$col_data .= $cell_down["cell_code"];
					$col_data .= " (".$cell_down["priority"].")";
					$col_data .= " ".$cell_down["start_time"];
					$col_data .= "-".$cell_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('H'.$rin)->setValue('2G: '.$col_data);
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["3g"]["cell"]) > 0 )
			{
				foreach ($ro_outs["3g"]["cell"] as $cell_down)
				{
					$col_data .= $cell_down["cell_code"];
					$col_data .= " (".$cell_down["priority"].")";
					$col_data .= " ".$cell_down["start_time"];
					$col_data .= "-".$cell_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('H'.$rin)->setValue('3G: '.$col_data);
			$rin++;

			$col_data = "";
			if( sizeof($ro_outs["4g"]["cell"]) > 0 )
			{
				foreach ($ro_outs["4g"]["cell"] as $cell_down)
				{
					$col_data .= $cell_down["cell_code"];
					$col_data .= " (".$cell_down["priority"].")";
					$col_data .= " ".$cell_down["start_time"];
					$col_data .= "-".$cell_down["office_code"];
					$col_data .= "\n";
				}
			}
			else
				$col_data = "Null";
			$sheet->getCell('H'.$rin)->setValue('4G: '.$col_data);
			$rin++;
			$rin++;
		}

		foreach ($sel_hours_stats["power_sites"] as $sid => $alrm_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if( $site["ro"] != null && isset($ro_wise_sd[$site["ro"]]) && $site["no_of_sites"] != null && $site["no_of_sites"] >= 5 )
				{
					$sde = array();
					$sde["site_id"] = $sid;
					$sde["site_code"] = $site["site_code_2g"];
					$sde["priority"] = $site["site_priority"];
					$sde["start_time"] = date("d/m H:i", @strtotime($alrm_tm["alarm_raised_time"]) );
					$sde["office_code"] = null;
					if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					{
						$sde["office_code"] = $inhouse_lookup[$site["om_office_id"]]->short_code;
					}
					$ro_wise_sd[$site["ro"]]["hub_power"][] = $sde;
				}
			}
		}

		$sheet->getCell('I2')->setValue('RO wise Hub site SMS');

		$rin = 3;
		foreach ($ro_wise_sd as $ro_name => $ro_outs)
		{
			$sheet->getCell('I'.$rin)->setValue('Power alarm HUB Site- '.$ro_name.' at '.$selhs.' -'.sizeof($ro_outs["hub_power"]) );
			$rin++;

			$col_data = "";
			foreach ($ro_outs["hub_power"] as $power_down)
			{
				$col_data .= $power_down["site_code"];
				$col_data .= " (".$power_down["priority"].")";
				$col_data .= " ".$power_down["start_time"];
				$col_data .= "-".$power_down["office_code"];
				$col_data .= "\n";
			}
			$sheet->getCell('I'.$rin)->setValue($col_data);
			$rin++;
			$rin++;
		}

		$sheet->getStyle('B2:I2')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('B2:I2')->applyFromArray($ha_style);

	    $border_style = array(
			'borders' => array(
				'allborders' => array(
					'style' => PHPExcel_Style_Border::BORDER_THIN,
				)
			)
		);

	    $sheet->getCell('L2')->setValue('DG 2G Sites Down at '.$selhs);
		$sheet->mergeCells('L2:S2');

		$sheet->getCell('L3')->setValue('Sitecode');
		$sheet->getCell('M3')->setValue('Priority');
		$sheet->getCell('N3')->setValue('Office');
		$sheet->getCell('O3')->setValue('RO');
		$sheet->getCell('P3')->setValue('Appear Time');
		$sheet->getCell('Q3')->setValue('Effect');
		$sheet->getCell('R3')->setValue('Power Status');
		$sheet->getCell('S3')->setValue('PowerAlarmStatus');

		$sheet->getStyle('L2:S3')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('L2:S3')->applyFromArray($ha_style);

		$rin = 4;
		foreach ($sel_hours_stats["site_2go_ids"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if ( $site["power_status"] != null && ( @strpos(@strtolower($site["power_status"]), 'dg') !== false || @strpos(@strtolower($site["power_status"]), 'generator') !== false ) )
				{
					$sheet->getCell('L'.$rin)->setValue( $site["site_code_2g"] );
					$sheet->getCell('M'.$rin)->setValue( $site["site_priority"] );

					if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					{
						$sheet->getCell('N'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
					}
					else
					{
						$sheet->getCell('N'.$rin)->setValue('');
					}
					
					$sheet->getCell('O'.$rin)->setValue( $site["ro"] );
					$sheet->getCell('P'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($outage_tm)) ) );
					$sheet->getStyle('P'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

					if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
					    $sheet->getCell('Q'.$rin)->setValue( "Site Down" );
					else
						$sheet->getCell('Q'.$rin)->setValue( "Micro BTS Down" );

					
					$sheet->getCell('R'.$rin)->setValue($site["power_status"]);

					$power_slogans = array();
					if( isset($sel_hours_stats["power_sites"][$sid]) )
					{
						$power_slogans [] = $sel_hours_stats["power_sites"][$sid]["slogan"];
					}

					if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
					{
						$power_slogans [] = $sel_hours_stats["lowvoltage_sites"][$sid]["slogan"];
					}

					$sheet->getCell('S'.$rin)->setValue(implode(" / ", $power_slogans));
					$rin++;
				}
			}
		}
		$sheet->getStyle("L2:S".($rin-1))->applyFromArray($border_style);


	    $g4h_sds = array();
	    $g4h_cds = array();
	    for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";
			foreach (${$tvrname} as $sid => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];
					if( $site_outs["site"] != null )
					{
						$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);
						if( $dif > (4*60*60) )
						{
							$sde = array();
							$sde["site_id"] = $sid;
							$sde["site_code"] = $site["site_code_".$i."g"];
							$sde["technology"] = $i."G";
							$sde["priority"] = $site["site_priority"];
							$sde["appear_time"] = $site_outs["site"]["start_time"];
							$sde["duration_sec"] = $dif;
							$sde["duration_hm"] = round($dif/(60*60), 2);
							$sde["office"] = null;
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
							}
							$sde["ro"] = $site["ro"];

							if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
							    $sde["effect"] = "Site Down";
							else
								$sde["effect"] = "Micro BTS Down";

							$g4h_sds [] = $sde;
						}
					}
					else if ( sizeof($site_outs["cells"]) > 0 )
					{
						foreach ($site_outs["cells"] as $cell_name => $cell_out)
						{
							$dif = @strtotime($sel_ts) - @strtotime($cell_out["start_time"]);
							if( $dif > (4*60*60) )
							{
								$sde = array();
								$sde["site_id"] = $sid;
								$sde["site_code"] = $site["site_code_".$i."g"];
								$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
								$sde["technology"] = $i."G";
								$sde["priority"] = $site["site_priority"];
								$sde["appear_time"] = $cell_out["start_time"];
								$sde["duration_sec"] = $dif;
								$sde["duration_hm"] = round($dif/(60*60), 2);
								$sde["office"] = null;
								if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
								{
									$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
								}
								$sde["ro"] = $site["ro"];
								$sde["effect"] = "1 Cell (".$cell_name.") Down";

								$g4h_cds [] = $sde;
							}
						}
					}
				}
			}
		}

		usort($g4h_sds, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

		usort($g4h_cds, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

		$sheet->getCell('V2')->setValue('>4Hours Sites Down at '.$selhs);
		$sheet->mergeCells('V2:AC2');

		$sheet->getCell('V3')->setValue('Sitecode');
		$sheet->getCell('W3')->setValue('Technology');
		$sheet->getCell('X3')->setValue('Priority');
		$sheet->getCell('Y3')->setValue('Office');
		$sheet->getCell('Z3')->setValue('RO');
		$sheet->getCell('AA3')->setValue('Appear Time');
		$sheet->getCell('AB3')->setValue('Duration (Hrs)');
		$sheet->getCell('AC3')->setValue('Effect');

		$sheet->getStyle('V2:AC3')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('V2:AC3')->applyFromArray($ha_style);

	    $rin = 4;
	    foreach ($g4h_sds as $sd)
	    {
	    	$sheet->getCell('V'.$rin)->setValue( $sd["site_code"] );
			$sheet->getCell('W'.$rin)->setValue( $sd["technology"] );
			$sheet->getCell('X'.$rin)->setValue( $sd["priority"] );
			$sheet->getCell('Y'.$rin)->setValue( $sd["office"] );
			$sheet->getCell('Z'.$rin)->setValue( $sd["ro"] );
			$sheet->getCell('AA'.$rin)->setValue( $sd["appear_time"] );

			$sheet->getCell('AA'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) ) );
			$sheet->getStyle('AA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

			$sheet->getCell('AB'.$rin)->setValue( $sd["duration_hm"] );
			$sheet->getCell('AC'.$rin)->setValue( $sd["effect"] );
			$rin++;
	    }
	    $sheet->getStyle("V2:AC".($rin-1))->applyFromArray($border_style);

	    $sheet->getCell('AE2')->setValue('>4Hours Cells Down at '.$selhs);
		$sheet->mergeCells('AE2:AL2');

		$sheet->getCell('AE3')->setValue('Cell ID');
		$sheet->getCell('AF3')->setValue('Technology');
		$sheet->getCell('AG3')->setValue('Priority');
		$sheet->getCell('AH3')->setValue('Office');
		$sheet->getCell('AI3')->setValue('RO');
		$sheet->getCell('AJ3')->setValue('Appear Time');
		$sheet->getCell('AK3')->setValue('Duration (Hrs)');
		$sheet->getCell('AL3')->setValue('Effect');

		$sheet->getStyle('AE2:AL3')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AE2:AL3')->applyFromArray($ha_style);

	    $rin = 4;
	    foreach ($g4h_cds as $sd)
	    {
	    	$sheet->getCell('AE'.$rin)->setValue( $sd["cell_code"] );
			$sheet->getCell('AF'.$rin)->setValue( $sd["technology"] );
			$sheet->getCell('AG'.$rin)->setValue( $sd["priority"] );
			$sheet->getCell('AH'.$rin)->setValue( $sd["office"] );
			$sheet->getCell('AI'.$rin)->setValue( $sd["ro"] );

			$sheet->getCell('AJ'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) ) );
			$sheet->getStyle('AJ'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

			$sheet->getCell('AK'.$rin)->setValue( $sd["duration_hm"] );
			$sheet->getCell('AL'.$rin)->setValue( $sd["effect"] );
			$rin++;
	    }
	    $sheet->getStyle("AE2:AL".($rin-1))->applyFromArray($border_style);

	    $solar_down_sites = array();

	    foreach ($sel_hours_stats["power_sites"] as $sid => $outage_tm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];

				if ( $site["power_status"] != null && $site["power_status"] == 'Rented solar power' )
				{
					$sde = array();
					$sde["site_id"] = $sid;
					$sde["site_code"] = $site["site_code_2g"];
					$sde["office"] = null;
					if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					{
						$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
					}
					$sde["ro"] = $site["ro"];
					$sde["power_alarm"] = $outage_tm["alarm_raised_time"];

					$sde["site_down_2g"] = null;
					if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
					{
						$sde["site_down_2g"] = $sel_hours_stats["site_2go_ids"][$sid];
					}

					$sde["low_voltage"] = null;
					if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
					{
						$sde["low_voltage"] = $sel_hours_stats["lowvoltage_sites"][$sid]["alarm_raised_time"];
					}

					$solar_down_sites [] = $sde;
				}
			}
		}



	    $sheet->getCell('AN2')->setValue('Solar sites Down at '.$selhs);
		$sheet->mergeCells('AN2:AS2');

		$sheet->getCell('AN3')->setValue('Solar Sites');
		$sheet->getCell('AO3')->setValue('Office');
		$sheet->getCell('AP3')->setValue('RO');
		$sheet->getCell('AQ3')->setValue('PowerAlarm');
		$sheet->getCell('AR3')->setValue('LowVoltage');
		$sheet->getCell('AS3')->setValue('2G SiteDown');

		$sheet->getStyle('AN2:AS3')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AN2:AS3')->applyFromArray($ha_style);

	    $rin = 4;
	    foreach ($solar_down_sites as $sls)
	    {
	    	$sheet->getCell('AN'.$rin)->setValue( $sls["site_code"] );
			$sheet->getCell('AO'.$rin)->setValue( $sls["office"] );
			$sheet->getCell('AP'.$rin)->setValue( $sls["ro"] );
			$sheet->getCell('AQ'.$rin)->setValue( $sls["power_alarm"] );

			$sheet->getCell('AQ'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["power_alarm"])) ) );
			$sheet->getStyle('AQ'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");

			if( $sls["low_voltage"] != null )
			{
				$sheet->getCell('AR'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["low_voltage"])) ) );
				$sheet->getStyle('AR'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");
			}

			if( $sls["site_down_2g"] != null )
			{
				$sheet->getCell('AS'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sls["site_down_2g"])) ) );
				$sheet->getStyle('AS'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm");
			}
			$rin++;
	    }
	    $sheet->getStyle("AN2:AS".($rin-1))->applyFromArray($border_style);

	    $g8cs = array();
	    $g8s2gs = array();
	    $g8s3gs = array();
	    $g8s4gs = array();
	    for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";
			foreach (${$tvrname} as $sid => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];
					if( $site_outs["site"] != null )
					{
						$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);
						if( $dif > (8*60*60) )
						{
							$sde = array();
							$sde["site_id"] = $sid;
							$sde["site_code"] = $site["site_code_".$i."g"];
							$sde["technology"] = $i."G";
							$sde["priority"] = $site["site_priority"];
							$sde["appear_time"] = $site_outs["site"]["start_time"];
							$sde["duration_sec"] = $dif;
							$sde["duration_hm"] = round($dif/(60*60), 2);
							$sde["office"] = null;
							if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							{
								$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
							}
							$sde["ro"] = $site["ro"];

							if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
							    $sde["effect"] = "Site Down";
							else
								$sde["effect"] = "Micro BTS Down";

							${"g8s".$i."gs"} [] = $sde;
						}
					}
					else if ( sizeof($site_outs["cells"]) > 0 )
					{
						foreach ($site_outs["cells"] as $cell_name => $cell_out)
						{
							$dif = @strtotime($sel_ts) - @strtotime($cell_out["start_time"]);
							if( $dif > (8*60*60) )
							{
								$sde = array();
								$sde["site_id"] = $sid;
								$sde["site_code"] = $site["site_code_".$i."g"];
								$sde["cell_code"] = $site["site_code_".$i."g"].'_'.$this->atonumlookup($cell_name);
								$sde["technology"] = $i."G";
								$sde["priority"] = $site["site_priority"];
								$sde["appear_time"] = $cell_out["start_time"];
								$sde["duration_sec"] = $dif;
								$sde["duration_hm"] = round($dif/(60*60), 2);
								$sde["office"] = null;
								if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
								{
									$sde["office"] = $inhouse_lookup[$site["om_office_id"]]->name;
								}
								$sde["ro"] = $site["ro"];
								$sde["effect"] = "1 Cell (".$cell_name.") Down";

								$g8cs [] = $sde;
							}
						}
					}
				}
			}
		}

		usort($g8s2gs, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

		usort($g8s3gs, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

		usort($g8s4gs, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

		usort($g8cs, function($a, $b)
		{
			if($a['duration_sec']==$b['duration_sec']) return 0;
			return $a['duration_sec'] < $b['duration_sec']?1:-1;
		});

	    $sheet->getCell('AW2')->setValue('Update for More than 08 hrs Down Site');
		$sheet->mergeCells('AW2:BE2');
		$sheet->getStyle("AW2:BE2")->applyFromArray($border_style);

		$rin = 3;
		$last_rin = 3;
	    $sheet->getCell('AW'.$rin)->setValue('2G');
	    $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	    $rin++;
	    $last_rin = $rin;
		$sheet->getCell('AW'.$rin)->setValue('Sitecode');
		$sheet->getCell('AX'.$rin)->setValue('Priority');
		$sheet->getCell('AY'.$rin)->setValue('Office');
		$sheet->getCell('AZ'.$rin)->setValue('RO');
		$sheet->getCell('BA'.$rin)->setValue('Appear Date');
		$sheet->getCell('BB'.$rin)->setValue('Appear Time');
		$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
		$sheet->getCell('BD'.$rin)->setValue('Effect');
		$sheet->getCell('BE'.$rin)->setValue('Reason');

		$sheet->getStyle('AW'.($rin-2).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AW'.($rin-3).':BE'.$rin)->applyFromArray($ha_style);

	    $rin++;
	    if( sizeof($g8s2gs) > 0 )
	    {
		    foreach ($g8s2gs as $sd)
		    {
		    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
				$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
				$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
				$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
				$sheet->getCell('BA'.$rin)->setValue( $extime );
				$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
				$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
				$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
				$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
				$sheet->getCell('BE'.$rin)->setValue( '' );
				$rin++;
		    }
	    }
	    else
	    {
	    	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	    	$rin++;
	    }
	    $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	    $rin++;
	    $sheet->getCell('AW'.$rin)->setValue('3G');
	    $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	    $rin++;
	    $last_rin = $rin;
		$sheet->getCell('AW'.$rin)->setValue('Sitecode');
		$sheet->getCell('AX'.$rin)->setValue('Priority');
		$sheet->getCell('AY'.$rin)->setValue('Office');
		$sheet->getCell('AZ'.$rin)->setValue('RO');
		$sheet->getCell('BA'.$rin)->setValue('Appear Date');
		$sheet->getCell('BB'.$rin)->setValue('Appear Time');
		$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
		$sheet->getCell('BD'.$rin)->setValue('Effect');
		$sheet->getCell('BE'.$rin)->setValue('Reason');

		$sheet->getStyle('AW'.($rin-1).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AW'.($rin-1).':BE'.$rin)->applyFromArray($ha_style);

	    $rin++;
	    if( sizeof($g8s3gs) > 0 )
	    {
			foreach ($g8s3gs as $sd)
		    {
		    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
				$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
				$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
				$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
				$sheet->getCell('BA'.$rin)->setValue( $extime );
				$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
				$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
				$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
				$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
				$sheet->getCell('BE'.$rin)->setValue( '' );
				$rin++;
		    }
	    }
	    else
	    {
	    	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	    	$rin++;
	    }
	    $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	    $rin++;
	    $sheet->getCell('AW'.$rin)->setValue('4G');
	    $sheet->getStyle('AW'.$rin)->applyFromArray($border_style);
	    $rin++;
	    $last_rin = $rin;
		$sheet->getCell('AW'.$rin)->setValue('Sitecode');
		$sheet->getCell('AX'.$rin)->setValue('Priority');
		$sheet->getCell('AY'.$rin)->setValue('Office');
		$sheet->getCell('AZ'.$rin)->setValue('RO');
		$sheet->getCell('BA'.$rin)->setValue('Appear Date');
		$sheet->getCell('BB'.$rin)->setValue('Appear Time');
		$sheet->getCell('BC'.$rin)->setValue('Duration (Hrs)');
		$sheet->getCell('BD'.$rin)->setValue('Effect');
		$sheet->getCell('BE'.$rin)->setValue('Reason');

		$sheet->getStyle('AW'.($rin-1).':BE'.$rin)->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AW'.($rin-1).':BE'.$rin)->applyFromArray($ha_style);

	    $rin++;
	    if( sizeof($g8s4gs) > 0 )
	    {
			foreach ($g8s4gs as $sd)
		    {
		    	$sheet->getCell('AW'.$rin)->setValue( $sd["site_code"] );
				$sheet->getCell('AX'.$rin)->setValue( $sd["priority"] );
				$sheet->getCell('AY'.$rin)->setValue( $sd["office"] );
				$sheet->getCell('AZ'.$rin)->setValue( $sd["ro"] );
				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
				$sheet->getCell('BA'.$rin)->setValue( $extime );
				$sheet->getStyle('BA'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
				$sheet->getCell('BB'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
				$sheet->getCell('BC'.$rin)->setValue( $sd["duration_hm"] );
				$sheet->getCell('BD'.$rin)->setValue( $sd["effect"] );
				$sheet->getCell('BE'.$rin)->setValue( '' );
				$rin++;
		    }
		}
	    else
	    {
	    	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	    	$rin++;
	    }
	    $sheet->getStyle("AW".$last_rin.":BE".($rin-1))->applyFromArray($border_style);

	    $rin++;
	    $last_rin = $rin;
	    $sheet->getCell('AW'.$rin)->setValue('Update for More than 08 hrs Cell Down');
	    $sheet->mergeCells('AW'.$rin.':BF'.$rin);
	    $rin++;
		$sheet->getCell('AW'.$rin)->setValue('Sitecode');
		$sheet->getCell('AX'.$rin)->setValue('Technology');
		$sheet->getCell('AY'.$rin)->setValue('Priority');
		$sheet->getCell('AZ'.$rin)->setValue('Office');
		$sheet->getCell('BA'.$rin)->setValue('RO');
		$sheet->getCell('BB'.$rin)->setValue('Appear Date');
		$sheet->getCell('BC'.$rin)->setValue('Appear Time');
		$sheet->getCell('BD'.$rin)->setValue('Duration (Hrs)');
		$sheet->getCell('BE'.$rin)->setValue('Effect');
		$sheet->getCell('BF'.$rin)->setValue('Reason');

		$sheet->getStyle('AW'.($rin-1).':BF'.$rin)->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('AW'.($rin-1).':BF'.$rin)->applyFromArray($ha_style);

	    $rin++;
	    if( sizeof($g8cs) > 0 )
	    {
			foreach ($g8cs as $sd)
		    {
		    	$sheet->getCell('AW'.$rin)->setValue( $sd["cell_code"] );
				$sheet->getCell('AX'.$rin)->setValue( $sd["technology"] );
				$sheet->getCell('AY'.$rin)->setValue( $sd["priority"] );
				$sheet->getCell('AZ'.$rin)->setValue( $sd["office"] );
				$sheet->getCell('BA'.$rin)->setValue( $sd["ro"] );
				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($sd["appear_time"])) );
				$sheet->getCell('BB'.$rin)->setValue( $extime );
				$sheet->getStyle('BB'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");
				$sheet->getCell('BC'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('BC'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');
				$sheet->getCell('BD'.$rin)->setValue( $sd["duration_hm"] );
				$sheet->getCell('BE'.$rin)->setValue( $sd["effect"] );
				$sheet->getCell('BF'.$rin)->setValue( '' );
				$rin++;
		    }
	    }
	    else
	    {
	    	$sheet->getCell('AW'.$rin)->setValue( 'None' );
	    	$rin++;
	    }
	    $sheet->getStyle("AW".$last_rin.":BF".($rin-1))->applyFromArray($border_style);



	    // already in ascending sorted order so no need
	    $ocells_down = array();
	    for ($i=2; $i <= 4; $i++)
		{
			$tvrname = "sw_".$i."g_out";

			$sheet = $phpExcel->createSheet($shind);
			$sheet->setTitle($i."G_Down");
			$shind++;

			$sheet->getCell('A1')->setValue('SL');
			$sheet->getCell('B1')->setValue('UniqueSitecode');
			$sheet->getCell('C1')->setValue('Sitecode');
			$sheet->getCell('D1')->setValue('Priority');
			$sheet->getCell('E1')->setValue('Office');
			$sheet->getCell('F1')->setValue('MSD Office');
			$sheet->getCell('G1')->setValue('District');
			$sheet->getCell('H1')->setValue('Thana');
			$sheet->getCell('I1')->setValue('Area');
			$sheet->getCell('J1')->setValue('RO');
			$sheet->getCell('K1')->setValue('Appear Date');
			$sheet->getCell('L1')->setValue('Appear Time');
			$sheet->getCell('M1')->setValue('Duration (Hrs)');
			$sheet->getCell('N1')->setValue('Address');
			$sheet->getCell('O1')->setValue('Effect');
			$sheet->getCell('P1')->setValue('Alarm');
			$sheet->getCell('Q1')->setValue('BTS Type');
			$sheet->getCell('R1')->setValue('Share Operator');
			$sheet->getCell('S1')->setValue('Sharing Type');
			$sheet->getCell('T1')->setValue('NTTN info/Minihuub');
			$sheet->getCell('U1')->setValue('Power Status');
			$sheet->getCell('V1')->setValue('PowerAlarmStatus');

			if( $i==2 )
				$sheet->getCell('W1')->setValue('Common with 3G');
			else if( $i==3 )
				$sheet->getCell('W1')->setValue('Common with 2G');
			if( $i==4 )
				$sheet->getCell('W1')->setValue('Common with 3G');

			$sheet->getStyle('A1:W1')->getFont()->setBold(true)->setSize(12);
		    $sheet->getStyle('A1:W1')->applyFromArray($ha_style);

		    $rin = 2;
			foreach (${$tvrname} as $sid => $site_outs)
			{
				if( isset($site_mem_resp->site_list[$sid]) )
				{
					$site = $site_mem_resp->site_list[$sid];
					if( $site_outs["site"] != null )
					{
						$sheet->getCell('A'.$rin)->setValue($rin-1);
						$sheet->getCell('B'.$rin)->setValue($site["generic_id"]);
						$sheet->getCell('C'.$rin)->setValue($site["site_code_".$i."g"]);
						$sheet->getCell('D'.$rin)->setValue($site["site_priority"]);

						if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
							$sheet->getCell('E'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
						else
							$sheet->getCell('E'.$rin)->setValue('');

						if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
							$sheet->getCell('F'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
						else
							$sheet->getCell('F'.$rin)->setValue('');

						$sheet->getCell('G'.$rin)->setValue($site["district"]);
						$sheet->getCell('H'.$rin)->setValue($site["thana"]);
						$sheet->getCell('I'.$rin)->setValue($site["zone"]);
						$sheet->getCell('J'.$rin)->setValue($site["ro"]);

						$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($site_outs["site"]["start_time"])) );
						$sheet->getCell('K'.$rin)->setValue( $extime );
						$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

						$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
						$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

						$dif = @strtotime($sel_ts) - @strtotime($site_outs["site"]["start_time"]);

						$sheet->getCell('M'.$rin)->setValue( round($dif/(60*60), 2) );
						$sheet->getCell('N'.$rin)->setValue($site["address"]);

						if ( @strpos(@strtolower($site["bts_type"]), 'macro') !== false )
						    $sheet->getCell('O'.$rin)->setValue("Site Down");
						else
							$sheet->getCell('O'.$rin)->setValue("Micro BTS Down");

						$sheet->getCell('P'.$rin)->setValue($site_outs["site"]["slogan"]);
						$sheet->getCell('Q'.$rin)->setValue($site["bts_type"]);
						$sheet->getCell('R'.$rin)->setValue($site["shared_operator"]);
						$sheet->getCell('S'.$rin)->setValue($site["sharing_type"]);
						$sheet->getCell('T'.$rin)->setValue( implode(" / ", array($site["service_type"], $site["mini_hub"]) ));
						$sheet->getCell('U'.$rin)->setValue($site["power_status"]);

						$power_slogans = array();
						if( isset($sel_hours_stats["power_sites"][$sid]) )
						{
							$power_slogans [] = $sel_hours_stats["power_sites"][$sid]["slogan"];
						}

						if( isset($sel_hours_stats["lowvoltage_sites"][$sid]) )
						{
							$power_slogans [] = $sel_hours_stats["lowvoltage_sites"][$sid]["slogan"];
						}

						$sheet->getCell('V'.$rin)->setValue( implode(" / ", $power_slogans) );

						if( $i==2 )
						{
							if( isset($sel_hours_stats["site_3go_ids"][$sid]) )
							{
								$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
							}
						}
						else if( $i==3 )
						{
							if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
							{
								$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
							}
						}
						if( $i==4 )
						{
							if( isset($sel_hours_stats["site_3go_ids"][$sid]) )
							{
								$sheet->getCell('W'.$rin)->setValue($site["generic_id"]);
							}
						}
						$rin++;
					}
					else if ( sizeof($site_outs["cells"]) > 0 )
					{
						foreach ($site_outs["cells"] as $cell_name => $cell_out)
						{
							$ocells_down [] = $cell_out;
						}
					}
				}
			}
		}


		$sheet = $phpExcel->createSheet($shind);
		$sheet->setTitle("CellsDown");
		$shind++;

		$sheet->getCell('A1')->setValue('SL');
		$sheet->getCell('B1')->setValue('Cell ID');
		$sheet->getCell('C1')->setValue('Technology');
		$sheet->getCell('D1')->setValue('Priority');
		$sheet->getCell('E1')->setValue('Office');
		$sheet->getCell('F1')->setValue('District');
		$sheet->getCell('G1')->setValue('Thana');
		$sheet->getCell('H1')->setValue('MSD Office');
		$sheet->getCell('I1')->setValue('Zone');
		$sheet->getCell('J1')->setValue('RO');
		$sheet->getCell('K1')->setValue('Appear Date');
		$sheet->getCell('L1')->setValue('Appear Time');
		$sheet->getCell('M1')->setValue('Duration (Hrs)');
		$sheet->getCell('N1')->setValue('Alarm');
		$sheet->getCell('O1')->setValue('Effect');

		$sheet->getStyle('A1:O1')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('A1:O1')->applyFromArray($ha_style);

		$rin = 2;
		foreach ($ocells_down as $cell_down)
		{
			if( isset($site_mem_resp->site_list[$cell_down["site_id"]]) )
			{
				$site = $site_mem_resp->site_list[$cell_down["site_id"]];

				$site_code = null;
				if( $cell_down["technology"] == "2G" ) $site_code = $site["site_code_2g"];
				else if( $cell_down["technology"] == "3G" ) $site_code = $site["site_code_3g"];
				else if( $cell_down["technology"] == "4G" ) $site_code = $site["site_code_4g"];

				if( $site_code != null ) $site_code = $cell_down["site_code"];

				$sheet->getCell('A'.$rin)->setValue($rin-1);
				$sheet->getCell('B'.$rin)->setValue($site_code.'_'.$this->atonumlookup($cell_down["cell_name"]));
				$sheet->getCell('C'.$rin)->setValue($cell_down["technology"]);
				$sheet->getCell('D'.$rin)->setValue($site["site_priority"]);

				if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					$sheet->getCell('E'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
				else
					$sheet->getCell('E'.$rin)->setValue('');

				$sheet->getCell('F'.$rin)->setValue($site["district"]);
				$sheet->getCell('G'.$rin)->setValue($site["thana"]);

				if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
					$sheet->getCell('H'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
				else
					$sheet->getCell('H'.$rin)->setValue('');

				$sheet->getCell('I'.$rin)->setValue($site["zone"]);
				$sheet->getCell('J'.$rin)->setValue($site["ro"]);

				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($cell_down["start_time"])) );
				$sheet->getCell('K'.$rin)->setValue( $extime );
				$sheet->getStyle('K'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

				$sheet->getCell('L'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('L'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

				$dif = @strtotime($sel_ts) - @strtotime($cell_down["start_time"]);

				$sheet->getCell('M'.$rin)->setValue( round($dif/(60*60), 2) );
				$sheet->getCell('N'.$rin)->setValue($cell_down["slogan"]);
				$sheet->getCell('O'.$rin)->setValue("1 Cell (".$cell_down["cell_name"].") Down");

				$rin++;
			}
		}


		$sheet = $phpExcel->createSheet($shind);
		$sheet->setTitle("PowerAlarm");
		$shind++;

		$sheet->getCell('A1')->setValue('BSC');
		$sheet->getCell('B1')->setValue('Sitecode');
		$sheet->getCell('C1')->setValue('Unique Sites');
		$sheet->getCell('D1')->setValue('Technology');
		$sheet->getCell('E1')->setValue('Priority');
		$sheet->getCell('F1')->setValue('Office');
		$sheet->getCell('G1')->setValue('MSD Office');
		$sheet->getCell('H1')->setValue('District');
		$sheet->getCell('I1')->setValue('Thana');
		$sheet->getCell('J1')->setValue('Zone');
		$sheet->getCell('K1')->setValue('RO');
		$sheet->getCell('L1')->setValue('Commercial Zone');
		$sheet->getCell('M1')->setValue('Address');
		$sheet->getCell('N1')->setValue('Appear Date');
		$sheet->getCell('O1')->setValue('Appear Time');
		$sheet->getCell('P1')->setValue('Duration (Hrs)');
		$sheet->getCell('Q1')->setValue('Severity');
		$sheet->getCell('R1')->setValue('Alarm');
		$sheet->getCell('S1')->setValue('Specific');
		$sheet->getCell('T1')->setValue('Additional');
		$sheet->getCell('U1')->setValue('Power Status');
		$sheet->getCell('V1')->setValue('HUB(connected sites)');
		$sheet->getCell('W1')->setValue('SiteDown Time');

		$sheet->getStyle('A1:W1')->getFont()->setBold(true)->setSize(12);
	    $sheet->getStyle('A1:W1')->applyFromArray($ha_style);

	    $rin = 2;
	    foreach ($sel_hours_stats["power_sites"] as $sid => $palarm)
		{
			if( isset($site_mem_resp->site_list[$sid]) )
			{
				$site = $site_mem_resp->site_list[$sid];
				$bsc_rnc = "N/A";
				$technology = "N/A";
				if( $palarm["sname"] == $site["site_code_2g"] )
				{
					$bsc_rnc = $site["bsc_2g"];
					$technology = "2G";
				}
				else if( $palarm["sname"] == $site["site_code_3g"] )
				{
					$bsc_rnc = $site["rnc_3g"];
					$technology = "3G";
				}
				else if( $palarm["sname"] == $site["site_code_4g"] )
				{
					$technology = "4G";
				}

				$bscs [] = $bsc_rnc;

				// $sheet->getCell('A'.$rin)->setValue($bsc_rnc);
				// BSC/RNC contains formulas.
				$sheet->setCellValueExplicit('A'.$rin, $bsc_rnc);

				$sheet->getCell('B'.$rin)->setValue($palarm["sname"]);
				$sheet->getCell('C'.$rin)->setValue($site["generic_id"]);
				$sheet->getCell('D'.$rin)->setValue($technology);
				$sheet->getCell('E'.$rin)->setValue($site["site_priority"]);

				if( $site["om_office_id"] != null && isset($inhouse_lookup[$site["om_office_id"]]) )
					$sheet->getCell('F'.$rin)->setValue($inhouse_lookup[$site["om_office_id"]]->name);
				else
					$sheet->getCell('F'.$rin)->setValue('');

				if( $site["msd_office_id"] != null && isset($msd_lookup[$site["msd_office_id"]]) )
					$sheet->getCell('G'.$rin)->setValue($msd_lookup[$site["msd_office_id"]]->name);
				else
					$sheet->getCell('G'.$rin)->setValue('');

				$sheet->getCell('H'.$rin)->setValue($site["district"]);
				$sheet->getCell('I'.$rin)->setValue($site["thana"]);
				$sheet->getCell('J'.$rin)->setValue($site["zone"]);
				$sheet->getCell('K'.$rin)->setValue($site["ro"]);
				$sheet->getCell('L'.$rin)->setValue($site["commercial_zone"]);
				$sheet->getCell('M'.$rin)->setValue($site["address"]);


				$extime = PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($palarm["alarm_raised_time"])) );
				$sheet->getCell('N'.$rin)->setValue( $extime );
				$sheet->getStyle('N'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy");

				$sheet->getCell('O'.$rin)->setValue( $extime - floor($extime) );
				$sheet->getStyle('O'.$rin)->getNumberFormat()->setFormatCode('[h]:mm:ss;@');

				$dif = @strtotime($sel_ts) - @strtotime($palarm["alarm_raised_time"]);

				$sheet->getCell('P'.$rin)->setValue( round($dif/(60*60), 2) );
				$sheet->getCell('Q'.$rin)->setValue( $palarm["perceived_severity"] );
				$sheet->getCell('R'.$rin)->setValue( $palarm["slogan"] );
				$sheet->getCell('S'.$rin)->setValue('');
				$sheet->getCell('T'.$rin)->setValue('');
				$sheet->getCell('U'.$rin)->setValue($site["power_status"]);
				$sheet->getCell('V'.$rin)->setValue($site["no_of_sites"]);

				if( isset($sel_hours_stats["site_2go_ids"][$sid]) )
				{
					$sheet->getCell('W'.$rin)->setValue( PHPExcel_Shared_Date::PHPToExcel( date("d/m/Y H:i:s", @strtotime($palarm["alarm_raised_time"])) ) );
					$sheet->getStyle('W'.$rin)->getNumberFormat()->setFormatCode("dd-mmm-yy h:mm:ss");
				}
				$rin++;
			}
		}

		$phpExcel->setActiveSheetIndex(0);

       	$filename = "hourly_sms_" . date("Y-m-d @ H:i", @strtotime($sel_ts)) . ".xlsx";

	    header('Content-Type: application/vnd.ms-excel');
	    header('Content-Disposition: attachment;filename="'.$filename.'"');
	    header('Cache-Control: max-age=0');
	    $writer->setPreCalculateFormulas();
	    $writer->save('php://output');
	    exit();
	}

	public function time_to_decimal($time)
	{
	    $timeArr = explode(':', $time);
	    $decTime = ($timeArr[0]) + ($timeArr[1]/60) + ($timeArr[2]/3600);
	 
	    return $decTime;
	}

	public function atonumlookup($cell_name)
	{
		$lkp = array(
			'A'=>1,
			'B'=>2,
			'C'=>3,
			'D'=>4,
			'E'=>5,
			'F'=>6,
			'G'=>7,
			'H'=>8,
			'I'=>9,
			'J'=>10,
			'K'=>11,
			'L'=>12,
			'M'=>13,
			'N'=>14,
			'O'=>15,
			'P'=>16,
			'Q'=>17,
			'R'=>18,
			'S'=>19,
			'T'=>20,
			'U'=>21,
			'V'=>22,
			'W'=>23,
			'X'=>24,
			'Y'=>25,
			'Z'=>26,
		);

		if( isset($lkp[$cell_name]) )
			return $lkp[$cell_name];
		else
			return $cell_name;
	}

	public function get_affected_at_hour($actpowers, $logpowers, $outages, $attime)
	{
		$resp = array();
		$resp["power_sites"] = array();
		$resp["lowvoltage_sites"] = array();
		$resp["site_2go_ids"] = array();
		$resp["site_3go_ids"] = array();
		$resp["site_4go_ids"] = array();

		$thsts = @strtotime($attime);

		foreach ($actpowers as $pal)
		{
			if( @strtotime($pal["alarm_raised_time"]) <= $thsts )
			{
				if( $pal["slogan"] != "LOW VOLTAGE" )
				{
					if( !isset($resp["power_sites"][$pal['psid']]) )
						$resp["power_sites"] [$pal['psid']] = $pal;
				}
				else
				{
					if( !isset($resp["lowvoltage_sites"][$pal['psid']]) )
						$resp["lowvoltage_sites"] [$pal['psid']] = $pal;
				}
			}
		}

		foreach ($logpowers as $plg)
		{
			if( @strtotime($plg["alarm_raised_time"]) <= $thsts && @strtotime($plg["alarm_cleared_time_ums"]) >= $thsts )
			{
				if( $plg["slogan"] != "LOW VOLTAGE" )
				{
					if( !isset($resp["power_sites"][$plg['psid']]) )
						$resp["power_sites"] [$plg['psid']] = $plg;
				}
				else
				{
					if( !isset($resp["lowvoltage_sites"][$plg['psid']]) )
						$resp["lowvoltage_sites"] [$plg['psid']] = $plg;
				}
			}
		}

		foreach ($outages as $outage)
		{
			$onact = false;
			if( $outage["running"] )
			{
				if( @strtotime($outage["start_time"]) <= $thsts )
					$onact = true;
			}
			else
			{
				if( @strtotime($outage["start_time"]) <= $thsts && @strtotime($outage["end_time"]) >= $thsts )
					$onact = true;
			}

			if( $onact )
			{
				if( $outage["technology"] == "2G" )
				{
					if( ($outage["type"] == "site" || $outage["type"] == "site_by_cell") && !isset($resp["site_2go_ids"][$outage["site_id"]]) )
					{
						$resp["site_2go_ids"][$outage["site_id"]] = $outage["start_time"];
					}
				}
				else if( $outage["technology"] == "3G" )
				{
					if( ($outage["type"] == "site" || $outage["type"] == "site_by_cell") && !isset($resp["site_3go_ids"][$outage["site_id"]]) )
					{
						$resp["site_3go_ids"][$outage["site_id"]] = $outage["start_time"];
					}
				}
				else if( $outage["technology"] == "4G" )
				{
					if( ($outage["type"] == "site" || $outage["type"] == "site_by_cell") && !isset($resp["site_4go_ids"][$outage["site_id"]]) )
					{
						$resp["site_4go_ids"][$outage["site_id"]] = $outage["start_time"];
					}
				}
			}
		}

		return $resp;
	}
}
